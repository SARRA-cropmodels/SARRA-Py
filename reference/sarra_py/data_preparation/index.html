<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Data Preparation - SARRA-Py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Data Preparation";
        var mkdocs_page_input_path = "reference/sarra_py/data_preparation.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SARRA-Py
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../docs/model_formalisms/">Model formalisms</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../docs/spatialization_strategy/">Spatialization strategy</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../docs/tutorial/00_-_Running_a_simulation/">00 - Running a simulation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Sarra Py</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../bilan_carbo/">Bilan Carbo</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bilan_hydro/">Bilan Hydro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bilan_pheno/">Bilan Pheno</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../comparison_tools_old/">Comparison Tools Old</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Data Preparation</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#functions">Functions</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#build_rainfall_files_df">build_rainfall_files_df</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#calc_day_length">calc_day_length</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#calc_day_length_raster">calc_day_length_raster</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#get_grid_size">get_grid_size</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#initialize_default_irrigation">initialize_default_irrigation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_agera5_data">load_AgERA5_data</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_tamsat_data">load_TAMSAT_data</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_yaml_parameters">load_YAML_parameters</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_isda_soil_data">load_iSDA_soil_data</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_paramitk">load_paramITK</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_paramtypesol">load_paramTypeSol</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#load_paramvariete">load_paramVariete</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../models/">Models</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SARRA-Py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Reference &raquo;</li>
          <li>Sarra Py &raquo;</li>
      <li>Data Preparation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="module-sarra_pydata_preparation">Module sarra_py.data_preparation</h1>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">rasterio</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">astral</span>

<span class="kn">from</span> <span class="nn">astral.sun</span> <span class="kn">import</span> <span class="n">sun</span>

<span class="kn">from</span> <span class="nn">astral</span> <span class="kn">import</span> <span class="n">LocationInfo</span>

<span class="k">def</span> <span class="nf">build_rainfall_files_df</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function builds a dataframe containing the list of rainfall files</span>

<span class="sd">    from the provided path, and the given date_start and duration.</span>

<span class="sd">    Helper function used in get_grid_size() and load_TAMSAT_data().</span>

<span class="sd">    Args:</span>

<span class="sd">        rainfall_path (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rainfall_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>

    <span class="n">rainfall_files_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">rainfall_files</span><span class="p">})</span>

    <span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rainfall_files_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>

        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span>

            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span>

            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span>

            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>

        <span class="p">),</span>

        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">rainfall_files_df</span> <span class="o">=</span> <span class="n">rainfall_files_df</span><span class="p">[(</span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">date_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rainfall_files_df</span>

<span class="k">def</span> <span class="nf">get_grid_size</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the list of rainfall files corresponding to the given</span>

<span class="sd">    date_start and duration, loads the first rainfall file, and returns its grid</span>

<span class="sd">    size, as dimensions of the rainfall grid define the output resolution of the</span>

<span class="sd">    model.</span>

<span class="sd">    Args:</span>

<span class="sd">        TAMSAT_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rainfall_files_df</span> <span class="o">=</span> <span class="n">build_rainfall_files_df</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>

    <span class="c1"># checking coherence between date_start and duration and available rainfall data</span>

    <span class="k">if</span> <span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The date range may not be covered by the available rainfall data ; please check rainfall entry files.&quot;</span><span class="p">)</span>

    <span class="c1"># loading the first rainfall file to get the grid size</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="n">rainfall_files_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span>

    <span class="kp">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">grid_width</span> <span class="o">=</span> <span class="kp">array</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">grid_height</span> <span class="o">=</span> <span class="kp">array</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span>

<span class="k">def</span> <span class="nf">load_TAMSAT_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TAMSAT_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loops over the rainfall raster files, and loads them into a</span>

<span class="sd">    xarray DataArray, which is then added to the rain data dictionary. It is</span>

<span class="sd">    tailored to the TAMSAT rainfall data files, hence its name.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        TAMSAT_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TAMSAT_files_df</span> <span class="o">=</span> <span class="n">build_rainfall_files_df</span><span class="p">(</span><span class="n">TAMSAT_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>

    <span class="n">dataarray_full</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TAMSAT_files_df</span><span class="p">)):</span>

        <span class="n">dataarray</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TAMSAT_path</span><span class="p">,</span><span class="n">TAMSAT_files_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span>

        <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="kp">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial_ref&quot;</span><span class="p">])</span>

        <span class="n">dataarray</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">dataarray_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataarray_full</span><span class="p">,</span> <span class="n">dataarray</span><span class="p">],</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># try:</span>

        <span class="c1">#     dataarray_full = xr.concat([dataarray_full, dataarray],&quot;time&quot;)</span>

        <span class="c1"># except:</span>

        <span class="c1">#     dataarray_full = dataarray</span>

    <span class="n">dataarray_full</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataarray_full</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;rainfall&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">load_AgERA5_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">AgERA5_data_path</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loops over the AgERA5 raster files, and loads them into</span>

<span class="sd">    xarray DataArray, which are then added to the data dictionary.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        AgERA5_data_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># getting list of variables</span>

    <span class="n">AgERA5_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]]</span>

    <span class="c1"># building a dictionary of dataframes containing the list of files for each variable</span>

    <span class="n">AgERA5_files_df_collection</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">AgERA5_variables</span><span class="p">:</span>

        <span class="n">AgERA5_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">))</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">),</span> <span class="n">f</span><span class="p">))]</span>

        <span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">AgERA5_files</span><span class="p">})</span>

        <span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>

            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span>

                <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span>

                <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span>

                <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>

            <span class="p">),</span>

            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][(</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">date_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># building a dictionary of correspondance between AgERA5 variables and SARRA variables</span>

    <span class="n">AgERA5_SARRA_correspondance</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s1">&#39;10m_wind_speed_24_hour_mean&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

        <span class="s1">&#39;2m_temperature_24_hour_maximum&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

        <span class="s1">&#39;2m_temperature_24_hour_mean&#39;</span><span class="p">:</span><span class="s1">&#39;tpMoy&#39;</span><span class="p">,</span>

        <span class="s1">&#39;2m_temperature_24_hour_minimum&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

        <span class="s1">&#39;ET0Hargeaves&#39;</span><span class="p">:</span><span class="s1">&#39;ET0&#39;</span><span class="p">,</span>

        <span class="s1">&#39;solar_radiation_flux_daily&#39;</span><span class="p">:</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span>

        <span class="s1">&#39;vapour_pressure_24_hour_mean&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="c1"># loading the data</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">AgERA5_variables</span><span class="p">)</span> <span class="p">:</span>

        <span class="k">if</span> <span class="n">AgERA5_SARRA_correspondance</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">del</span> <span class="n">dataarray_full</span>

            <span class="k">except</span><span class="p">:</span>

                <span class="k">pass</span>

            <span class="n">dataarray_full</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="p">:</span>

                <span class="n">dataarray</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span>

                <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">nan</span><span class="p">)</span>

                <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="kp">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">])</span>

                <span class="c1"># TODO: add dataarray.attrs = {} to precise units and long_name</span>

                <span class="c1"># try:</span>

                <span class="c1">#     dataarray_full = xr.concat([dataarray_full, dataarray],&quot;time&quot;)</span>

                <span class="c1"># except:</span>

                <span class="c1">#     dataarray_full = dataarray</span>

                <span class="n">dataarray_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataarray_full</span><span class="p">,</span> <span class="n">dataarray</span><span class="p">],</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

            <span class="c1"># storing the variable in the data dictionary</span>

            <span class="n">data</span><span class="p">[</span><span class="n">AgERA5_SARRA_correspondance</span><span class="p">[</span><span class="n">variable</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataarray_full</span>

    <span class="c1"># unit conversion for solar radiation (kJ/m2 as provided by AgERA5 to MJ/m2/day)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rg&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">load_paramVariete</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">)</span> <span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the parameters of the variety from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramVariete (_type_): _description_</span>

<span class="sd">    Raises:</span>

<span class="sd">        exception: _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/variety/&#39;</span><span class="p">,</span><span class="n">file_paramVariete</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>

        <span class="n">paramVariete</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;feuilAeroBase&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.1</span> <span class="p">:</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">paramVariete</span>

<span class="k">def</span> <span class="nf">load_paramITK</span><span class="p">(</span><span class="n">file_paramITK</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the ITK parameters from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramITK (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/itk/&#39;</span><span class="p">,</span><span class="n">file_paramITK</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>

        <span class="n">paramITK</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;DateSemis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;DateSemis&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">paramITK</span>

<span class="k">def</span> <span class="nf">load_paramTypeSol</span><span class="p">(</span><span class="n">file_paramTypeSol</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the soil parameters from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramTypeSol (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/soil/&#39;</span><span class="p">,</span><span class="n">file_paramTypeSol</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>

        <span class="n">paramTypeSol</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">paramTypeSol</span>

<span class="k">def</span> <span class="nf">load_YAML_parameters</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">,</span> <span class="n">file_paramITK</span><span class="p">,</span> <span class="n">file_paramTypeSol</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the parameters from the yaml files.</span>

<span class="sd">    It is a wrapper for the three functions above.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramVariete (_type_): _description_</span>

<span class="sd">        file_paramITK (_type_): _description_</span>

<span class="sd">        file_paramTypeSol (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">paramVariete</span> <span class="o">=</span> <span class="n">load_paramVariete</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">)</span>

    <span class="n">paramITK</span> <span class="o">=</span> <span class="n">load_paramITK</span><span class="p">(</span><span class="n">file_paramITK</span><span class="p">)</span>

    <span class="n">paramTypeSol</span> <span class="o">=</span> <span class="n">load_paramTypeSol</span><span class="p">(</span><span class="n">file_paramTypeSol</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NI NON NULL&quot;</span><span class="p">)</span>

        <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txConversion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIYo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]))</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">])</span><span class="o">*</span> <span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span><span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">2.506628274631</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">paramVariete</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">,</span> <span class="n">paramTypeSol</span>

<span class="k">def</span> <span class="nf">initialize_default_irrigation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

    <span class="c1"># default irrigation scheme</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;irrigation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;irrigation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;irrigation&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">load_iSDA_soil_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads iSDA soil data and crop to the area of interest remark :</span>

<span class="sd">    it would be nice to try to modulate the percentage of runoff according to</span>

<span class="sd">    slope</span>

<span class="sd">    First, this function loads the iSDA soil data, crops it to the area of</span>

<span class="sd">    interest and resamples it to match the grid resolution. The iSDA soil class</span>

<span class="sd">    raster map obtained is passed to the xarray dataset as a new variable.</span>

<span class="sd">    For the sake of example, the file that is used here already has been</span>

<span class="sd">    downsampled at TAMSAT resolution. Its specs are available on the CIRAD</span>

<span class="sd">    Dataverse at the following adress :</span>

<span class="sd">    https://doi.org/10.1038/s41598-021-85639-y</span>

<span class="sd">    Second, a correspondance table matching the iSDA soil classes to the soil</span>

<span class="sd">    physical properties is loaded. Maps of soil physical properties are then</span>

<span class="sd">    created and added to the xarray dataset.</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load raster data</span>

    <span class="n">soil_type_file_path</span> <span class="o">=</span> <span class="s2">&quot;../data/assets/iSDA_at_TAMSAT_resolution_zeroclass_1E6.tif&quot;</span>

    <span class="n">dataarray</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">soil_type_file_path</span><span class="p">)</span>

    <span class="c1"># crop to the area of interest</span>

    <span class="n">area</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s1">&#39;burkina&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="c1">#lat,lon lat,lon</span>

        <span class="p">}</span>

    <span class="n">selected_area</span> <span class="o">=</span> <span class="s2">&quot;burkina&quot;</span>

    <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="kp">where</span><span class="p">((</span><span class="n">dataarray</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>

                            <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="c1"># resample to match the grid resolution</span>

    <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">nan</span><span class="p">)</span>

    <span class="n">dataarray</span> <span class="o">=</span> <span class="n">dataarray</span><span class="o">.</span><span class="kp">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">])</span>

    <span class="n">dataarray</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;arbitrary&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;soil_type&quot;</span><span class="p">}</span>

    <span class="c1"># add soil type identifier to the dataset</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataarray</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="c1"># conversion from 1E6 to 1E0</span>

    <span class="c1"># load correspondance table</span>

    <span class="n">path_soil_type_correspondance</span> <span class="o">=</span> <span class="s2">&quot;../data/assets/TypeSol_Moy13_HWSD.csv&quot;</span>

    <span class="n">df_soil_type_correspondance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_soil_type_correspondance</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># correspondance between soil properties naming in the csv file and in the dataset</span>

    <span class="n">soil_variables</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s2">&quot;epaisseurProf&quot;</span> <span class="p">:</span> <span class="s2">&quot;EpaisseurProf&quot;</span><span class="p">,</span>

        <span class="s2">&quot;epaisseurSurf&quot;</span> <span class="p">:</span> <span class="s2">&quot;EpaisseurSurf&quot;</span><span class="p">,</span>

        <span class="s2">&quot;stockIniProf&quot;</span> <span class="p">:</span> <span class="s2">&quot;StockIniProf&quot;</span><span class="p">,</span>

        <span class="s2">&quot;stockIniSurf&quot;</span> <span class="p">:</span> <span class="s2">&quot;StockIniSurf&quot;</span><span class="p">,</span>

        <span class="s2">&quot;seuilRuiss&quot;</span> <span class="p">:</span> <span class="s2">&quot;SeuilRuiss&quot;</span><span class="p">,</span>

        <span class="s2">&quot;pourcRuiss&quot;</span> <span class="p">:</span> <span class="s2">&quot;PourcRuiss&quot;</span><span class="p">,</span>

        <span class="s2">&quot;ru&quot;</span> <span class="p">:</span> <span class="s2">&quot;Ru&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="c1"># create maps of soil properties and add them to the dataset</span>

    <span class="k">for</span> <span class="n">soil_variable</span> <span class="ow">in</span> <span class="n">soil_variables</span> <span class="p">:</span>

        <span class="n">dict_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df_soil_type_correspondance</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">],</span> <span class="n">df_soil_type_correspondance</span><span class="p">[</span><span class="n">soil_variables</span><span class="p">[</span><span class="n">soil_variable</span><span class="p">]]))</span>

        <span class="n">dict_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">nan</span>

        <span class="n">soil_types_converted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">reshape</span><span class="p">([</span><span class="n">dict_values</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="kp">flatten</span><span class="p">()],</span> <span class="p">(</span><span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">))</span>

        <span class="n">data</span><span class="p">[</span><span class="n">soil_variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span><span class="n">soil_types_converted</span><span class="p">)</span>

        <span class="c1"># TODO: add dataarray.attrs = {} to precise units and long_name</span>

    <span class="c1"># converting pourcRuiss to decimal %</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pourcRuiss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pourcRuiss&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">calc_day_length</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function calculates the day length for a given day and latitude.</span>

<span class="sd">    Args:</span>

<span class="sd">        day (_type_): _description_</span>

<span class="sd">        lat (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># print(day, lat)</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">LocationInfo</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">longitude</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">daylight</span> <span class="o">=</span> <span class="n">astral</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">daylight</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">day</span><span class="p">)</span>

    <span class="n">dureeDuJour</span> <span class="o">=</span> <span class="p">(</span><span class="n">daylight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">daylight</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mi">3600</span>

    <span class="k">return</span> <span class="n">dureeDuJour</span>

<span class="k">def</span> <span class="nf">calc_day_length_raster</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function calculates the day length raster for a given period of time.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="n">date_start</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)]</span>

    <span class="c1"># we will first define an empty array of the same shape as the rain array</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dureeDuJour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="kp">shape</span><span class="p">))</span>

    <span class="c1"># we will apply the calc_day_length function using a for loop on the y dimension, as well as on the j dimension</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)):</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])):</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dureeDuJour&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="n">y</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">calc_day_length</span><span class="p">(</span><span class="n">date_start</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>

    <span class="c1"># optional : plot the day length raster</span>

    <span class="c1"># data[&quot;dureeDuJour&quot;][:,:,0].plot()</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

</details>
<h2 id="functions">Functions</h2>
<h3 id="build_rainfall_files_df">build_rainfall_files_df</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">build_rainfall_files_df</span><span class="p">(</span>
    <span class="n">rainfall_path</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<p>This function builds a dataframe containing the list of rainfall files</p>
<p>from the provided path, and the given date_start and duration.</p>
<p>Helper function used in get_grid_size() and load_TAMSAT_data().</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>rainfall_path</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">build_rainfall_files_df</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function builds a dataframe containing the list of rainfall files</span>

<span class="sd">    from the provided path, and the given date_start and duration.</span>

<span class="sd">    Helper function used in get_grid_size() and load_TAMSAT_data().</span>

<span class="sd">    Args:</span>

<span class="sd">        rainfall_path (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">rainfall_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">f</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">listdir</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">))]</span><span class="w"></span>

<span class="w">    </span><span class="n">rainfall_files_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">rainfall_files</span><span class="p">})</span><span class="w"></span>

<span class="w">    </span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rainfall_files_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span><span class="w"></span>

<span class="w">            </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="w"></span>

<span class="w">            </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="w"></span>

<span class="w">        </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">rainfall_files_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rainfall_files_df</span><span class="p">[(</span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">date_start</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="n">True</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rainfall_files_df</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="calc_day_length">calc_day_length</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calc_day_length</span><span class="p">(</span>
    <span class="n">day</span><span class="p">,</span>
    <span class="n">lat</span>
<span class="p">)</span>
</code></pre></div>

<p>This function calculates the day length for a given day and latitude.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>day</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>lat</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">calc_day_length</span><span class="ss">(</span><span class="nv">day</span>, <span class="nv">lat</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">calculates</span> <span class="nv">the</span> <span class="nv">day</span> <span class="nv">length</span> <span class="k">for</span> <span class="nv">a</span> <span class="nv">given</span> <span class="nv">day</span> <span class="nv">and</span> <span class="nv">latitude</span>.

    <span class="nv">Args</span>:

        <span class="nv">day</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">lat</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    # <span class="nv">print</span><span class="ss">(</span><span class="nv">day</span>, <span class="nv">lat</span><span class="ss">)</span>

    <span class="nv">coords</span> <span class="o">=</span> <span class="nv">LocationInfo</span><span class="ss">(</span><span class="nv">latitude</span><span class="o">=</span><span class="nv">float</span><span class="ss">(</span><span class="nv">lat</span><span class="ss">)</span>, <span class="nv">longitude</span><span class="o">=</span><span class="mi">0</span>.<span class="mi">0</span><span class="ss">)</span>

    <span class="nv">daylight</span> <span class="o">=</span> <span class="nv">astral</span>.<span class="nv">sun</span>.<span class="nv">daylight</span><span class="ss">(</span><span class="nv">coords</span>.<span class="nv">observer</span>, <span class="nv">date</span><span class="o">=</span><span class="nv">day</span><span class="ss">)</span>

    <span class="nv">dureeDuJour</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">daylight</span>[<span class="mi">1</span>] <span class="o">-</span> <span class="nv">daylight</span>[<span class="mi">0</span>]<span class="ss">)</span>.<span class="nv">seconds</span><span class="o">/</span><span class="mi">3600</span>

    <span class="k">return</span> <span class="nv">dureeDuJour</span>
</code></pre></div>

</details>
<h3 id="calc_day_length_raster">calc_day_length_raster</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calc_day_length_raster</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<p>This function calculates the day length raster for a given period of time.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>date_start</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>duration</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">calc_day_length_raster</span><span class="p">(</span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    This function calculates the day length raster for a given period of time.</span>

<span class="ss">    Args:</span>

<span class="ss">        data (_type_): _description_</span>

<span class="ss">        date_start (_type_): _description_</span>

<span class="ss">        duration (_type_): _description_</span>

<span class="ss">    Returns:</span>

<span class="ss">        _type_: _description_</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">date_start + datetime.timedelta(days=i) for i in range(duration)</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rain</span><span class="w"> </span><span class="k">array</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="o">[</span><span class="n">&quot;dureeDuJour&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;rain&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;rain&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calc_day_length</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">dimension</span><span class="p">,</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">dimension</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tqdm</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;y&quot;</span><span class="o">]</span><span class="p">))</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="k">data</span><span class="o">[</span><span class="n">&quot;dureeDuJour&quot;</span><span class="o">][</span><span class="n">j,y,:</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calc_day_length</span><span class="p">(</span><span class="n">date_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">&quot;y&quot;</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">day</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">raster</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">&quot;dureeDuJour&quot;</span><span class="o">][</span><span class="n">:,:,0</span><span class="o">]</span><span class="p">.</span><span class="n">plot</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="get_grid_size">get_grid_size</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_grid_size</span><span class="p">(</span>
    <span class="n">rainfall_path</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads the list of rainfall files corresponding to the given</p>
<p>date_start and duration, loads the first rainfall file, and returns its grid
size, as dimensions of the rainfall grid define the output resolution of the
model.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>TAMSAT_path</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>date_start</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>duration</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">get_grid_size</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the list of rainfall files corresponding to the given</span>

<span class="sd">    date_start and duration, loads the first rainfall file, and returns its grid</span>

<span class="sd">    size, as dimensions of the rainfall grid define the output resolution of the</span>

<span class="sd">    model.</span>

<span class="sd">    Args:</span>

<span class="sd">        TAMSAT_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">rainfall_files_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_rainfall_files_df</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># checking coherence between date_start and duration and available rainfall data</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">rainfall_files_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;The date range may not be covered by the available rainfall data ; please check rainfall entry files.&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># loading the first rainfall file to get the grid size</span><span class="w"></span>

<span class="w">    </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rainfall_path</span><span class="p">,</span><span class="n">rainfall_files_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">    </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">grid_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="n">grid_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="initialize_default_irrigation">initialize_default_irrigation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">initialize_default_irrigation</span><span class="p">(</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">initialize_default_irrigation</span><span class="ss">(</span><span class="nv">data</span><span class="ss">)</span>:

    # <span class="nv">default</span> <span class="nv">irrigation</span> <span class="nv">scheme</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">irrigation</span><span class="s2">&quot;</span>] <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rain</span><span class="s2">&quot;</span>] <span class="o">*</span> <span class="mi">0</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">irrigation</span><span class="s2">&quot;</span>].<span class="nv">attrs</span> <span class="o">=</span> {<span class="s2">&quot;</span><span class="s">units</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="s">mm</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">long_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="s">irrigation</span><span class="s2">&quot;</span>}

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="load_agera5_data">load_AgERA5_data</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_AgERA5_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">AgERA5_data_path</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loops over the AgERA5 raster files, and loads them into </p>
<p>xarray DataArray, which are then added to the data dictionary.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>AgERA5_data_path</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>date_start</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>duration</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_AgERA5_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loops over the AgERA5 raster files, and loads them into</span>

<span class="sd">    xarray DataArray, which are then added to the data dictionary.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        AgERA5_data_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># getting list of variables</span><span class="w"></span>

<span class="w">    </span><span class="n">AgERA5_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># building a dictionary of dataframes containing the list of files for each variable</span><span class="w"></span>

<span class="w">    </span><span class="n">AgERA5_files_df_collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">AgERA5_variables</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">AgERA5_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">f</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">),</span><span class="w"> </span><span class="n">f</span><span class="p">))]</span><span class="w"></span>

<span class="w">        </span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">AgERA5_files</span><span class="p">})</span><span class="w"></span>

<span class="w">        </span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span><span class="w"></span>

<span class="w">                </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="w"></span>

<span class="w">                </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="w"></span>

<span class="w">            </span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][(</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">date_start</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">date_start</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">duration</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="n">True</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># building a dictionary of correspondance between AgERA5 variables and SARRA variables</span><span class="w"></span>

<span class="w">    </span><span class="n">AgERA5_SARRA_correspondance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;10m_wind_speed_24_hour_mean&#39;</span><span class="p">:</span><span class="n">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;2m_temperature_24_hour_maximum&#39;</span><span class="p">:</span><span class="n">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;2m_temperature_24_hour_mean&#39;</span><span class="p">:</span><span class="s1">&#39;tpMoy&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;2m_temperature_24_hour_minimum&#39;</span><span class="p">:</span><span class="n">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;ET0Hargeaves&#39;</span><span class="p">:</span><span class="s1">&#39;ET0&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;solar_radiation_flux_daily&#39;</span><span class="p">:</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;vapour_pressure_24_hour_mean&#39;</span><span class="p">:</span><span class="n">None</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1"># loading the data</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tqdm</span><span class="p">(</span><span class="n">AgERA5_variables</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">AgERA5_SARRA_correspondance</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">try</span><span class="p">:</span><span class="w"></span>

<span class="w">                </span><span class="n">del</span><span class="w"> </span><span class="n">dataarray_full</span><span class="w"></span>

<span class="w">            </span><span class="n">except</span><span class="p">:</span><span class="w"></span>

<span class="w">                </span><span class="k">pass</span><span class="w"></span>

<span class="w">            </span><span class="n">dataarray_full</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">                </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AgERA5_data_path</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">AgERA5_files_df_collection</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">                </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">])</span><span class="w"></span>

<span class="w">                </span><span class="c1"># TODO: add dataarray.attrs = {} to precise units and long_name</span><span class="w"></span>

<span class="w">                </span><span class="c1"># try:</span><span class="w"></span>

<span class="w">                </span><span class="c1">#     dataarray_full = xr.concat([dataarray_full, dataarray],&quot;time&quot;)</span><span class="w"></span>

<span class="w">                </span><span class="c1"># except:</span><span class="w"></span>

<span class="w">                </span><span class="c1">#     dataarray_full = dataarray</span><span class="w"></span>

<span class="w">                </span><span class="n">dataarray_full</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataarray_full</span><span class="p">,</span><span class="w"> </span><span class="n">dataarray</span><span class="p">],</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="c1"># storing the variable in the data dictionary</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="n">AgERA5_SARRA_correspondance</span><span class="p">[</span><span class="n">variable</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray_full</span><span class="w"></span>

<span class="w">    </span><span class="c1"># unit conversion for solar radiation (kJ/m2 as provided by AgERA5 to MJ/m2/day)</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rg&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rg&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_tamsat_data">load_TAMSAT_data</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_TAMSAT_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">TAMSAT_path</span><span class="p">,</span>
    <span class="n">date_start</span><span class="p">,</span>
    <span class="n">duration</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loops over the rainfall raster files, and loads them into a</p>
<p>xarray DataArray, which is then added to the rain data dictionary. It is
tailored to the TAMSAT rainfall data files, hence its name.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>TAMSAT_path</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>date_start</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>duration</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_TAMSAT_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">TAMSAT_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loops over the rainfall raster files, and loads them into a</span>

<span class="sd">    xarray DataArray, which is then added to the rain data dictionary. It is</span>

<span class="sd">    tailored to the TAMSAT rainfall data files, hence its name.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        TAMSAT_path (_type_): _description_</span>

<span class="sd">        date_start (_type_): _description_</span>

<span class="sd">        duration (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">TAMSAT_files_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_rainfall_files_df</span><span class="p">(</span><span class="n">TAMSAT_path</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray_full</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">TAMSAT_files_df</span><span class="p">)):</span><span class="w"></span>

<span class="w">        </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TAMSAT_path</span><span class="p">,</span><span class="n">TAMSAT_files_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">        </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;spatial_ref&quot;</span><span class="p">])</span><span class="w"></span>

<span class="w">        </span><span class="n">dataarray</span><span class="o">.</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">        </span><span class="n">dataarray_full</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataarray_full</span><span class="p">,</span><span class="w"> </span><span class="n">dataarray</span><span class="p">],</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># try:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     dataarray_full = xr.concat([dataarray_full, dataarray],&quot;time&quot;)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># except:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     dataarray_full = dataarray</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray_full</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="n">True</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray_full</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;rainfall&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_yaml_parameters">load_YAML_parameters</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_YAML_parameters</span><span class="p">(</span>
    <span class="n">file_paramVariete</span><span class="p">,</span>
    <span class="n">file_paramITK</span><span class="p">,</span>
    <span class="n">file_paramTypeSol</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads the parameters from the yaml files.</p>
<p>It is a wrapper for the three functions above.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>file_paramITK</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>file_paramTypeSol</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_YAML_parameters</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">file_paramITK</span><span class="p">,</span><span class="w"> </span><span class="n">file_paramTypeSol</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the parameters from the yaml files.</span>

<span class="sd">    It is a wrapper for the three functions above.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramVariete (_type_): _description_</span>

<span class="sd">        file_paramITK (_type_): _description_</span>

<span class="sd">        file_paramTypeSol (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">paramVariete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_paramVariete</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">paramITK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_paramITK</span><span class="p">(</span><span class="n">file_paramITK</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">paramTypeSol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_paramTypeSol</span><span class="p">(</span><span class="n">file_paramTypeSol</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]):</span><span class="w"></span>

<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NI NON NULL&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txConversion&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIYo&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">])</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">2.506628274631</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">,</span><span class="w"> </span><span class="n">paramTypeSol</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_isda_soil_data">load_iSDA_soil_data</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_iSDA_soil_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">grid_width</span><span class="p">,</span>
    <span class="n">grid_height</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads iSDA soil data and crop to the area of interest remark :</p>
<p>it would be nice to try to modulate the percentage of runoff according to
slope</p>
<p>First, this function loads the iSDA soil data, crops it to the area of
interest and resamples it to match the grid resolution. The iSDA soil class
raster map obtained is passed to the xarray dataset as a new variable.</p>
<p>For the sake of example, the file that is used here already has been
downsampled at TAMSAT resolution. Its specs are available on the CIRAD
Dataverse at the following adress :
https://doi.org/10.1038/s41598-021-85639-y</p>
<p>Second, a correspondance table matching the iSDA soil classes to the soil
physical properties is loaded. Maps of soil physical properties are then
created and added to the xarray dataset.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_iSDA_soil_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads iSDA soil data and crop to the area of interest remark :</span>

<span class="sd">    it would be nice to try to modulate the percentage of runoff according to</span>

<span class="sd">    slope</span>

<span class="sd">    First, this function loads the iSDA soil data, crops it to the area of</span>

<span class="sd">    interest and resamples it to match the grid resolution. The iSDA soil class</span>

<span class="sd">    raster map obtained is passed to the xarray dataset as a new variable.</span>

<span class="sd">    For the sake of example, the file that is used here already has been</span>

<span class="sd">    downsampled at TAMSAT resolution. Its specs are available on the CIRAD</span>

<span class="sd">    Dataverse at the following adress :</span>

<span class="sd">    https://doi.org/10.1038/s41598-021-85639-y</span>

<span class="sd">    Second, a correspondance table matching the iSDA soil classes to the soil</span>

<span class="sd">    physical properties is loaded. Maps of soil physical properties are then</span>

<span class="sd">    created and added to the xarray dataset.</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># load raster data</span><span class="w"></span>

<span class="w">    </span><span class="n">soil_type_file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../data/assets/iSDA_at_TAMSAT_resolution_zeroclass_1E6.tif&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">soil_type_file_path</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># crop to the area of interest</span><span class="w"></span>

<span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;burkina&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="c1">#lat,lon lat,lon</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">selected_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;burkina&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dataarray</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>

<span class="w">                                </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="w"></span>

<span class="w">                                </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>

<span class="w">                                </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">area</span><span class="p">[</span><span class="n">selected_area</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="w"></span>

<span class="w">                            </span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># resample to match the grid resolution</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">])</span><span class="w"></span>

<span class="w">    </span><span class="n">dataarray</span><span class="o">.</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;arbitrary&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;soil_type&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1"># add soil type identifier to the dataset</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataarray</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="w"> </span><span class="c1"># conversion from 1E6 to 1E0</span><span class="w"></span>

<span class="w">    </span><span class="c1"># load correspondance table</span><span class="w"></span>

<span class="w">    </span><span class="n">path_soil_type_correspondance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../data/assets/TypeSol_Moy13_HWSD.csv&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">df_soil_type_correspondance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_soil_type_correspondance</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># correspondance between soil properties naming in the csv file and in the dataset</span><span class="w"></span>

<span class="w">    </span><span class="n">soil_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;epaisseurProf&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EpaisseurProf&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;epaisseurSurf&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EpaisseurSurf&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stockIniProf&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;StockIniProf&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stockIniSurf&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;StockIniSurf&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;seuilRuiss&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SeuilRuiss&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;pourcRuiss&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PourcRuiss&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;ru&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Ru&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1"># create maps of soil properties and add them to the dataset</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">soil_variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">soil_variables</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">dict_values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dict</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="n">df_soil_type_correspondance</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">df_soil_type_correspondance</span><span class="p">[</span><span class="n">soil_variables</span><span class="p">[</span><span class="n">soil_variable</span><span class="p">]]))</span><span class="w"></span>

<span class="w">        </span><span class="n">dict_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="w"></span>

<span class="w">        </span><span class="n">soil_types_converted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">dict_values</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">)]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span><span class="w"> </span><span class="p">(</span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="n">soil_variable</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;soil_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span><span class="n">soil_types_converted</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># TODO: add dataarray.attrs = {} to precise units and long_name</span><span class="w"></span>

<span class="w">    </span><span class="c1"># converting pourcRuiss to decimal %</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pourcRuiss&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pourcRuiss&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_paramitk">load_paramITK</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_paramITK</span><span class="p">(</span>
    <span class="n">file_paramITK</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads the ITK parameters from the yaml file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_paramITK</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_paramITK</span><span class="p">(</span><span class="n">file_paramITK</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the ITK parameters from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramITK (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/itk/&#39;</span><span class="p">,</span><span class="n">file_paramITK</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">stream</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">paramITK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;DateSemis&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;DateSemis&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paramITK</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_paramtypesol">load_paramTypeSol</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_paramTypeSol</span><span class="p">(</span>
    <span class="n">file_paramTypeSol</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads the soil parameters from the yaml file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_paramTypeSol</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_paramTypeSol</span><span class="p">(</span><span class="n">file_paramTypeSol</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the soil parameters from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramTypeSol (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/soil/&#39;</span><span class="p">,</span><span class="n">file_paramTypeSol</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">stream</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">paramTypeSol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paramTypeSol</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="load_paramvariete">load_paramVariete</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_paramVariete</span><span class="p">(</span>
    <span class="n">file_paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function loads the parameters of the variety from the yaml file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<p><strong>Raises:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>exception</td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">load_paramVariete</span><span class="p">(</span><span class="n">file_paramVariete</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function loads the parameters of the variety from the yaml file.</span>

<span class="sd">    Args:</span>

<span class="sd">        file_paramVariete (_type_): _description_</span>

<span class="sd">    Raises:</span>

<span class="sd">        exception: _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../data/params/variety/&#39;</span><span class="p">,</span><span class="n">file_paramVariete</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">stream</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;feuilAeroBase&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">Exception</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paramVariete</span><span class="w"></span>
</code></pre></div>

</details>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../comparison_tools_old/" class="btn btn-neutral float-left" title="Comparison Tools Old"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../" class="btn btn-neutral float-right" title="Index">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../comparison_tools_old/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
