<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Bilan Carbo - SARRA-Py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Bilan Carbo";
        var mkdocs_page_input_path = "reference/sarra_py/bilan_carbo.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SARRA-Py
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../docs/model_formalisms/">Model formalisms</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../docs/spatialization_strategy/">Spatialization strategy</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../docs/tutorial/00_-_Running_a_simulation/">00 - Running a simulation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Sarra Py</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Bilan Carbo</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#functions">Functions</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#biomdensoptsarrav4">BiomDensOptSarraV4</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#biomdensitesarrav42">BiomDensiteSarraV42</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#biommcubtsv3">BiomMcUBTSV3</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#evalassimsarrahv4">EvalAssimSarrahV4</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#evalfeuilletigesarrahv4">EvalFeuilleTigeSarrahV4</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#majbiommcsv3">MAJBiomMcSV3</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#adjust_for_sowing_density">adjust_for_sowing_density</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#calculate_canopy_specific_leaf_area">calculate_canopy_specific_leaf_area</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#calculate_leaf_area_index">calculate_leaf_area_index</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#calculate_maintainance_respiration">calculate_maintainance_respiration</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#compute_rapdensite">compute_rapDensite</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#condition_positive_delta_aboveground_biomass_all_phases">condition_positive_delta_aboveground_biomass_all_phases</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#condition_positive_delta_biomass">condition_positive_delta_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_kassim">estimate_KAssim</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_conv">estimate_conv</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_critical_nitrogen_concentration">estimate_critical_nitrogen_concentration</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_kcp">estimate_kcp</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_ltr">estimate_ltr</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#estimate_reallocation">estimate_reallocation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#initialize_simulation">initialize_simulation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_aboveground_biomass">update_aboveground_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_aboveground_biomass_step_2">update_aboveground_biomass_step_2</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_assim">update_assim</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_assimpot">update_assimPot</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_bm_and_cm">update_bM_and_cM</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_leaf_biomass">update_leaf_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_leaf_biomass_all_phases">update_leaf_biomass_all_phases</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_leaf_biomass_positive_delta_aboveground_biomass">update_leaf_biomass_positive_delta_aboveground_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_potential_yield">update_potential_yield</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_potential_yield_delta">update_potential_yield_delta</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_root_biomass">update_root_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_stem_biomass">update_stem_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_stem_biomass_all_phases">update_stem_biomass_all_phases</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_stem_biomass_positive_delta_aboveground_biomass">update_stem_biomass_positive_delta_aboveground_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_total_biomass">update_total_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_total_biomass_at_flowering_stage">update_total_biomass_at_flowering_stage</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_total_biomass_stade_ip">update_total_biomass_stade_ip</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_vegetative_biomass">update_vegetative_biomass</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#update_yield_during_filling_phase">update_yield_during_filling_phase</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#variable_dict">variable_dict</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bilan_hydro/">Bilan Hydro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bilan_pheno/">Bilan Pheno</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../comparison_tools_old/">Comparison Tools Old</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../data_preparation/">Data Preparation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../models/">Models</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SARRA-Py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Reference &raquo;</li>
          <li>Sarra Py &raquo;</li>
      <li>Bilan Carbo</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/SARRA-cropmodels/SARRA-Py/edit/main/reference/sarra_py/bilan_carbo.md"> Edit on SARRA-Py</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="module-sarra_pybilan_carbo">Module sarra_py.bilan_carbo</h1>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="k">def</span> <span class="nf">variable_dict</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Retrieve the dictionary of variables in the dataset with their respective units.</span>

<span class="sd">    Returns:</span>

<span class="sd">        dict: A dictionary containing the variables and their units, where the keys are the variable names and the values are the respective units.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>

        <span class="c1"># climate</span>

        <span class="s2">&quot;ddj&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;daily thermal time&quot;</span><span class="p">,</span> <span class="s2">&quot;°C.j&quot;</span><span class="p">],</span>

        <span class="s2">&quot;sdj&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sum of thermal time since beginning of emergence&quot;</span><span class="p">,</span> <span class="s2">&quot;°C.j&quot;</span><span class="p">],</span>

        <span class="c1"># phenology</span>

        <span class="s2">&quot;changePhase&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;indicator of phase transition day&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">],</span>

        <span class="s2">&quot;numPhase&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;number of phenological stage&quot;</span><span class="p">,</span> <span class="s2">&quot;arbitrary units&quot;</span><span class="p">],</span>

        <span class="s2">&quot;initPhase&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;indicator of performed phase transition&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">],</span>

        <span class="s2">&quot;phasePhotoper&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;photoperiodic phase indicator&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">],</span>

        <span class="s2">&quot;seuilTempPhaseSuivante&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the next phenological phase&quot;</span><span class="p">,</span> <span class="s2">&quot;°C.j&quot;</span><span class="p">],</span>

        <span class="s2">&quot;sommeDegresJourPhasePrec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the previous phenological phase&quot;</span><span class="p">,</span> <span class="s2">&quot;°C.j&quot;</span><span class="p">],</span>

        <span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the previous phenological phase&quot;</span><span class="p">,</span> <span class="s2">&quot;°C.j&quot;</span><span class="p">],</span>

        <span class="c1"># carbon balance</span>

        <span class="s2">&quot;assim&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;plant biomass assimilation&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;assimPot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;plant potential biomass assimilation&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;bM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;net growth rate of living biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/(m².d)&quot;</span><span class="p">],</span>

        <span class="s2">&quot;cM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;net growth rate of dead biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/(m².d)&quot;</span><span class="p">],</span>

        <span class="s2">&quot;rdt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;grain yield&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;rdtPot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;potential grain yield&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;reallocation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;amount of assimilates reallocated to the yield (supply &lt; demand)&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;respMaint&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;amount of assimilates consumed by maintainance respiration&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;manqueAssim&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;deficit in assimilates (demand - supply)&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="c1"># biomass</span>

        <span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total biomass of the plant at the end of the flowering stage&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total biomass at the panicle initiation stage&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;increment of aerial biomass in one day&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span>

        <span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;increment of leaf biomass in one day&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total aerial biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseVegetative&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total vegetative biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseTotale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseTige&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total stem biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total root biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total leaf biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span>

        <span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;increment of total biomass in one day&quot;</span><span class="p">,</span> <span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span>

        <span class="c1"># evapotranspiration</span>

        <span class="s2">&quot;kce&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fraction of kc attributable to soil evaporation&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span>

        <span class="s2">&quot;kcp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fraction of kc attributable to plant transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span>

        <span class="s2">&quot;kcTot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total crop coefficient&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;tr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;actual crop transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;trPot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;potential crop transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;trSurf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="c1"># water balance</span>

        <span class="s2">&quot;consoRur&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;consumption of water stored in the root system&quot;</span><span class="p">,</span> <span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;water_gathered_by_mulch&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;water captured by the mulch in one day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;eauDispo&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;available water, sum of rainfall and total irrigation for the day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;eauTranspi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;water available for transpiration from the surface reservoir&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;correctedIrrigation&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;corrected irrigation amount&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;cstr&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;drought stress coefficient&quot;</span><span class="p">,</span> <span class="s2">&quot;arbitrary unit&quot;</span><span class="p">],</span>

        <span class="s2">&quot;dayVrac&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;modulated daily root growth&quot;</span><span class="p">,</span><span class="s2">&quot;mm/day&quot;</span><span class="p">],</span>

        <span class="s2">&quot;delta_root_tank_capacity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change in root system water reserve&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;drainage&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;etm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evapotranspiration from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;etp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;potential evapotranspiration from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;etr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;reference evapotranspiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;evap&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evaporation from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;evapPot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;potential evaporation from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;FEMcW&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;water fraction in soil volume explored by the root system&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">],</span>

        <span class="s2">&quot;fesw&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fraction of available surface water&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span>

        <span class="s2">&quot;irrigTotDay&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total irrigation for the day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;vRac&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;reference daily root growth&quot;</span><span class="p">,</span><span class="s2">&quot;mm/day&quot;</span><span class="p">],</span>

        <span class="s2">&quot;ftsw&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fraction of transpirable surface water&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span>

        <span class="s2">&quot;lr&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;daily water runoff&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;pFact&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FAO reference for critical FTSW value for transpiration response&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">],</span>

        <span class="c1"># water tanks</span>

        <span class="s2">&quot;irrigation_tank_stock&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;current stock of water in the irrigation tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stockIrr to irrigation_tank_stock</span>

        <span class="s2">&quot;mulch_water_stock&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;water stored in crop residues (mulch)&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stockMc to mulch_water_stock</span>

        <span class="s2">&quot;root_tank_stock&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;current stock of water in the root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stRu to root_tank_stock</span>

        <span class="s2">&quot;total_tank_capacity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;total capacity of the root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stRuMax to total_tank_capacity</span>

        <span class="s2">&quot;stRur&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="c1"># [&quot;previous season&#39;s root system tank stock&quot;,&quot;mm&quot;],</span>

        <span class="s2">&quot;root_tank_capacity_previous_season&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;previous season&#39;s root system tank capacity&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stRurMaxPrec to root_tank_capacity_previous_season</span>

        <span class="s2">&quot;stRurPrec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;previous day&#39;s root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;stRurSurf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;surface root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;surface_tank_stock&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;current stock of water in the surface root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stRuSurf to surface_tank_stock</span>

        <span class="s2">&quot;stRuSurfPrec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;previous day&#39;s surface root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;delta_total_tank_stock&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change in the total root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming stRuVar to delta_total_tank_stock</span>

        <span class="s2">&quot;irrigation_tank_capacity&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;irrigation tank capacity&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span> <span class="c1">#! renaming ruIrr to irrigation_tank_capacity</span>

        <span class="s2">&quot;ruRac&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Water column that can potentially be strored in soil volume explored by root system&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span>

        <span class="s2">&quot;conv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;KAssim&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;dayBiomLeaf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;daily growth of leaf biomass&quot;</span><span class="p">,</span><span class="s2">&quot;kg/ha/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;dRdtPot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;daily potential demand from yield&quot;</span><span class="p">,</span><span class="s2">&quot;kg/ha/d&quot;</span><span class="p">],</span>

        <span class="s2">&quot;FeuilleUp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;kRespMaint&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;LitFeuille&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;nbJourCompte&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;nbjStress&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;NbUBT&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;sla&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;stockRac&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;sumPP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;TigeUp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;UBTCulture&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;lai&quot;</span><span class="p">:[</span><span class="s2">&quot;leaf area index&quot;</span><span class="p">,</span><span class="s2">&quot;m2/m2&quot;</span><span class="p">],</span>

        <span class="c1"># experimental</span>

        <span class="s2">&quot;Ncrit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span>

    <span class="p">}</span>

    <span class="k">return</span> <span class="n">variables</span>

<span class="k">def</span> <span class="nf">initialize_simulation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">,</span> <span class="n">date_start</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function initializes variables related to crop growth in the data</span>

<span class="sd">    xarray dataset. As the rain is the first variable to be initialized in the</span>

<span class="sd">    data xarray dataset, its dimensions are used to initialize the other</span>

<span class="sd">    variables.</span>

<span class="sd">    ![no caption](../../docs/images/sla.png)</span>

<span class="sd">    This code has been adapted from the original InitiationCulture procedure, from the `MilBilanCarbone.pas` code of the</span>

<span class="sd">    SARRA model.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (_type_): _description_ grid_width (_type_): _description_</span>

<span class="sd">        grid_height (_type_): _description_ duration (_type_): _description_</span>

<span class="sd">        paramVariete (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">### variables to be initialized with values from parameters</span>

    <span class="c1"># from paramVariete : maximum daily thermal time (°C.j) -&gt; #? unused ?</span>

    <span class="c1">#// data[&quot;sommeDegresJourMaximale&quot;] = (data[&quot;rain&quot;].dims, np.full(</span>

    <span class="c1">#//     (duration, grid_width, grid_height),</span>

    <span class="c1">#//     (paramVariete[&quot;SDJLevee&quot;] + paramVariete[&quot;SDJBVP&quot;] + paramVariete[&quot;SDJRPR&quot;] + paramVariete[&quot;SDJMatu1&quot;] + paramVariete[&quot;SDJMatu2&quot;])</span>

    <span class="c1">#// ))</span>

    <span class="c1">#// data[&quot;sommeDegresJourMaximale&quot;].attrs = {&quot;units&quot;:&quot;°C.j&quot;, &quot;long_name&quot;:&quot;Maximum thermal time&quot;}</span>

    <span class="c1"># from paramITK : sowing date</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sowing_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span> <span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;DateSemis&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">date_start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span>

    <span class="c1"># from paramITK : automatic irrigation indicator</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;irrigAuto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;irrigAuto&quot;</span><span class="p">]))</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;irrigAuto&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;automatic irrigation indicator&quot;</span><span class="p">}</span>

    <span class="c1">####### variables qui viennent de initplotMc</span>

    <span class="c1"># Initial biomass of crop residues (mulch) (kg/ha)</span>

    <span class="c1"># Biomasse initiale des résidus de culture (mulch) (kg/ha)</span>

    <span class="c1">#   BiomMc := BiomIniMc;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;biomIniMc&quot;</span><span class="p">]))</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Initial biomass of crop residues (mulch)&quot;</span><span class="p">}</span>

    <span class="c1"># ?</span>

    <span class="c1">#   StSurf := StockIniSurf;</span>

    <span class="c1"># data[&quot;stSurf&quot;] = np.full((grid_width, grid_height, duration), paramTypeSol[&quot;stockIniSurf&quot;])</span>

    <span class="c1"># ?</span>

    <span class="c1">#   Ltr := 1;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ltr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="c1"># Initial biomass of stem residues as litter (kg/ha)</span>

    <span class="c1"># Biomasse initiale des résidus de tiges sous forme de litière (kg/ha)</span>

    <span class="c1">#   LitTiges := BiomIniMc;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;biomIniMc&quot;</span><span class="p">]))</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;kg/ha&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Initial biomass of stem residues as litter&quot;</span><span class="p">}</span>

    <span class="c1">####### fin variables qui viennent de initplotMc</span>

    <span class="c1">####### variables eau depuis InitPlotMc</span>

    <span class="c1"># Initializes variables related to crop residues boimass (mulch) in the data</span>

    <span class="c1"># xarray dataset. This code has been adapted from the original InitPlotMc</span>

    <span class="c1"># procedure, Bileau.pas code. Comments with tab indentation are from the</span>

    <span class="c1"># original code. As the rain is the first variable to be initialized in the</span>

    <span class="c1"># data xarray dataset, its dimensions are used to initialize the other</span>

    <span class="c1"># variables.</span>

    <span class="c1"># Soil maximum water storage capacity (mm)</span>

    <span class="c1"># Capacité maximale de la RU (mm)</span>

    <span class="c1">#   StRurMax := Ru * ProfRacIni / 1000;</span>

    <span class="c1">#! renaming stRurMax with root_tank_capacity</span>

    <span class="c1">#// data[&quot;stRurMax&quot;] = data[&quot;ru&quot;] * paramITK[&quot;profRacIni&quot;] / 1000</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;root_tank_capacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ru&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;profRacIni&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="kp">newaxis</span><span class="p">,:,:],</span> <span class="n">duration</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1">#// data[&quot;stRurMax&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;Soil maximum water storage capacity&quot;}</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;root_tank_capacity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soil maximum water storage capacity&quot;</span><span class="p">}</span>

    <span class="c1"># Maximum water capacity of surface tank (mm)</span>

    <span class="c1"># Reserve utile de l&#39;horizon de surface (mm)</span>

    <span class="c1">#   RuSurf := EpaisseurSurf / 1000 * Ru;</span>

    <span class="c1">#! renaming ruSurf with surface_tank_capacity</span>

    <span class="c1">#// data[&quot;ruSurf&quot;] = data[&quot;epaisseurSurf&quot;] / 1000 * data[&quot;ru&quot;]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;surface_tank_capacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epaisseurSurf&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ru&quot;</span><span class="p">]</span>

    <span class="c1">#// data[&quot;ruSurf&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;Maximum water capacity of surface tank&quot;}</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;surface_tank_capacity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum water capacity of surface tank&quot;</span><span class="p">}</span>

    <span class="c1"># ?</span>

    <span class="c1">#   //    PfTranspi := EpaisseurSurf * HumPf;</span>

    <span class="c1">#   //    StTot := StockIniSurf - PfTranspi/2 + StockIniProf;</span>

    <span class="c1">#   StTot := StockIniSurf  + StockIniProf;</span>

    <span class="c1"># data[&quot;stTot&quot;] = np.full((grid_width, grid_height, duration), (paramTypeSol[&quot;stockIniSurf&quot;] + paramTypeSol[&quot;stockIniProf&quot;]))</span>

    <span class="c1">#! modifié pour faire correspondre les résultats de simulation, à remettre en place pour un calcul correct dès que possible</span>

    <span class="c1"># data[&quot;stTot&quot;] = np.full((grid_width, grid_height, duration), (paramTypeSol[&quot;stockIniProf&quot;]))</span>

    <span class="c1">#! renaming stTot to total_tank_stock</span>

    <span class="c1">#// data[&quot;stTot&quot;] = data[&quot;stockIniProf&quot;]</span>

    <span class="c1">#//data[&quot;total_tank_stock&quot;] = data[&quot;stockIniProf&quot;]</span>

    <span class="c1">#! coorecting total_tank_stock initialization as it did not have the time dimensions that are required as stock evolves through time</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tank_stock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;stockIniProf&quot;</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="kp">newaxis</span><span class="p">,:,:],</span> <span class="n">duration</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1">#// data[&quot;stTot&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;?&quot;}</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tank_stock&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span><span class="p">}</span>

    <span class="c1"># Soil maximal depth (mm)</span>

    <span class="c1"># Profondeur maximale de sol (mm)</span>

    <span class="c1">#   ProfRU := EpaisseurSurf + EpaisseurProf;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profRu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epaisseurProf&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epaisseurSurf&quot;</span><span class="p">]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profRu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soil maximal depth&quot;</span><span class="p">}</span>

    <span class="c1"># Maximum water capacity to humectation front (mm)</span>

    <span class="c1"># Quantité d&#39;eau maximum jusqu&#39;au front d&#39;humectation (mm)</span>

    <span class="c1">#   // modif 10/06/2015  resilience stock d&#39;eau</span>

    <span class="c1">#   // Front d&#39;humectation egal a RuSurf trop de stress initial</span>

    <span class="c1">#   //    Hum := max(StTot, StRurMax);</span>

    <span class="c1">#   Hum := max(RuSurf, StRurMax);</span>

    <span class="c1">#   // Hum mis a profRuSurf</span>

    <span class="c1">#   Hum := max(StTot, Hum);</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;hum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

            <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

                <span class="c1">#! renaming ruSurf with surface_tank_capacity</span>

                <span class="c1">#// data[&quot;ruSurf&quot;],</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;surface_tank_capacity&quot;</span><span class="p">]</span><span class="o">.</span><span class="kp">expand_dims</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">duration</span><span class="p">}),</span>

                <span class="c1">#! renaming stRurMax with root_tank_capacity</span>

                <span class="c1">#// data[&quot;stRurMax&quot;],</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;root_tank_capacity&quot;</span><span class="p">],</span>

            <span class="p">),</span>

            <span class="c1">#! renaming stTot with total_tank_stock</span>

            <span class="c1">#// data[&quot;stTot&quot;],</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tank_stock&quot;</span><span class="p">],</span>

        <span class="p">)</span>

    <span class="p">))</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;hum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum water capacity to humectation front&quot;</span><span class="p">}</span>

    <span class="c1"># Previous value for Maximum water capacity to humectation front (mm)</span>

    <span class="c1">#  HumPrec := Hum;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;humPrec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;hum&quot;</span><span class="p">]</span>

    <span class="c1"># ?</span>

    <span class="c1">#   StRurPrec := 0;</span>

    <span class="c1"># Previous value for stTot</span>

    <span class="c1">#   StRurMaxPrec := 0;</span>

    <span class="c1">#   //modif 10/06/2015 resilience stock d&#39;eau</span>

    <span class="c1">#! renaming stTot with total_tank_stock</span>

    <span class="c1">#! renaminog stRuPrec with total_tank_stock_previous_value</span>

    <span class="c1">#// data[&quot;stRuPrec&quot;] =  data[&quot;stTot&quot;]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tank_stock_previous_value&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tank_stock&quot;</span><span class="p">]</span>

    <span class="c1">####### fin variables eau depuis InitPlotMc</span>

    <span class="c1"># depuis meteo.pas</span>

    <span class="n">kpar</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;par&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpar</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rg&quot;</span><span class="p">]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;par&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;MJ/m2&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;par&quot;</span><span class="p">}</span>

    <span class="c1"># crop density</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densOpti&quot;</span><span class="p">])</span> <span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">compute_rapDensite</span><span class="p">(</span><span class="n">paramITK</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="s2">&quot;sowing density adjustement factor&quot;</span><span class="p">}</span>

    <span class="c1"># initialize variables with values at 0</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">variable_dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span> <span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="kp">shape</span><span class="o">=</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">)))</span>

        <span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">variables</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="n">variables</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_kcp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Estimate the kcp coefficient based on the maximum crop coefficient `kcMax` and plant cover `ltr`.</span>

<span class="sd">    The computation of `kcp` is based on the EvolKcpKcIni procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The starting index for updating `kcp` in the `data` dataset.</span>

<span class="sd">        data (xarray.Dataset): A dataset containing the data used in the computation of `kcp`. The dataset should contain the following variables:</span>

<span class="sd">            - &#39;numPhase&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the number of phases in the crop cycle.</span>

<span class="sd">            - &#39;kcp&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the coefficient of crop growth.</span>

<span class="sd">            - &#39;ltr&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the plant cover.</span>

<span class="sd">        paramVariete (dict): A dictionary containing the parameters for estimating `kcp`. The dictionary should contain the following key:</span>

<span class="sd">            - &#39;kcMax&#39;: A float, representing the maximum crop coefficient.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated `data` dataset with the new `kcp` values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;kcp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kcMax&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ltr&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;kcp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_ltr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Estimate the fraction of radiation transmitted to the soil `ltr` based on the leaf area index `lai`.</span>

<span class="sd">    `ltr` is used as a proxy for plant covering of the soil in the water balance calculation, where 1 represents no plant cover and 0 represents full plant cover. `ltr` is computed as an exponential decay function of `lai` with a decay coefficient `kdf`.</span>

<span class="sd">    This function is adapted from the EvalLtr procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The starting index for updating `ltr` in the `data` dataset.</span>

<span class="sd">        data (xarray.Dataset): A dataset containing the data used in the computation of `ltr`. The dataset should contain the following variables:</span>

<span class="sd">            - &#39;lai&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the leaf area index.</span>

<span class="sd">            - &#39;ltr&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the fraction of radiation transmitted to the soil.</span>

<span class="sd">        paramVariete (dict): A dictionary containing the parameters for estimating `ltr`. The dictionary should contain the following key:</span>

<span class="sd">            - &#39;kdf&#39;: A float, representing the decay coefficient for `ltr`.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated `data` dataset with the new `ltr` values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># group 80</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ltr&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kdf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_KAssim</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function calculates the conversion factor `KAssim`, which is used to convert assimilates into biomass.</span>

<span class="sd">    The value of `KAssim` depends on the phase of the crop.</span>

<span class="sd">    The conversion factor is calculated based on a lookup table that maps crop phases to values. The crop phase is</span>

<span class="sd">    determined by the `numPhase` field in the `data` argument, and the corresponding `KAssim` value is set in the</span>

<span class="sd">    `KAssim` field of the `data` argument.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): An integer index specifying the time step.</span>

<span class="sd">        data (xarray.Dataset): A dataset containing the variables used in the calculation of `KAssim`. The dataset</span>

<span class="sd">            should include the fields `numPhase`, `sdj`, `seuilTemp PhasePrec`, and `seuilTemp PhaseSuivante`. The</span>

<span class="sd">            `KAssim` field of the dataset will be updated by this function.</span>

<span class="sd">        paramVariete (dict): A dictionary of parameters. It should include the fields `txAssimBVP`, `txAssimMatu1`,</span>

<span class="sd">            and `txAssimMatu2`.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated `data` dataset, with the `KAssim` field set to the calculated values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">phase_equivalences</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

        <span class="mi">3</span><span class="p">:</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="p">],</span>

        <span class="mi">4</span><span class="p">:</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="p">],</span>

        <span class="c1">#! replacing sommeDegresJourPhasePrec with seuilTempPhasePrec</span>

        <span class="c1">#// 5: paramVariete[&quot;txAssimBVP&quot;] + (data[&#39;sdj&#39;][j,:,:] - data[&#39;sommeDegresJourPhasePrec&#39;][j,:,:]) * (paramVariete[&#39;txAssimMatu1&#39;] -  paramVariete[&#39;txAssimBVP&#39;]) / (data[&#39;seuilTempPhaseSuivante&#39;][j,:,:] - data[&#39;sommeDegresJourPhasePrec&#39;][j,:,:]),</span>

        <span class="mi">5</span><span class="p">:</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txAssimBVP&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sdj&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;seuilTempPhasePrec&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;txAssimMatu1&#39;</span><span class="p">]</span> <span class="o">-</span>  <span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;seuilTempPhaseSuivante&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;seuilTempPhasePrec&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

        <span class="c1">#// 6: paramVariete[&quot;txAssimMatu1&quot;] + (data[&quot;sdj&quot;][j,:,:] - data[&quot;sommeDegresJourPhasePrec&quot;][j,:,:]) * (paramVariete[&quot;txAssimMatu2&quot;] - paramVariete[&quot;txAssimMatu1&quot;]) / (data[&quot;seuilTempPhaseSuivante&quot;][j,:,:] - data[&quot;sommeDegresJourPhasePrec&quot;][j,:,:]),</span>

        <span class="mi">6</span><span class="p">:</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txAssimMatu1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sdj&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txAssimMatu2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txAssimMatu1&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;seuilTempPhaseSuivante&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

    <span class="p">}</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;KAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">phase</span><span class="p">,</span>

            <span class="n">phase_equivalences</span><span class="p">[</span><span class="n">phase</span><span class="p">],</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;KAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_conv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function calculates the conversion of assimilates into biomass.</span>

<span class="sd">    The conversion factor is determined by multiplying the KAssim value, which</span>

<span class="sd">    is dependent on the phase of the crop, with the conversion rate (txConversion)</span>

<span class="sd">    specified in the `paramVariete` argument.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The starting index of the calculation</span>

<span class="sd">        data (dict): A dictionary containing information on the crop growth, including</span>

<span class="sd">                     the phase of the crop and the KAssim value.</span>

<span class="sd">        paramVariete (dict): A dictionary containing parameters relevant to the crop</span>

<span class="sd">                             growth, including the conversion rate.</span>

<span class="sd">    Returns:</span>

<span class="sd">        dict: The input `data` dictionary with the calculated &quot;conv&quot; value added.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;KAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txConversion&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">BiomDensOptSarraV4</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    si densité plus faible alors on considére qu&#39;il faut augmenter les biomasses, LAI etc</span>

<span class="sd">    en regard de cette situation au niveau de chaque plante (car tout est rapporté é des kg/ha).</span>

<span class="sd">    Si elle est plus forte on ne change rien pour lors.</span>

<span class="sd">    Valeur fixe en ref au maés é déf en paramétre par variétésé rapDensite := Max(1, 70000/densite);</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    if ~np.isnan(paramVariete[&quot;densOpti&quot;]) :</span>

<span class="sd">        paramITK[&quot;rapDensite&quot;] = np.maximum(1,paramVariete[&quot;densOpti&quot;]/paramITK[&quot;densite&quot;])</span>

<span class="sd">        data[&quot;rdt&quot;][j,:,:] = data[&quot;rdt&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseRacinaire&quot;][j,:,:] = data[&quot;biomasseRacinaire&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseTige&quot;][j,:,:] = data[&quot;biomasseTige&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseFeuille&quot;][j,:,:] = data[&quot;biomasseFeuille&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseAerienne&quot;][j,:,:] = data[&quot;biomasseTige&quot;][j,:,:] + data[&quot;biomasseFeuille&quot;][j,:,:] + data[&quot;rdt&quot;][j,:,:]</span>

<span class="sd">        data[&quot;lai&quot;][j,:,:]  = data[&quot;biomasseFeuille&quot;][j,:,:] * data[&quot;sla&quot;][j,:,:]</span>

<span class="sd">        data[&quot;biomasseTotale&quot;][j,:,:] = data[&quot;biomasseAerienne&quot;][j,:,:] + data[&quot;biomasseRacinaire&quot;][j,:,:]</span>

<span class="sd">    return data</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">compute_rapDensite</span><span class="p">(</span><span class="n">paramITK</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    It basically calculates a correction factor (rapDensite).</span>

<span class="sd">    This correction factor Is calculated with an equation of form</span>

<span class="sd">    a + p * exp( -(x/(o / -log((1-a)/p) )) )</span>

<span class="sd">    with a the densiteA parameter</span>

<span class="sd">    p the densiteP parameter$</span>

<span class="sd">    x the actual crop density</span>

<span class="sd">    o the densOpti parameter</span>

<span class="sd">    See</span>

<span class="sd">    https://www.wolframalpha.com/input?i=a+%2B+p+*+exp%28-%28x+%2F+%28+o%2F-+log%28%281+-+a%29%2F+p%29%29%29%29</span>

<span class="sd">    for equation visualization.</span>

<span class="sd">    This equation is probably too complex for the problem at hand.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        paramITK (_type_): _description_</span>

<span class="sd">        paramVariete (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rapDensite</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densiteA&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densiteP&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;densite&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densOpti&quot;</span><span class="p">]</span><span class="o">/-</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;densiteA&#39;</span><span class="p">])</span><span class="o">/</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densiteP&quot;</span><span class="p">]))))</span>

    <span class="k">return</span> <span class="n">rapDensite</span>

<span class="k">def</span> <span class="nf">adjust_for_sowing_density</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function translates the effect of sowing density on biomass and LAI.</span>

<span class="sd">    This function is adapted from the BiomDensOptSarV42 and BiomDensiteSarraV42</span>

<span class="sd">    procedures, from the bilancarbonsarra.pas original Pascal code.</span>

<span class="sd">    Notes from CB :</span>

<span class="sd">    if density is lower than the optimal density, then we consider that we need</span>

<span class="sd">    to increase the biomass, LAI etc in regard of this situation at each plant</span>

<span class="sd">    level (because everything is related to kg/ha). If it is higher, it</span>

<span class="sd">    increases asymptotically.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        paramITK (_type_): _description_</span>

<span class="sd">        paramVariete (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span> <span class="p">:</span>

        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densOpti&quot;</span><span class="p">])</span> <span class="p">:</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densOpti&quot;</span><span class="p">]):</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

            <span class="c1">#? conflit avec fonction evolLAIphase ?</span>

            <span class="c1">#data[&quot;lai&quot;][j:,:,:]  = data[&quot;biomasseFeuille&quot;][j,:,:] * data[&quot;sla&quot;][j,:,:]</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span>  <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

            <span class="c1">#data[&quot;biomasseTotale&quot;][j:,:,:] = data[&quot;biomasseTotale&quot;][j:,:,:] / data[&quot;rapDensite&quot;]</span>

        <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">EvalAssimSarrahV4</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    data[&quot;parIntercepte&quot;][j,:,:] = 0.5 * (1 - data[&quot;ltr&quot;][j,:,:]) * data[&quot;rg&quot;][j,:,:]</span>

<span class="sd">    data[&quot;assimPot&quot;][j:,:,:] = data[&quot;parIntercepte&quot;][j,:,:] * data[&quot;conv&quot;][j,:,:] * 10</span>

<span class="sd">    data[&quot;assim&quot;][j,:,:] = np.where(</span>

<span class="sd">        data[&quot;trPot&quot;][j,:,:] &gt; 0,</span>

<span class="sd">        data[&quot;assimPot&quot;][j,:,:] * data[&quot;tr&quot;][j,:,:] / data[&quot;trPot&quot;][j,:,:],</span>

<span class="sd">        0,</span>

<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_assimPot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the assimPot value based on the intensification level (NI).</span>

<span class="sd">    If the intensification level `NI` is defined in `paramITK`, the conversion rate `txConversion` is computed using a formula based on `NIYo`, `NIp`, `LGauss`, and `AGauss`. If `NI` is not defined, `assimPot` is updated using `conv`, which is updated in the `estimate_conv` function using the variables `KAssim` and `txConversion`.</span>

<span class="sd">    When NI parameter is used (from to 4), conversion rate txConversion</span>

<span class="sd">    is computed using the following formula :</span>

<span class="sd">    NIYo + NIp * (1-exp(-NIp * NI)) - (exp(-0.5*((NI - LGauss)/AGauss)* (NI- LGauss)/AGauss))/(AGauss*2.506628274631)</span>

<span class="sd">    This function is adapted from the `EvalAssimSarraV42` procedure in the `bilancarbonsarra.pas` file of the original Pascal code.</span>

<span class="sd">    Note from</span>

<span class="sd">    CB : correction of the conversion rate depending on the intensification</span>

<span class="sd">    level</span>

<span class="sd">    notes from CB reharding the EvalAssimSarraV42 procedure :</span>

<span class="sd">    Modif du 04/03/2021 : Prise en compte en plus de la densit� de semis de</span>

<span class="sd">    l&#39;effet niveau d&#39;intensification NI NI = 1 quand on est � l&#39;optimum du</span>

<span class="sd">    niveau d&#39;intensification. Dans le cas de situation contr�l� c&#39;est la</span>

<span class="sd">    fertilit� qui est la clef principale en prenant en r�f�rence la qt� d&#39;azote</span>

<span class="sd">    (�quivalent phosphore...) optimum Il peut aller � 0 ou �tre sup�rieur � 1 si</span>

<span class="sd">    situation sur optimum, ie un peu plus de rdt mais � cout trop �lev�... On</span>

<span class="sd">    �value un nouveau tx de conversion en fn du Ni au travers d&#39;une double</span>

<span class="sd">    �quation : asympote x gaussienne invers�e Et d&#39;un NI d�fini en fn du</span>

<span class="sd">    sc�nario de simulation ou des donn�es observ�es. NIYo = D�calage en Y de</span>

<span class="sd">    l&#39;asymptote NIp  = pente de l&#39;asymptote LGauss = Largeur de la Guaussienne</span>

<span class="sd">    AGauss = Amplitude de la Guaussienne</span>

<span class="sd">    Conversion qui est la valeur du taux de conversion en situation optimum n&#39;a</span>

<span class="sd">    plus besoin d&#39;�tre utilis� sinon dans la calibration des param�tres de cette</span>

<span class="sd">    �quation en absence de donn�es sur ces param�tres on ne met aucune valeur �</span>

<span class="sd">    NI CF fichier ex IndIntensite_txConv_eq.xls}</span>

<span class="sd">    Args:</span>

<span class="sd">    - j (int): An index that represents the current iteration.</span>

<span class="sd">    - data (dict): A dictionary containing data arrays with the following keys:</span>

<span class="sd">        - &quot;assimPot&quot; (np.ndarray): An array representing the potential assimilation rate.</span>

<span class="sd">        - &quot;par&quot; (np.ndarray): An array representing photosynthetically active radiation.</span>

<span class="sd">        - &quot;lai&quot; (np.ndarray): An array representing the leaf area index.</span>

<span class="sd">        - &quot;conv&quot; (np.ndarray): An array representing the conversion rate.</span>

<span class="sd">    - paramVariete (dict): A dictionary containing parameters for the computation of the conversion rate, including:</span>

<span class="sd">        - &quot;txConversion&quot; (float): The conversion rate.</span>

<span class="sd">        - &quot;NIYo&quot; (float): The shift in the Y-axis of the asymptote.</span>

<span class="sd">        - &quot;NIp&quot; (float): The slope of the asymptote.</span>

<span class="sd">        - &quot;LGauss&quot; (float): The width of the Gaussian curve.</span>

<span class="sd">        - &quot;AGauss&quot; (float): The amplitude of the Gaussian curve.</span>

<span class="sd">        - &quot;kdf&quot; (float): The constant used in the computation of `assimPot`.</span>

<span class="sd">    - paramITK (dict): A dictionary containing the intensification level `NI` (float).</span>

<span class="sd">    Returns:</span>

<span class="sd">    - data (dict): The input `data` dictionary with the updated &quot;assimPot&quot; array.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]):</span>

        <span class="c1">#? the following (stupidly long) line was found commented, need to check why and if this is correct</span>

        <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txConversion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIYo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;NIp&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]))</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">])</span><span class="o">*</span> <span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;NI&quot;</span><span class="p">]</span><span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;LGauss&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;AGauss&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">2.506628274631</span><span class="p">)</span>

        <span class="c1"># NIYo + NIp * (1-exp(-NIp * NI)) - (exp(-0.5*((NI - LGauss)/AGauss)* (NI- LGauss)/AGauss))/(AGauss*2.506628274631)</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;assimPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;par&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> \

            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kdf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]))</span> <span class="o">*</span> \

            <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txConversion&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>

    <span class="k">else</span> <span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;assimPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;par&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> \

            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kdf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]))</span> <span class="o">*</span> \

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mi">10</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_assim</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates assim. If trPot (potential transpiration from the</span>

<span class="sd">    plant, mm) is greater than 0, then assim equals assimPot, multiplied by the</span>

<span class="sd">    ratio of effective transpiration over potential transpiration.</span>

<span class="sd">    If potential transpiration is null, then assim is null as well.</span>

<span class="sd">    Is it adapted from the EvalAssimSarraV42 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;assim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;assimPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tr&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="mi">0</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">calculate_maintainance_respiration</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function calculates the maintenance respiration `respMaint` (in kg/ha/j in equivalent dry matter) of the plant.</span>

<span class="sd">    The maintenance respiration is calculated by summing the maintenance respiration associated with total biomass and</span>

<span class="sd">    leaves biomass. If the plant&#39;s growth phase is above 4 and there is no leaf biomass, `respMaint` is set to 0.</span>

<span class="sd">    The calculation is based on the equation:</span>

<span class="sd">      coefficient_temp = 2^((average_temp - tempMaint) / 10)</span>

<span class="sd">      respiration = kRespMaint * biomass * coefficient_temp</span>

<span class="sd">    where `average_temp` is the average temperature for the day, `tempMaint` is the maintenance temperature from</span>

<span class="sd">    `variety_params`, `kRespMaint` is the maintenance respiration coefficient from `variety_params`, and `biomass`</span>

<span class="sd">    is the total or leaf biomass.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The time step of the calculation.</span>

<span class="sd">        data (xarray.Dataset): The input data containing the variables `tpMoy`, `biomasseTotale`, `biomasseFeuille`, and</span>

<span class="sd">            `numPhase`. The output `respMaint` will also be stored in this dataset.</span>

<span class="sd">        variety_params (dict): The parameters related to the plant variety, containing the keys `tempMaint` and</span>

<span class="sd">            `kRespMaint`.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The input `data` with the updated `respMaint` variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">coefficient_temp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tpMoy&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;tempMaint&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">resp_totale</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kRespMaint&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">coefficient_temp</span>

    <span class="n">resp_feuille</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;kRespMaint&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">coefficient_temp</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">resp_totale</span> <span class="o">+</span> <span class="n">resp_feuille</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_total_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the Total Biomass of the Plant.</span>

<span class="sd">    The total biomass is updated based on the plant&#39;s current phase and other parameters.</span>

<span class="sd">    If the plant is in phase 2 and there&#39;s a change in phase, the total biomass is initialized using</span>

<span class="sd">    crop density, grain yield per plant, and the dry weight of the grain.</span>

<span class="sd">    If the plant is not in phase 2 or there&#39;s no change in phase, the total biomass is incremented with</span>

<span class="sd">    the difference between the plant&#39;s assimilation and maintenance respiration.</span>

<span class="sd">    When passing from phase 1 to phase 2, total biomass is initialized.</span>

<span class="sd">    Initialization value is computed from crop density (plants/ha), txResGrain</span>

<span class="sd">    (grain yield per plant), and poidsSecGrain. Otherwise, total biomass is</span>

<span class="sd">    incremented with the difference between plant assimilation assim and</span>

<span class="sd">    maintainance respiration respMaint.</span>

<span class="sd">    This function is adapted from the EvolBiomTotSarrahV4 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The current time step.</span>

<span class="sd">        data (xarray.Dataset): The data for the plant, including variables like</span>

<span class="sd">            &quot;biomasseTotale&quot;, &quot;assim&quot;, &quot;respMaint&quot;, &quot;numPhase&quot;, and &quot;changePhase&quot;.</span>

<span class="sd">        paramVariete (dict): A dictionary of parameters specific to the plant variety.</span>

<span class="sd">        paramITK (dict): A dictionary of inter-tropical convergence zone parameters.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated data for the plant, including the updated &quot;biomasseTotale&quot;</span>

<span class="sd">            and &quot;deltaBiomasseTotale&quot; variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span>

        <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;densite&quot;</span><span class="p">]</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;densOpti&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">paramITK</span><span class="p">[</span><span class="s1">&#39;densite&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txResGrain&quot;</span><span class="p">]</span> <span class="o">*</span>  <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;poidsSecGrain&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>  <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

    <span class="p">)</span>

    <span class="c1"># we may want to drop this variable and use the raw computation instead</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_total_biomass_stade_ip</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the total biomass of the plant at the end of the vegetative phase (ip = &quot;initiation paniculaire&quot;).</span>

<span class="sd">    If the plant has reached phase 4 and has just changed phase, the current</span>

<span class="sd">    total biomass will be copied to the &quot;biomTotStadeIp&quot; variable, which represents</span>

<span class="sd">    the total biomass at the end of the vegetative phase (initiation paniculaire).</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">    j (int): Timestep index.</span>

<span class="sd">    data (xarray.Dataset): Input dataset.</span>

<span class="sd">    Returns:</span>

<span class="sd">    xarray.Dataset: The updated dataset with the &quot;biomTotStadeIp&quot; variable updated.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_total_biomass_at_flowering_stage</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates the total biomass of the plant at the end of the</span>

<span class="sd">    flowering stage (biomTotStadeFloraison).</span>

<span class="sd">    If the plant is in phase 5, and the phase has changed, then the total</span>

<span class="sd">    biomass is copied to the biomTotStadeFloraison variable.</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_potential_yield</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the potential yield of the plant.</span>

<span class="sd">    The potential yield is initialized as an affine function of the delta</span>

<span class="sd">    between the end of the vegetative phase and the end of the flowering stage,</span>

<span class="sd">    plus a linear function of the total biomass at the end of the flowering stage.</span>

<span class="sd">    The potential yield is capped to twice the biomass of the stem to avoid unrealistic</span>

<span class="sd">    values.</span>

<span class="sd">    The update occurs if the plant is in phase 5 and its phase has changed</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): An index representing the current time step.</span>

<span class="sd">        data (xarray.Dataset): A dataset containing plant data.</span>

<span class="sd">        paramVariete (dict): A dictionary containing parameters for the plant variety.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The input `data` with the potential yield updated.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">delta_biomass_flowering_ip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>

        <span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;KRdtPotA&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_biomass_flowering_ip</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;KRdtPotB&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;KRdtBiom&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="c1">#! phaseDevVeg pas utilisé ? attention c&#39;est un paramètre variétal et pas un jeu de donées</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;phaseDevVeg&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_potential_yield_delta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates the delta potential yield (dRdtPot) of the plant, which is the rate at which the</span>

<span class="sd">    plant&#39;s yield is changing over time. The delta potential yield is calculated as the product of the potential</span>

<span class="sd">    yield, the ratio of actual degree days to maturity, and the ratio of actual transpiration to potential transpiration.</span>

<span class="sd">    The calculation is only done if the plant is in phase 5 and the potential transpiration is above 0.</span>

<span class="sd">    If the potential transpiration is not above 0, the delta potential yield is set to 0.</span>

<span class="sd">    For all other phases, the delta potential yield is unchanged.</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">    - j (int): an integer index, representing the current step of the simulation</span>

<span class="sd">    - data (xarray dataset): the simulation data, including the current state of the plant</span>

<span class="sd">    - paramVariete (dict): the variety-specific parameters used in the simulation</span>

<span class="sd">    Returns:</span>

<span class="sd">    - data (xarray dataset): the updated simulation data, including the updated delta potential yield</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>

            <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ddj&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;SDJMatu1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tr&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">,</span>

            <span class="p">),</span>

            <span class="mi">0</span><span class="p">,</span>

        <span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the aboveground biomass of the plant.</span>

<span class="sd">    The aboveground biomass is either updated based on a linear function of the total biomass, if the plant is in phase 2, 3, or 4, or incremented with the total biomass delta if the plant is in any other phase.</span>

<span class="sd">    This function is based on the EvolBiomAeroSarrahV3 procedure, of the</span>

<span class="sd">    ***bilancarbonsarra***, exmodules 1 &amp; 2.pas file from the original Pascal</span>

<span class="sd">    code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The current iteration step in the simulation.</span>

<span class="sd">        data (xarray.Dataset): The simulation data, including the current phase of the plant and various biomass values.</span>

<span class="sd">        paramVariete (dict): The parameters of the plant variety.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated simulation data, including the updated aboveground biomass and delta aboveground biomass.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#// data[&quot;deltaBiomasseAerienne&quot;][j:,:,:] = np.copy(data[&quot;biomasseAerienne&quot;][j,:,:])</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">minimum</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;aeroTotPente&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;aeroTotBase&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="c1">#//data[&quot;deltaBiomasseAerienne&quot;][j:,:,:] = (data[&quot;biomasseAerienne&quot;][j,:,:] - data[&quot;deltaBiomasseAerienne&quot;][j,:,:])#[...,np.newaxis]</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_reallocation</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Estimate the daily biomass reallocation between stem and leaves.</span>

<span class="sd">    This function computes the daily biomass reallocation between stem and leaves for the plant. The computation</span>

<span class="sd">    only occurs when the plant is in phase 5. The amount of biomass that can be reallocated is estimated as</span>

<span class="sd">    follows:</span>

<span class="sd">    1. The difference between the potential yield delta and the aboveground biomass delta, bound by 0, is</span>

<span class="sd">    calculated and referred to as manqueAssim. manqueAssim represents the daily variation in biomass that</span>

<span class="sd">    remains after the plant has built its aboveground biomass.</span>

<span class="sd">    2. The reallocation is computed as the minimum of the product of manqueAssim and the reallocation rate and</span>

<span class="sd">    the difference between the leaf biomass and 30, also bound by 0. The value of 30 is an arbitrary</span>

<span class="sd">    threshold which ensures that reallocation is 0 if the leaf biomass is below 30. If the leaf biomass is</span>

<span class="sd">    above 30, reallocation is bounded by biomasseFeuille - 30.</span>

<span class="sd">    If the plant is not in phase 5, reallocation is set to 0.</span>

<span class="sd">    This function is based on the EvalReallocationSarrahV3 procedure from the bilancarbonsarra.pas and</span>

<span class="sd">    exmodules 1 &amp; 2.pas files from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): Current time step of the simulation.</span>

<span class="sd">        data (xarray.Dataset): The dataset containing all the simulation data.</span>

<span class="sd">        paramVariete (dict): A dictionary containing the parameters for the simulation.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated dataset with the reallocation values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;manqueAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition</span><span class="p">,</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span>  <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]))),</span>

        <span class="mi">0</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition</span><span class="p">,</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">minimum</span><span class="p">(</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;manqueAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txRealloc&quot;</span><span class="p">],</span>

            <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span>

        <span class="p">),</span>

        <span class="mi">0</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_root_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the root biomass (biomasseRacinaire) for a given time step.</span>

<span class="sd">    The root biomass is computed as the difference between the total biomass</span>

<span class="sd">    and the aboveground biomass.</span>

<span class="sd">    This function is based on the EvalBiomasseRacinaire procedure, of the</span>

<span class="sd">    milbilancarbone, exmodules 1 &amp; 2, ***milbilancarbone***.pas file from the</span>

<span class="sd">    original Pascal code</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): Time step index.</span>

<span class="sd">        data (xarray.Dataset): Input dataset containing relevant variables.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: Updated dataset with the root biomass variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_leaf_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    For phase above 1 and if the delta of aerial biomass is negative,</span>

<span class="sd">    meaning that the plant is losing aerial biomass, the leaf biomass is</span>

<span class="sd">    updated as the difference between the leaf biomass and the reallocation</span>

<span class="sd">    minus the delta of aerial biomass multiplied by the reallocation rate in</span>

<span class="sd">    leaves. This value is bound in 0.00000001.</span>

<span class="sd">    Otherwise, the leaf biomass is not updated.</span>

<span class="sd">    This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files from the original</span>

<span class="sd">    Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

            <span class="mf">0.00000001</span><span class="p">,</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">*</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;pcReallocFeuille&quot;</span><span class="p">]</span>

        <span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_stem_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    For phase above 1 and if the delta of aerial biomass is negative,</span>

<span class="sd">    meaning that the plant is losing aerial biomass, the stem biomass is</span>

<span class="sd">    updated as the difference between the leaf biomass and the reallocation</span>

<span class="sd">    minus the delta of aerial biomass multiplied by (1-reallocation rate in</span>

<span class="sd">    leaves) (if it&#39;s not leaves, it&#39;s stems...). This value is bound in 0.00000001.</span>

<span class="sd">    Otherwise, the stem biomass is not updated.</span>

<span class="sd">    This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files from the original</span>

<span class="sd">    Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># group 122</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

            <span class="mf">0.00000001</span><span class="p">,</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;pcReallocFeuille&quot;</span><span class="p">]),</span>

            <span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">condition_positive_delta_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> \

            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \

            <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;phaseDevVeg&quot;</span><span class="p">]))</span>

            <span class="c1"># (data[&quot;numPhase&quot;][j,:,:] &lt;= 4)</span>

        <span class="k">return</span> <span class="n">condition</span>

<span class="k">def</span> <span class="nf">update_bM_and_cM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function returns the updated values of bM and cM.</span>

<span class="sd">    bM and cM are updated if the delta of aerial biomass is positive,</span>

<span class="sd">    meaning that the plant is gaining aerial biomass, and if the phase is</span>

<span class="sd">    above 1 and below 4 or the phase is below the vegetative phase.</span>

<span class="sd">    This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas files from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">),</span>

        <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;feuilAeroBase&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">),</span>

        <span class="p">((</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;feuilAeroPente&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="mf">0.78</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.75</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_leaf_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">),</span>

        <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">**</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> \

            <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_stem_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">condition_positive_delta_aboveground_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="c1">#// condition = (data[&quot;numPhase&quot;][j,:,:] &gt; 1) &amp; (data[&quot;deltaBiomasseAerienne&quot;][j,:,:] &gt;= 0)</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">condition</span>

<span class="k">def</span> <span class="nf">update_leaf_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_aboveground_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;pcReallocFeuille&quot;</span><span class="p">],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_stem_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition_positive_delta_aboveground_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;pcReallocFeuille&quot;</span><span class="p">])),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_aboveground_biomass_step_2</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">EvalFeuilleTigeSarrahV4</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function is a wrapper</span>

<span class="sd">    It is adapted from the EvalFeuilleTigeSarrahV4 procedure from the bilancarbonsarra.pas file</span>

<span class="sd">    of the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">        paramVariete (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># data[&quot;deltaBiomasseFeuilles&quot;][j:,:,:] = np.where(</span>

    <span class="c1">#     (data[&quot;numPhase&quot;][j,:,:] &gt; 1),</span>

    <span class="c1">#     data[&quot;biomasseFeuille&quot;][j,:,:],</span>

    <span class="c1">#     data[&quot;deltaBiomasseFeuilles&quot;][j,:,:],</span>

    <span class="c1"># )</span>

    <span class="c1"># if (data[&quot;numPhase&quot;][j,:,:] &gt; 1) &amp; (data[&quot;deltaBiomasseAerienne&quot;][j,:,:] &lt; 0)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_leaf_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_stem_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="c1"># if deltaBiomasseAerienne &gt;= 0 and (numPhase &lt;= 4 or numPhase &lt;= phaseDevVeg)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_bM_and_cM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_leaf_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_stem_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="c1"># if deltaBiomasseAerienne &gt; 0 and numPhase &gt; 1</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_leaf_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_stem_biomass_all_phases</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">)</span>

    <span class="c1"># condition = (data[&quot;numPhase&quot;][j,:,:] &gt; 1)</span>

    <span class="c1"># data[&quot;deltaBiomasseFeuilles&quot;][j:,:,:] = np.where(</span>

    <span class="c1">#     (data[&quot;numPhase&quot;][j,:,:] &gt; 1),</span>

    <span class="c1">#     data[&quot;biomasseFeuille&quot;][j,:,:] - data[&quot;deltaBiomasseFeuilles&quot;][j,:,:],</span>

    <span class="c1">#     data[&quot;deltaBiomasseFeuilles&quot;][j,:,:],</span>

    <span class="c1"># )</span>

    <span class="c1"># simpler formulation for updating the deltaBiomasseFeuilles</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">update_aboveground_biomass_step_2</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_vegetative_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    This function is adapted from the EvalBiomasseVegetati procedure from the copie milbilancarbon, exmodules 1 &amp; 2, ***milbilancarbone*** file</span>

<span class="sd">    of the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseVegetative&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">calculate_canopy_specific_leaf_area</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Calculate the specific leaf area (SLA) of the canopy.</span>

<span class="sd">    If the leaf biomass is positive, and if we are at the transition day between</span>

<span class="sd">    phases 1 and 2 (numPhase = 2 and changePhase = 1), then the SLA is set to</span>

<span class="sd">    `slaMax`.</span>

<span class="sd">    If the leaf biomass is positive and increasing (deltaBiomasseFeuilles is</span>

<span class="sd">    positive), the SLA for existing leaves is calculated by reducing it by an</span>

<span class="sd">    amount proportional to the current SLA, while the SLA for new leaves is</span>

<span class="sd">    calculated as the average between SLA and `slaMax`. The SLA for the entire</span>

<span class="sd">    canopy is then calculated as the weighted average of the SLAs for existing</span>

<span class="sd">    and new leaves.</span>

<span class="sd">    If there is no increase in leaf biomass (deltaBiomasseFeuilles is negative),</span>

<span class="sd">    only the SLA for existing leaves is calculated.</span>

<span class="sd">    If the leaf biomass is negative, the SLA is unchanged.</span>

<span class="sd">    The calculated SLA value is bounded between `slaMin` and `slaMax`.</span>

<span class="sd">    This function is adapted from the EvalSlaSarrahV3 procedure in the</span>

<span class="sd">    bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files of the original Pascal</span>

<span class="sd">    code.  This calculation method assumes that young leaves have a higher SLA</span>

<span class="sd">    than old leaves and that the fraction of young leaves makes the canopy SLA</span>

<span class="sd">    increase. The `penteSLA` parameter causes a general decrease in SLA</span>

<span class="sd">    (penteSLA = relative decrease per day = fraction of difference between</span>

<span class="sd">    `slaMax` and `slaMin`).</span>

<span class="sd">    Expected parameters:</span>

<span class="sd">    SLAmax [0.001, 0.01]</span>

<span class="sd">    SLAmin [0.001, 0.01]</span>

<span class="sd">    penteSLA [0, 0.2]</span>

<span class="sd">    SLAini = SLAmax</span>

<span class="sd">    This function estimates the specific leaf area (SLA) of the canopy.</span>

<span class="sd">    First, if the leaf biomass is positive, if numPhase = 2 and changePhase = 1,</span>

<span class="sd">    which means we are at the transition day between phases 1 and 2, sla is set</span>

<span class="sd">    to be equal to slaMax.</span>

<span class="sd">    Then, if the leaf biomass is positive, and if deltaBiomasseFeuilles is</span>

<span class="sd">    positive (meaning that the leaf biomass is increasing), SLA for already</span>

<span class="sd">    existing leaves is calculated by removing a value that is an affine function</span>

<span class="sd">    of SLA itself, and SLA for new leaves is calculated as the mean between SLA</span>

<span class="sd">    and slaMax ; then the SLA is calculated as the weighted mean of the two SLA</span>

<span class="sd">    values.</span>

<span class="sd">    Logically, if there is no newly produced leaf biomass (deltaBiomasseFeuilles</span>

<span class="sd">    is negative), only the SLA for already existing leaves is calculated.</span>

<span class="sd">    If biomasseFeuille is negative, SLA is unchanged.</span>

<span class="sd">    Finally, if biomasseFeuille is positive, SLA value is bounded between slaMin</span>

<span class="sd">    and slaMax.</span>

<span class="sd">    This function is adapted from the EvalSlaSarrahV3 procedure from the</span>

<span class="sd">    bilancarbonsarra.pas and  exmodules 1 &amp; 2.pas file of the original Pascal</span>

<span class="sd">    code.  We note that multiple versions of the calculation methods have been</span>

<span class="sd">    used in the original procecure. We may want to go back to that if this</span>

<span class="sd">    function is problematic.</span>

<span class="sd">    Notes :</span>

<span class="sd">    In this approach, it is assumed that young leaves have a higher SLA than old</span>

<span class="sd">    leaves. The fraction of young leaves makes the canopy SLA increase. The</span>

<span class="sd">    penteSLA parameter causes a general decrease in SLA (penteSLA = relative</span>

<span class="sd">    decrease per day = fraction of difference between SLAmax and SLAmin). This</span>

<span class="sd">    approach is known for legumes, but can also be adapted to other species.</span>

<span class="sd">    Generic/expected parameters :</span>

<span class="sd">    SLAmax [0.001, 0.01]</span>

<span class="sd">    SLAmin [0.001, 0.01]</span>

<span class="sd">    penteSLA [0, 0.2]</span>

<span class="sd">    SLAini = SLAmax</span>

<span class="sd">    Args:</span>

<span class="sd">    - j (int): The time step.</span>

<span class="sd">    - data (xarray.Dataset): The data for all variables.</span>

<span class="sd">    - paramVariete (dict): Parameters for the calculation.</span>

<span class="sd">    Returns:</span>

<span class="sd">    - data (xarray.Dataset): The updated data with the calculated SLA.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \

                <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> \

                <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="n">condition</span><span class="p">,</span>

        <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaMax&quot;</span><span class="p">],</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="n">ratio_old_leaf_biomass</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

    <span class="n">ratio_new_leaf_biomass</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span>

    <span class="n">sla_decrease_step</span> <span class="o">=</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaPente&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaMin&quot;</span><span class="p">])</span>

    <span class="c1"># Modif du 10/07/2018, DeltaBiomasse neg si reallocation ne pas fair l&#39;evol du SLA dans ces conditions</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1">#// (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaPente&quot;] * (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaMin&quot;])) * (data[&quot;biomasseFeuille&quot;][j,:,:] - data[&quot;deltaBiomasseFeuilles&quot;][j,:,:]) / data[&quot;biomasseFeuille&quot;][j,:,:] + (paramVariete[&quot;slaMax&quot;] + data[&quot;sla&quot;][j,:,:])/2 * (data[&quot;deltaBiomasseFeuilles&quot;][j,:,:] / data[&quot;biomasseFeuille&quot;][j,:,:]),</span>

            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">sla_decrease_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio_old_leaf_biomass</span> <span class="o">+</span> <span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaMax&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ratio_new_leaf_biomass</span><span class="p">,</span>

            <span class="c1">#//(data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaPente&quot;] * (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaMin&quot;])) * (data[&quot;biomasseFeuille&quot;][j,:,:] / data[&quot;biomasseFeuille&quot;][j,:,:]),</span>

            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">sla_decrease_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio_old_leaf_biomass</span><span class="p">,</span>

        <span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>

        <span class="c1">#// np.minimum(paramVariete[&quot;slaMin&quot;], np.maximum(paramVariete[&quot;slaMax&quot;], data[&quot;sla&quot;][j,:,:])), # according to original</span>

        <span class="c1"># according to ocelet version</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">minimum</span><span class="p">(</span>

            <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaMax&quot;</span><span class="p">],</span>

            <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

                <span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;slaMin&quot;</span><span class="p">],</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

            <span class="p">),</span>

        <span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">calculate_leaf_area_index</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Calculate the leaf area index (LAI) for a given time step.</span>

<span class="sd">    If the number of growth phase (numPhase) is less than or equal to 1, the LAI is set to 0.</span>

<span class="sd">    If the number of growth phase is between 2 and 6, the LAI is calculated as the product of</span>

<span class="sd">    the leaf biomass (biomasseFeuille) and specific leaf area (sla).</span>

<span class="sd">    If the number of growth phase is greater than 6, the LAI is set back to 0.</span>

<span class="sd">    This function is adapted from the EvolLAIPhases procedure from the</span>

<span class="sd">    milbilancarbone.pas and exmodules 1 &amp; 2.pas file of the original Pascal</span>

<span class="sd">    code.</span>

<span class="sd">    Args:</span>

<span class="sd">        timestep (int): The time step to calculate the LAI for.</span>

<span class="sd">        data (xarray.Dataset): The xarray dataset that contains the relevant data.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated xarray dataset with the calculated LAI.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">,</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

            <span class="mi">0</span><span class="p">,</span>

        <span class="p">)</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">update_yield_during_filling_phase</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates the yield value during the filling phase.</span>

<span class="sd">    During the filling phase (numPhase == 5), the yield is updated by</span>

<span class="sd">    incrementing it with the sum of `deltaBiomasseAerienne` and `reallocation`,</span>

<span class="sd">    bounded by 0 and `dRdtPot` (daily potential yield). The construction of yield</span>

<span class="sd">    is done during phase 5 only, from the variation of aerial biomass and</span>

<span class="sd">    reallocation, with a maximum of `dRdtPot`.</span>

<span class="sd">    This function is adapted from the EvolDayRdtSarraV3 procedure from the</span>

<span class="sd">    ***bilancarbonesarra***, exmodules 1 &amp; 2.pas file of the original Pascal</span>

<span class="sd">    code.</span>

<span class="sd">    Notes :</span>

<span class="sd">    On tend vers le potentiel en fn du rapport des degresJours/sumDegresJours</span>

<span class="sd">    pour la phase de remplissage. Frein sup fn du flux de sève estimé par le</span>

<span class="sd">    rapport Tr/TrPot.</span>

<span class="sd">    dRdtPot = RdtPotDuJour</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The time step at which the calculation starts.</span>

<span class="sd">        data (xarray.Dataset): The data that contains all variables.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The input data with updated yield values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span>

        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">minimum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>  <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;reallocation&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">BiomDensiteSarraV42</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">,</span> <span class="n">paramVariete</span><span class="p">):</span>

    <span class="c1"># depuis bilancarbonsarra.pas</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;densOpti&quot;</span><span class="p">]):</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">])</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">])</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">])</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">])</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">])</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span>

        <span class="c1">#? conflit avec fonction evolLAIphase ?</span>

        <span class="c1">#data[&quot;lai&quot;][j:,:,:]  = data[&quot;biomasseFeuille&quot;][j,:,:] * data[&quot;sla&quot;][j,:,:]</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lai&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span>  <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rapDensite&quot;</span><span class="p">]</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

        <span class="c1">#data[&quot;biomasseTotale&quot;][j:,:,:] = data[&quot;biomasseTotale&quot;][j:,:,:] / data[&quot;rapDensite&quot;]</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">BiomMcUBTSV3</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">paramITK</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    depuis bilancarbonsarra.pas</span>

<span class="sd">    group 174</span>

<span class="sd">    Pendant la croissance des cultures la d�gradation des r�sidusest calcul�e sans les UBT</span>

<span class="sd">    Ici c&#39;est pendant la saion s�che quand il n&#39;y a des cultures pas de b�tes.</span>

<span class="sd">    Sur le mulch dress� (Up) ou couch� Lit), on calcul sa d�gradation journali�re</span>

<span class="sd">    sur les feuilles et les tiges en fn de coef KN (climat, termites...),</span>

<span class="sd">    KI ingestion par les b�tes pression en UBT seulement pour les feuilles, KT (effet pi�tinement) qui va faire passer</span>

<span class="sd">    du stade lev� en couch� et du stade couch� en ensevelissement pression en UBT</span>

<span class="sd">    Par D�faut :</span>

<span class="sd">    KNUp = 0.001 /jour</span>

<span class="sd">    KNLit = 0.011</span>

<span class="sd">    KN est soit une constante soit peut varier en fn climat (pas fait ref STEP)</span>

<span class="sd">    KT = 0.003</span>

<span class="sd">    KI = 0.005</span>

<span class="sd">    NbUBT = 10 (zone Fakara)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1">#   group 161</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;NbUBT&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1">#  group 162</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 163</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 164</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 165</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 166</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1">#// D�gradation des feuilles et tiges dress�es</span>

    <span class="c1"># FeuilleUp := max(0, (FeuilleUp -  FeuilleUp * KNUp - FeuilleUp * KI * UBTCulture  - FeuilleUp * KT * UBTCulture));</span>

    <span class="c1"># group 167</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNUp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> \

            <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 168</span>

    <span class="c1"># TigeUp := max(0, (TigeUp -  TigeUp * KNUp - TigeUp * KT * UBTCulture));</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNUp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1">#// D�gradation des feuilles et tiges couch�es (liti�re)</span>

    <span class="c1"># group 169</span>

    <span class="c1"># LitFeuille :=  max(0, (LitFeuille -  LitFeuille * KNLit - LitFeuille * KI * UBTCulture  - LitFeuille * KT * UBTCulture));</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNLit&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span> \

            <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 170</span>

    <span class="c1"># LitTige :=  max(0, (LitTige -  LitTige * KNLit - LitTige * KT * UBTCulture));</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>

        <span class="mi">0</span><span class="p">,</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNLit&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span>

    <span class="p">)</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># group 171</span>

    <span class="c1">#BiomMc := LitFeuille + LitTige;</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># #// transfert dress� � liti�re effet pi�tinement</span>

    <span class="c1"># LitFeuille :=  LitFeuille + FeuilleUp * KT * UBTCulture;</span>

    <span class="c1"># group 172</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># LitTige :=  LitTige + TigeUp * KT * UBTCulture;</span>

    <span class="c1"># group 173</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span>

    <span class="c1"># // le 01/03 on consid�re que toutes les pailles et feuilles dressees sont couchees</span>

    <span class="c1">#       if (trunc(DayOfTheYear(DateEnCours)) = 61) then</span>

    <span class="c1">#   begin</span>

    <span class="c1">#     LitFeuille :=  LitFeuille + FeuilleUp;</span>

    <span class="c1">#     LitTige :=  LitTige + TigeUp;</span>

    <span class="c1">#     FeuilleUp :=  0;</span>

    <span class="c1">#     TigeUp :=  0;</span>

    <span class="c1">#     BiomMc := LitFeuille + LitTige;</span>

    <span class="c1">#  end;</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">MAJBiomMcSV3</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    groupe 182</span>

<span class="sd"> A la Recolte, on calcul la part des biomasses qui restent sur place (Up), non r�colt�es</span>

<span class="sd"> et la part qui est mise � terre (Liti�re) sur ce qui est laiss� sur place</span>

<span class="sd"> On met a jour aussi la biomasse des liti�res pour les calculs effet mulch sue lr bilan hydrique</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1">#         if (NumPhase =7) then</span>

<span class="c1">#     begin</span>

        <span class="c1"># groupe 175</span>

<span class="c1">#       FeuilleUp := FeuilleUp +  BiomasseFeuilles * (1-TxRecolte);</span>

        <span class="c1"># groupe 176</span>

<span class="c1">#       TigeUp := TigeUp + BiomasseTiges *  (1-TxRecolte);</span>

        <span class="c1"># groupe 177</span>

<span class="c1">#       LitFeuille := LitFeuille + FeuilleUp * TxaTerre;</span>

        <span class="c1"># groupe 178</span>

<span class="c1">#       LitTige := LitTige + TigeUp * TxaTerre;</span>

        <span class="c1"># groupe 179</span>

<span class="c1">#       FeuilleUp := FeuilleUp * (1-TxaTerre);</span>

        <span class="c1"># groupe 180</span>

<span class="c1">#       TigeUp := TigeUp * (1-TxaTerre);</span>

<span class="c1"># //      LitTige := LitTige + BiomMc;</span>

        <span class="c1"># groupe 181</span>

<span class="c1">#       BiomMC := LitFeuille + LitTige;</span>

<span class="c1">#  {     BiomasseFeuilles := 0;</span>

<span class="c1">#       BiomasseTiges := 0;</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">estimate_critical_nitrogen_concentration</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="c1"># estimate critical nitrogen concentration from plant dry matter using the Justes et al (1994) relationship</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ncrit&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mf">5.35</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.44</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

</details>
<h2 id="functions">Functions</h2>
<h3 id="biomdensoptsarrav4">BiomDensOptSarraV4</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">BiomDensOptSarraV4</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramITK</span>
<span class="p">)</span>
</code></pre></div>

<p>si densité plus faible alors on considére qu'il faut augmenter les biomasses, LAI etc</p>
<p>en regard de cette situation au niveau de chaque plante (car tout est rapporté é des kg/ha).
Si elle est plus forte on ne change rien pour lors.
Valeur fixe en ref au maés é déf en paramétre par variétésé rapDensite := Max(1, 70000/densite);</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">BiomDensOptSarraV4</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    si densité plus faible alors on considére qu&#39;il faut augmenter les biomasses, LAI etc</span>

<span class="sd">    en regard de cette situation au niveau de chaque plante (car tout est rapporté é des kg/ha).</span>

<span class="sd">    Si elle est plus forte on ne change rien pour lors.</span>

<span class="sd">    Valeur fixe en ref au maés é déf en paramétre par variétésé rapDensite := Max(1, 70000/densite);</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    if ~np.isnan(paramVariete[&quot;densOpti&quot;]) :</span>

<span class="sd">        paramITK[&quot;rapDensite&quot;] = np.maximum(1,paramVariete[&quot;densOpti&quot;]/paramITK[&quot;densite&quot;])</span>

<span class="sd">        data[&quot;rdt&quot;][j,:,:] = data[&quot;rdt&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseRacinaire&quot;][j,:,:] = data[&quot;biomasseRacinaire&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseTige&quot;][j,:,:] = data[&quot;biomasseTige&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseFeuille&quot;][j,:,:] = data[&quot;biomasseFeuille&quot;][j,:,:] * paramITK[&quot;rapDensite&quot;]</span>

<span class="sd">        data[&quot;biomasseAerienne&quot;][j,:,:] = data[&quot;biomasseTige&quot;][j,:,:] + data[&quot;biomasseFeuille&quot;][j,:,:] + data[&quot;rdt&quot;][j,:,:]</span>

<span class="sd">        data[&quot;lai&quot;][j,:,:]  = data[&quot;biomasseFeuille&quot;][j,:,:] * data[&quot;sla&quot;][j,:,:]</span>

<span class="sd">        data[&quot;biomasseTotale&quot;][j,:,:] = data[&quot;biomasseAerienne&quot;][j,:,:] + data[&quot;biomasseRacinaire&quot;][j,:,:]</span>

<span class="sd">    return data</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="biomdensitesarrav42">BiomDensiteSarraV42</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">BiomDensiteSarraV42</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramITK</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">BiomDensiteSarraV42</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramITK</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    # <span class="nv">depuis</span> <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span>

    <span class="k">if</span> <span class="o">~</span><span class="nv">np</span>.<span class="nv">isnan</span><span class="ss">(</span><span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">densOpti</span><span class="s2">&quot;</span>]<span class="ss">)</span>:

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]<span class="ss">)</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdtPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdtPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]<span class="ss">)</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseRacinaire</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseRacinaire</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]<span class="ss">)</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]<span class="ss">)</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]<span class="ss">)</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span>

        #? <span class="nv">conflit</span> <span class="nv">avec</span> <span class="nv">fonction</span> <span class="nv">evolLAIphase</span> ?

        #<span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">lai</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:]  <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">sla</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">lai</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:]  <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">lai</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:]  <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTotale</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseRacinaire</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span>#[...,<span class="nv">np</span>.<span class="nv">newaxis</span>]

        #<span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTotale</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTotale</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rapDensite</span><span class="s2">&quot;</span>]

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="biommcubtsv3">BiomMcUBTSV3</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">BiomMcUBTSV3</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramITK</span>
<span class="p">)</span>
</code></pre></div>

<p>depuis bilancarbonsarra.pas</p>
<p>group 174</p>
<p>Pendant la croissance des cultures la d�gradation des r�sidusest calcul�e sans les UBT
Ici c'est pendant la saion s�che quand il n'y a des cultures pas de b�tes.
Sur le mulch dress� (Up) ou couch� Lit), on calcul sa d�gradation journali�re
sur les feuilles et les tiges en fn de coef KN (climat, termites...),
KI ingestion par les b�tes pression en UBT seulement pour les feuilles, KT (effet pi�tinement) qui va faire passer
du stade lev� en couch� et du stade couch� en ensevelissement pression en UBT
Par D�faut :
KNUp = 0.001 /jour
KNLit = 0.011
KN est soit une constante soit peut varier en fn climat (pas fait ref STEP)
KT = 0.003
KI = 0.005
NbUBT = 10 (zone Fakara)</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">BiomMcUBTSV3</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    depuis bilancarbonsarra.pas</span>

<span class="sd">    group 174</span>

<span class="sd">    Pendant la croissance des cultures la d�gradation des r�sidusest calcul�e sans les UBT</span>

<span class="sd">    Ici c&#39;est pendant la saion s�che quand il n&#39;y a des cultures pas de b�tes.</span>

<span class="sd">    Sur le mulch dress� (Up) ou couch� Lit), on calcul sa d�gradation journali�re</span>

<span class="sd">    sur les feuilles et les tiges en fn de coef KN (climat, termites...),</span>

<span class="sd">    KI ingestion par les b�tes pression en UBT seulement pour les feuilles, KT (effet pi�tinement) qui va faire passer</span>

<span class="sd">    du stade lev� en couch� et du stade couch� en ensevelissement pression en UBT</span>

<span class="sd">    Par D�faut :</span>

<span class="sd">    KNUp = 0.001 /jour</span>

<span class="sd">    KNLit = 0.011</span>

<span class="sd">    KN est soit une constante soit peut varier en fn climat (pas fait ref STEP)</span>

<span class="sd">    KT = 0.003</span>

<span class="sd">    KI = 0.005</span>

<span class="sd">    NbUBT = 10 (zone Fakara)</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">#   group 161</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;NbUBT&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1">#  group 162</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 163</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 164</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 165</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 166</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1">#// D�gradation des feuilles et tiges dress�es</span><span class="w"></span>

<span class="w">    </span><span class="c1"># FeuilleUp := max(0, (FeuilleUp -  FeuilleUp * KNUp - FeuilleUp * KI * UBTCulture  - FeuilleUp * KT * UBTCulture));</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 167</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNUp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span>\<span class="w"></span>

<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 168</span><span class="w"></span>

<span class="w">    </span><span class="c1"># TigeUp := max(0, (TigeUp -  TigeUp * KNUp - TigeUp * KT * UBTCulture));</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNUp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1">#// D�gradation des feuilles et tiges couch�es (liti�re)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 169</span><span class="w"></span>

<span class="w">    </span><span class="c1"># LitFeuille :=  max(0, (LitFeuille -  LitFeuille * KNLit - LitFeuille * KI * UBTCulture  - LitFeuille * KT * UBTCulture));</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNLit&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span><span class="w"> </span>\<span class="w"></span>

<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 170</span><span class="w"></span>

<span class="w">    </span><span class="c1"># LitTige :=  max(0, (LitTige -  LitTige * KNLit - LitTige * KT * UBTCulture));</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KNLit&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 171</span><span class="w"></span>

<span class="w">    </span><span class="c1">#BiomMc := LitFeuille + LitTige;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomMc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># #// transfert dress� � liti�re effet pi�tinement</span><span class="w"></span>

<span class="w">    </span><span class="c1"># LitFeuille :=  LitFeuille + FeuilleUp * KT * UBTCulture;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 172</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># LitTige :=  LitTige + TigeUp * KT * UBTCulture;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 173</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LitTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TigeUp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;KT&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="c1">#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># // le 01/03 on consid�re que toutes les pailles et feuilles dressees sont couchees</span><span class="w"></span>

<span class="w">    </span><span class="c1">#       if (trunc(DayOfTheYear(DateEnCours)) = 61) then</span><span class="w"></span>

<span class="w">    </span><span class="c1">#   begin</span><span class="w"></span>

<span class="w">    </span><span class="c1">#     LitFeuille :=  LitFeuille + FeuilleUp;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#     LitTige :=  LitTige + TigeUp;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#     FeuilleUp :=  0;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#     TigeUp :=  0;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#     BiomMc := LitFeuille + LitTige;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#  end;</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="evalassimsarrahv4">EvalAssimSarrahV4</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">EvalAssimSarrahV4</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>data["parIntercepte"][j,:,:] = 0.5 * (1 - data["ltr"][j,:,:]) * data["rg"][j,:,:]</p>
<p>data["assimPot"][j:,:,:] = data["parIntercepte"][j,:,:] * data["conv"][j,:,:] * 10</p>
<p>data["assim"][j,:,:] = np.where(
    data["trPot"][j,:,:] &gt; 0,
    data["assimPot"][j,:,:] * data["tr"][j,:,:] / data["trPot"][j,:,:],
    0,
)</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">EvalAssimSarrahV4</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">parIntercepte</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="mi">0</span>.<span class="mi">5</span> <span class="o">*</span> <span class="ss">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">ltr</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span> <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rg</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">assimPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">parIntercepte</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">conv</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="mi">10</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">assim</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">trPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">0</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">assimPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">tr</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">trPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

        <span class="mi">0</span>,

    <span class="ss">)</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="evalfeuilletigesarrahv4">EvalFeuilleTigeSarrahV4</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">EvalFeuilleTigeSarrahV4</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function is a wrapper</p>
<p>It is adapted from the EvalFeuilleTigeSarrahV4 procedure from the bilancarbonsarra.pas file
of the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">EvalFeuilleTigeSarrahV4</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">wrapper</span>

    <span class="nv">It</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalFeuilleTigeSarrahV4</span> <span class="nv">procedure</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span> <span class="nv">file</span>

    <span class="nv">of</span> <span class="nv">the</span> <span class="nv">original</span> <span class="nv">Pascal</span> <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">paramVariete</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    # <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

    #     <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span>,

    #     <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    #     <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    # <span class="ss">)</span>

    # <span class="k">if</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;</span> <span class="mi">0</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_leaf_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_stem_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    # <span class="k">if</span> <span class="nv">deltaBiomasseAerienne</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="nv">and</span> <span class="ss">(</span><span class="nv">numPhase</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="nv">or</span> <span class="nv">numPhase</span> <span class="o">&lt;=</span> <span class="nv">phaseDevVeg</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_bM_and_cM</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_leaf_biomass_positive_delta_aboveground_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_stem_biomass_positive_delta_aboveground_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    # <span class="k">if</span> <span class="nv">deltaBiomasseAerienne</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="nv">and</span> <span class="nv">numPhase</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_leaf_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_stem_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>

    # <span class="nv">condition</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span>

    # <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

    #     <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span>,

    #     <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    #     <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    # <span class="ss">)</span>

    # <span class="nv">simpler</span> <span class="nv">formulation</span> <span class="k">for</span> <span class="nv">updating</span> <span class="nv">the</span> <span class="nv">deltaBiomasseFeuilles</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseFeuilles</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span><span class="o">-</span><span class="mi">1</span>,:,:]

    <span class="nv">data</span> <span class="o">=</span> <span class="nv">update_aboveground_biomass_step_2</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="majbiommcsv3">MAJBiomMcSV3</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">MAJBiomMcSV3</span><span class="p">(</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>groupe 182</p>
<p>A la Recolte, on calcul la part des biomasses qui restent sur place (Up), non r�colt�es
et la part qui est mise � terre (Liti�re) sur ce qui est laiss� sur place
On met a jour aussi la biomasse des liti�res pour les calculs effet mulch sue lr bilan hydrique</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span><span class="w"> </span><span class="nf">MAJBiomMcSV3</span><span class="p">(</span><span class="nv">data</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="s">    groupe 182</span>

<span class="s"> A la Recolte, on calcul la part des biomasses qui restent sur place (Up), non r�colt�es</span>

<span class="s"> et la part qui est mise � terre (Liti�re) sur ce qui est laiss� sur place</span>

<span class="s"> On met a jour aussi la biomasse des liti�res pour les calculs effet mulch sue lr bilan hydrique</span>

<span class="s">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="o">#</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">NumPhase</span><span class="w"> </span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>

<span class="o">#</span><span class="w">     </span><span class="nv">begin</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">175</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">FeuilleUp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">FeuilleUp</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="nv">BiomasseFeuilles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">TxRecolte</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">176</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">TigeUp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">TigeUp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">BiomasseTiges</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">TxRecolte</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">177</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">LitFeuille</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">LitFeuille</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">FeuilleUp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">TxaTerre</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">178</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">LitTige</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">LitTige</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">TigeUp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">TxaTerre</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">179</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">FeuilleUp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">FeuilleUp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">TxaTerre</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">180</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">TigeUp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">TigeUp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">TxaTerre</span><span class="p">);</span><span class="w"></span>

<span class="o">#</span><span class="w"> </span><span class="o">//</span><span class="w">      </span><span class="nv">LitTige</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">LitTige</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">BiomMc</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="o">#</span><span class="w"> </span><span class="nv">groupe</span><span class="w"> </span><span class="mi">181</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">BiomMC</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">LitFeuille</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">LitTige</span><span class="p">;</span><span class="w"></span>

<span class="o">#</span><span class="w">  </span><span class="p">{</span><span class="w">     </span><span class="nv">BiomasseFeuilles</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="o">#</span><span class="w">       </span><span class="nv">BiomasseTiges</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nv">return</span><span class="w"> </span><span class="nv">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="adjust_for_sowing_density">adjust_for_sowing_density</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">adjust_for_sowing_density</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span><span class="p">,</span>
    <span class="n">direction</span>
<span class="p">)</span>
</code></pre></div>

<p>This function translates the effect of sowing density on biomass and LAI.</p>
<p>This function is adapted from the BiomDensOptSarV42 and BiomDensiteSarraV42
procedures, from the bilancarbonsarra.pas original Pascal code.</p>
<p>Notes from CB : 
if density is lower than the optimal density, then we consider that we need
to increase the biomass, LAI etc in regard of this situation at each plant
level (because everything is related to kg/ha). If it is higher, it
increases asymptotically.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramITK</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">adjust_for_sowing_density</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">translates</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">effect</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">sowing</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">biomass</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">LAI</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">adapted</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BiomDensOptSarV42</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">BiomDensiteSarraV42</span><span class="w"></span>

<span class="w">    </span><span class="n">procedures</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bilancarbonsarra</span><span class="p">.</span><span class="n">pas</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">Pascal</span><span class="w"> </span><span class="n">code</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="n">Notes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">CB</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">optimal</span><span class="w"> </span><span class="n">density</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">consider</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">need</span><span class="w"></span>

<span class="w">    </span><span class="n">to</span><span class="w"> </span><span class="n">increase</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">biomass</span><span class="p">,</span><span class="w"> </span><span class="n">LAI</span><span class="w"> </span><span class="n">etc</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">regard</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">situation</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">plant</span><span class="w"></span>

<span class="w">    </span><span class="n">level</span><span class="w"> </span><span class="p">(</span><span class="n">because</span><span class="w"> </span><span class="n">everything</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">related</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">kg</span><span class="o">/</span><span class="n">ha</span><span class="p">).</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">higher</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"></span>

<span class="w">    </span><span class="n">increases</span><span class="w"> </span><span class="n">asymptotically</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="nl">Args:</span><span class="w"></span>

<span class="w">        </span><span class="n">j</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">        </span><span class="n">paramITK</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">    </span><span class="nl">Returns:</span><span class="w"></span>

<span class="w">        </span><span class="nl">_type_:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;in&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s">&quot;densOpti&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdtPot&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;lai&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;out&quot;</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s">&quot;densOpti&quot;</span><span class="p">])</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdtPot&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTige&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rdt&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])</span><span class="w"></span>

<span class="w">            </span><span class="p">#</span><span class="o">?</span><span class="w"> </span><span class="n">conflit</span><span class="w"> </span><span class="n">avec</span><span class="w"> </span><span class="n">fonction</span><span class="w"> </span><span class="n">evolLAIphase</span><span class="w"> </span><span class="o">?</span><span class="w"></span>

<span class="w">            </span><span class="p">#</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;lai&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;sla&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;lai&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;lai&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w">  </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">])#[...,</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span><span class="w"></span>

<span class="w">            </span><span class="p">#</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="nl">j:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="calculate_canopy_specific_leaf_area">calculate_canopy_specific_leaf_area</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_canopy_specific_leaf_area</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Calculate the specific leaf area (SLA) of the canopy.</p>
<p>If the leaf biomass is positive, and if we are at the transition day between
phases 1 and 2 (numPhase = 2 and changePhase = 1), then the SLA is set to
<code>slaMax</code>. </p>
<p>If the leaf biomass is positive and increasing (deltaBiomasseFeuilles is
positive), the SLA for existing leaves is calculated by reducing it by an
amount proportional to the current SLA, while the SLA for new leaves is
calculated as the average between SLA and <code>slaMax</code>. The SLA for the entire
canopy is then calculated as the weighted average of the SLAs for existing
and new leaves.</p>
<p>If there is no increase in leaf biomass (deltaBiomasseFeuilles is negative),
only the SLA for existing leaves is calculated.</p>
<p>If the leaf biomass is negative, the SLA is unchanged.</p>
<p>The calculated SLA value is bounded between <code>slaMin</code> and <code>slaMax</code>.</p>
<p>This function is adapted from the EvalSlaSarrahV3 procedure in the
bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files of the original Pascal
code.  This calculation method assumes that young leaves have a higher SLA
than old leaves and that the fraction of young leaves makes the canopy SLA
increase. The <code>penteSLA</code> parameter causes a general decrease in SLA
(penteSLA = relative decrease per day = fraction of difference between 
<code>slaMax</code> and <code>slaMin</code>).</p>
<p>Expected parameters:
SLAmax [0.001, 0.01]
SLAmin [0.001, 0.01]
penteSLA [0, 0.2]
SLAini = SLAmax</p>
<p>This function estimates the specific leaf area (SLA) of the canopy.</p>
<p>First, if the leaf biomass is positive, if numPhase = 2 and changePhase = 1,
which means we are at the transition day between phases 1 and 2, sla is set
to be equal to slaMax.</p>
<p>Then, if the leaf biomass is positive, and if deltaBiomasseFeuilles is
positive (meaning that the leaf biomass is increasing), SLA for already
existing leaves is calculated by removing a value that is an affine function
of SLA itself, and SLA for new leaves is calculated as the mean between SLA
and slaMax ; then the SLA is calculated as the weighted mean of the two SLA
values.</p>
<p>Logically, if there is no newly produced leaf biomass (deltaBiomasseFeuilles
is negative), only the SLA for already existing leaves is calculated.</p>
<p>If biomasseFeuille is negative, SLA is unchanged.</p>
<p>Finally, if biomasseFeuille is positive, SLA value is bounded between slaMin
and slaMax.</p>
<p>This function is adapted from the EvalSlaSarrahV3 procedure from the
bilancarbonsarra.pas and  exmodules 1 &amp; 2.pas file of the original Pascal
code.  We note that multiple versions of the calculation methods have been
used in the original procecure. We may want to go back to that if this
function is problematic.</p>
<p>Notes :
In this approach, it is assumed that young leaves have a higher SLA than old
leaves. The fraction of young leaves makes the canopy SLA increase. The
penteSLA parameter causes a general decrease in SLA (penteSLA = relative
decrease per day = fraction of difference between SLAmax and SLAmin). This
approach is known for legumes, but can also be adapted to other species.</p>
<p>Generic/expected parameters :
SLAmax [0.001, 0.01]
SLAmin [0.001, 0.01]
penteSLA [0, 0.2]
SLAini = SLAmax</p>
<p>Args:
- j (int): The time step.
- data (xarray.Dataset): The data for all variables.
- paramVariete (dict): Parameters for the calculation.</p>
<p>Returns:
- data (xarray.Dataset): The updated data with the calculated SLA.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">calculate_canopy_specific_leaf_area</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Calculate the specific leaf area (SLA) of the canopy.</span>

<span class="s2">    If the leaf biomass is positive, and if we are at the transition day between</span>

<span class="s2">    phases 1 and 2 (numPhase = 2 and changePhase = 1), then the SLA is set to</span>

<span class="s2">    `slaMax`.</span>

<span class="s2">    If the leaf biomass is positive and increasing (deltaBiomasseFeuilles is</span>

<span class="s2">    positive), the SLA for existing leaves is calculated by reducing it by an</span>

<span class="s2">    amount proportional to the current SLA, while the SLA for new leaves is</span>

<span class="s2">    calculated as the average between SLA and `slaMax`. The SLA for the entire</span>

<span class="s2">    canopy is then calculated as the weighted average of the SLAs for existing</span>

<span class="s2">    and new leaves.</span>

<span class="s2">    If there is no increase in leaf biomass (deltaBiomasseFeuilles is negative),</span>

<span class="s2">    only the SLA for existing leaves is calculated.</span>

<span class="s2">    If the leaf biomass is negative, the SLA is unchanged.</span>

<span class="s2">    The calculated SLA value is bounded between `slaMin` and `slaMax`.</span>

<span class="s2">    This function is adapted from the EvalSlaSarrahV3 procedure in the</span>

<span class="s2">    bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files of the original Pascal</span>

<span class="s2">    code.  This calculation method assumes that young leaves have a higher SLA</span>

<span class="s2">    than old leaves and that the fraction of young leaves makes the canopy SLA</span>

<span class="s2">    increase. The `penteSLA` parameter causes a general decrease in SLA</span>

<span class="s2">    (penteSLA = relative decrease per day = fraction of difference between</span>

<span class="s2">    `slaMax` and `slaMin`).</span>

<span class="s2">    Expected parameters:</span>

<span class="s2">    SLAmax [0.001, 0.01]</span>

<span class="s2">    SLAmin [0.001, 0.01]</span>

<span class="s2">    penteSLA [0, 0.2]</span>

<span class="s2">    SLAini = SLAmax</span>

<span class="s2">    This function estimates the specific leaf area (SLA) of the canopy.</span>

<span class="s2">    First, if the leaf biomass is positive, if numPhase = 2 and changePhase = 1,</span>

<span class="s2">    which means we are at the transition day between phases 1 and 2, sla is set</span>

<span class="s2">    to be equal to slaMax.</span>

<span class="s2">    Then, if the leaf biomass is positive, and if deltaBiomasseFeuilles is</span>

<span class="s2">    positive (meaning that the leaf biomass is increasing), SLA for already</span>

<span class="s2">    existing leaves is calculated by removing a value that is an affine function</span>

<span class="s2">    of SLA itself, and SLA for new leaves is calculated as the mean between SLA</span>

<span class="s2">    and slaMax ; then the SLA is calculated as the weighted mean of the two SLA</span>

<span class="s2">    values.</span>

<span class="s2">    Logically, if there is no newly produced leaf biomass (deltaBiomasseFeuilles</span>

<span class="s2">    is negative), only the SLA for already existing leaves is calculated.</span>

<span class="s2">    If biomasseFeuille is negative, SLA is unchanged.</span>

<span class="s2">    Finally, if biomasseFeuille is positive, SLA value is bounded between slaMin</span>

<span class="s2">    and slaMax.</span>

<span class="s2">    This function is adapted from the EvalSlaSarrahV3 procedure from the</span>

<span class="s2">    bilancarbonsarra.pas and  exmodules 1 &amp; 2.pas file of the original Pascal</span>

<span class="s2">    code.  We note that multiple versions of the calculation methods have been</span>

<span class="s2">    used in the original procecure. We may want to go back to that if this</span>

<span class="s2">    function is problematic.</span>

<span class="s2">    Notes :</span>

<span class="s2">    In this approach, it is assumed that young leaves have a higher SLA than old</span>

<span class="s2">    leaves. The fraction of young leaves makes the canopy SLA increase. The</span>

<span class="s2">    penteSLA parameter causes a general decrease in SLA (penteSLA = relative</span>

<span class="s2">    decrease per day = fraction of difference between SLAmax and SLAmin). This</span>

<span class="s2">    approach is known for legumes, but can also be adapted to other species.</span>

<span class="s2">    Generic/expected parameters :</span>

<span class="s2">    SLAmax [0.001, 0.01]</span>

<span class="s2">    SLAmin [0.001, 0.01]</span>

<span class="s2">    penteSLA [0, 0.2]</span>

<span class="s2">    SLAini = SLAmax</span>

<span class="s2">    Args:</span>

<span class="s2">    - j (int): The time step.</span>

<span class="s2">    - data (xarray.Dataset): The data for all variables.</span>

<span class="s2">    - paramVariete (dict): Parameters for the calculation.</span>

<span class="s2">    Returns:</span>

<span class="s2">    - data (xarray.Dataset): The updated data with the calculated SLA.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">                </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">                </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;changePhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="k">condition</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaMax&quot;</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">ratio_old_leaf_biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"></span>

<span class="w">    </span><span class="n">ratio_new_leaf_biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"></span>

<span class="w">    </span><span class="n">sla_decrease_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaPente&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaMin&quot;</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Modif du 10/07/2018, DeltaBiomasse neg si reallocation ne pas fair l&#39;evol du SLA dans ces conditions</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="c1">#// (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaPente&quot;] * (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaMin&quot;])) * (data[&quot;biomasseFeuille&quot;][j,:,:] - data[&quot;deltaBiomasseFeuilles&quot;][j,:,:]) / data[&quot;biomasseFeuille&quot;][j,:,:] + (paramVariete[&quot;slaMax&quot;] + data[&quot;sla&quot;][j,:,:])/2 * (data[&quot;deltaBiomasseFeuilles&quot;][j,:,:] / data[&quot;biomasseFeuille&quot;][j,:,:]),</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sla_decrease_step</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_old_leaf_biomass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaMax&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_new_leaf_biomass</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="c1">#//(data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaPente&quot;] * (data[&quot;sla&quot;][j,:,:] - paramVariete[&quot;slaMin&quot;])) * (data[&quot;biomasseFeuille&quot;][j,:,:] / data[&quot;biomasseFeuille&quot;][j,:,:]),</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sla_decrease_step</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_old_leaf_biomass</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="c1">#// np.minimum(paramVariete[&quot;slaMin&quot;], np.maximum(paramVariete[&quot;slaMax&quot;], data[&quot;sla&quot;][j,:,:])), # according to original</span><span class="w"></span>

<span class="w">        </span><span class="c1"># according to ocelet version</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="p">.</span><span class="n">minimum</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaMax&quot;</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;slaMin&quot;</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sla&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="calculate_leaf_area_index">calculate_leaf_area_index</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_leaf_area_index</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>Calculate the leaf area index (LAI) for a given time step.</p>
<p>If the number of growth phase (numPhase) is less than or equal to 1, the LAI is set to 0. 
If the number of growth phase is between 2 and 6, the LAI is calculated as the product of 
the leaf biomass (biomasseFeuille) and specific leaf area (sla). 
If the number of growth phase is greater than 6, the LAI is set back to 0.</p>
<p>This function is adapted from the EvolLAIPhases procedure from the
milbilancarbone.pas and exmodules 1 &amp; 2.pas file of the original Pascal
code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>timestep</td>
<td>int</td>
<td>The time step to calculate the LAI for.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The xarray dataset that contains the relevant data.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated xarray dataset with the calculated LAI.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">calculate_leaf_area_index</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">Calculate</span> <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">area</span> <span class="nv">index</span> <span class="ss">(</span><span class="nv">LAI</span><span class="ss">)</span> <span class="k">for</span> <span class="nv">a</span> <span class="nv">given</span> <span class="nv">time</span> <span class="nv">step</span>.

    <span class="k">If</span> <span class="nv">the</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">growth</span> <span class="nv">phase</span> <span class="ss">(</span><span class="nv">numPhase</span><span class="ss">)</span> <span class="nv">is</span> <span class="nv">less</span> <span class="nv">than</span> <span class="nv">or</span> <span class="nv">equal</span> <span class="nv">to</span> <span class="mi">1</span>, <span class="nv">the</span> <span class="nv">LAI</span> <span class="nv">is</span> <span class="nv">set</span> <span class="nv">to</span> <span class="mi">0</span>.

    <span class="k">If</span> <span class="nv">the</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">growth</span> <span class="nv">phase</span> <span class="nv">is</span> <span class="nv">between</span> <span class="mi">2</span> <span class="nv">and</span> <span class="mi">6</span>, <span class="nv">the</span> <span class="nv">LAI</span> <span class="nv">is</span> <span class="nv">calculated</span> <span class="nv">as</span> <span class="nv">the</span> <span class="nv">product</span> <span class="nv">of</span>

    <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">biomass</span> <span class="ss">(</span><span class="nv">biomasseFeuille</span><span class="ss">)</span> <span class="nv">and</span> <span class="nv">specific</span> <span class="nv">leaf</span> <span class="nv">area</span> <span class="ss">(</span><span class="nv">sla</span><span class="ss">)</span>.

    <span class="k">If</span> <span class="nv">the</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">growth</span> <span class="nv">phase</span> <span class="nv">is</span> <span class="nv">greater</span> <span class="nv">than</span> <span class="mi">6</span>, <span class="nv">the</span> <span class="nv">LAI</span> <span class="nv">is</span> <span class="nv">set</span> <span class="nv">back</span> <span class="nv">to</span> <span class="mi">0</span>.

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvolLAIPhases</span> <span class="nv">procedure</span> <span class="nv">from</span> <span class="nv">the</span>

    <span class="nv">milbilancarbone</span>.<span class="nv">pas</span> <span class="nv">and</span> <span class="nv">exmodules</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">2</span>.<span class="nv">pas</span> <span class="nv">file</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">original</span> <span class="nv">Pascal</span>

    <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">timestep</span> <span class="ss">(</span><span class="nv">int</span><span class="ss">)</span>: <span class="nv">The</span> <span class="nv">time</span> <span class="nv">step</span> <span class="nv">to</span> <span class="nv">calculate</span> <span class="nv">the</span> <span class="nv">LAI</span> <span class="k">for</span>.

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">xarray</span>.<span class="nv">Dataset</span><span class="ss">)</span>: <span class="nv">The</span> <span class="nv">xarray</span> <span class="nv">dataset</span> <span class="nv">that</span> <span class="nv">contains</span> <span class="nv">the</span> <span class="nv">relevant</span> <span class="nv">data</span>.

    <span class="nv">Returns</span>:

        <span class="nv">xarray</span>.<span class="nv">Dataset</span>: <span class="nv">The</span> <span class="nv">updated</span> <span class="nv">xarray</span> <span class="nv">dataset</span> <span class="nv">with</span> <span class="nv">the</span> <span class="nv">calculated</span> <span class="nv">LAI</span>.

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">lai</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">xr</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;=</span> <span class="mi">1</span><span class="ss">)</span>,

        <span class="mi">0</span>,

        <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

            <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;=</span> <span class="mi">6</span>,

            <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">sla</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

            <span class="mi">0</span>,

        <span class="ss">)</span>

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="calculate_maintainance_respiration">calculate_maintainance_respiration</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_maintainance_respiration</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function calculates the maintenance respiration <code>respMaint</code> (in kg/ha/j in equivalent dry matter) of the plant.</p>
<p>The maintenance respiration is calculated by summing the maintenance respiration associated with total biomass and 
leaves biomass. If the plant's growth phase is above 4 and there is no leaf biomass, <code>respMaint</code> is set to 0.</p>
<p>The calculation is based on the equation:
  coefficient_temp = 2^((average_temp - tempMaint) / 10)
  respiration = kRespMaint * biomass * coefficient_temp</p>
<p>where <code>average_temp</code> is the average temperature for the day, <code>tempMaint</code> is the maintenance temperature from
<code>variety_params</code>, <code>kRespMaint</code> is the maintenance respiration coefficient from <code>variety_params</code>, and <code>biomass</code>
is the total or leaf biomass.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The time step of the calculation.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The input data containing the variables <code>tpMoy</code>, <code>biomasseTotale</code>, <code>biomasseFeuille</code>, and <br><code>numPhase</code>. The output <code>respMaint</code> will also be stored in this dataset.</td>
<td>None</td>
</tr>
<tr>
<td>variety_params</td>
<td>dict</td>
<td>The parameters related to the plant variety, containing the keys <code>tempMaint</code> and <br><code>kRespMaint</code>.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The input <code>data</code> with the updated <code>respMaint</code> variable.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">calculate_maintainance_respiration</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    This function calculates the maintenance respiration `respMaint` (in kg/ha/j in equivalent dry matter) of the plant.</span>

<span class="s2">    The maintenance respiration is calculated by summing the maintenance respiration associated with total biomass and</span>

<span class="s2">    leaves biomass. If the plant&#39;s growth phase is above 4 and there is no leaf biomass, `respMaint` is set to 0.</span>

<span class="s2">    The calculation is based on the equation:</span>

<span class="s2">      coefficient_temp = 2^((average_temp - tempMaint) / 10)</span>

<span class="s2">      respiration = kRespMaint * biomass * coefficient_temp</span>

<span class="s2">    where `average_temp` is the average temperature for the day, `tempMaint` is the maintenance temperature from</span>

<span class="s2">    `variety_params`, `kRespMaint` is the maintenance respiration coefficient from `variety_params`, and `biomass`</span>

<span class="s2">    is the total or leaf biomass.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): The time step of the calculation.</span>

<span class="s2">        data (xarray.Dataset): The input data containing the variables `tpMoy`, `biomasseTotale`, `biomasseFeuille`, and</span>

<span class="s2">            `numPhase`. The output `respMaint` will also be stored in this dataset.</span>

<span class="s2">        variety_params (dict): The parameters related to the plant variety, containing the keys `tempMaint` and</span>

<span class="s2">            `kRespMaint`.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The input `data` with the updated `respMaint` variable.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">coefficient_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="p">((</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;tpMoy&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;tempMaint&quot;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">resp_totale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kRespMaint&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">coefficient_temp</span><span class="w"></span>

<span class="w">    </span><span class="n">resp_feuille</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kRespMaint&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">coefficient_temp</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;respMaint&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">resp_totale</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resp_feuille</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="compute_rapdensite">compute_rapDensite</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_rapDensite</span><span class="p">(</span>
    <span class="n">paramITK</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>It basically calculates a correction factor (rapDensite).</p>
<p>This correction factor Is calculated with an equation of form</p>
<p>a + p * exp( -(x/(o / -log((1-a)/p) )) )</p>
<p>with a the densiteA parameter
p the densiteP parameter$
x the actual crop density
o the densOpti parameter</p>
<p>See
https://www.wolframalpha.com/input?i=a+%2B+p+*+exp%28-%28x+%2F+%28+o%2F-+log%28%281+-+a%29%2F+p%29%29%29%29
for equation visualization.</p>
<p>This equation is probably too complex for the problem at hand.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramITK</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span><span class="w"> </span><span class="nf">compute_rapDensite</span><span class="p">(</span><span class="nv">paramITK</span><span class="p">,</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="s">    It basically calculates a correction factor (rapDensite).</span>

<span class="s">    This correction factor Is calculated with an equation of form</span>

<span class="s">    a + p * exp( -(x/(o / -log((1-a)/p) )) )</span>

<span class="s">    with a the densiteA parameter</span>

<span class="s">    p the densiteP parameter$</span>

<span class="s">    x the actual crop density</span>

<span class="s">    o the densOpti parameter</span>

<span class="s">    See</span>

<span class="s">    https://www.wolframalpha.com/input?i=a+%2B+p+*+exp%28-%28x+%2F+%28+o%2F-+log%28%281+-+a%29%2F+p%29%29%29%29</span>

<span class="s">    for equation visualization.</span>

<span class="s">    This equation is probably too complex for the problem at hand.</span>

<span class="s">    Args:</span>

<span class="s">        j (_type_): _description_</span>

<span class="s">        data (_type_): _description_</span>

<span class="s">        paramITK (_type_): _description_</span>

<span class="s">        paramVariete (_type_): _description_</span>

<span class="s">    Returns:</span>

<span class="s">        _type_: _description_</span>

<span class="s">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">rapDensite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">[</span><span class="s">&quot;densiteA&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">[</span><span class="s">&quot;densiteP&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">np</span><span class="o">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nv">paramITK</span><span class="p">[</span><span class="s">&quot;densite&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">[</span><span class="s">&quot;densOpti&quot;</span><span class="p">]</span><span class="o">/-</span><span class="w"> </span><span class="nv">np</span><span class="o">.</span><span class="nf">log</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">[</span><span class="o">&#39;</span><span class="nv">densiteA</span><span class="o">&#39;</span><span class="p">])</span><span class="o">/</span><span class="w"> </span><span class="nv">paramVariete</span><span class="p">[</span><span class="s">&quot;densiteP&quot;</span><span class="p">]))))</span><span class="w"></span>

<span class="w">    </span><span class="nv">return</span><span class="w"> </span><span class="nv">rapDensite</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="condition_positive_delta_aboveground_biomass_all_phases">condition_positive_delta_aboveground_biomass_all_phases</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">condition_positive_delta_aboveground_biomass_all_phases</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">condition_positive_delta_aboveground_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

        #<span class="o">//</span> <span class="nv">condition</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;=</span> <span class="mi">0</span><span class="ss">)</span>

    <span class="nv">condition</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">0</span><span class="ss">)</span>

    <span class="k">return</span> <span class="nv">condition</span>
</code></pre></div>

</details>
<h3 id="condition_positive_delta_biomass">condition_positive_delta_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">condition_positive_delta_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">condition_positive_delta_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

        <span class="nv">condition</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> \

            <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;=</span> <span class="mi">0</span><span class="ss">)</span> <span class="o">&amp;</span> \

            <span class="ss">((</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;=</span> <span class="mi">4</span><span class="ss">)</span> <span class="o">|</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;=</span> <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">phaseDevVeg</span><span class="s2">&quot;</span>]<span class="ss">))</span>

            # <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;=</span> <span class="mi">4</span><span class="ss">)</span>

        <span class="k">return</span> <span class="nv">condition</span>
</code></pre></div>

</details>
<h3 id="estimate_kassim">estimate_KAssim</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_KAssim</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function calculates the conversion factor <code>KAssim</code>, which is used to convert assimilates into biomass. </p>
<p>The value of <code>KAssim</code> depends on the phase of the crop. </p>
<p>The conversion factor is calculated based on a lookup table that maps crop phases to values. The crop phase is
determined by the <code>numPhase</code> field in the <code>data</code> argument, and the corresponding <code>KAssim</code> value is set in the 
<code>KAssim</code> field of the <code>data</code> argument.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>An integer index specifying the time step.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>A dataset containing the variables used in the calculation of <code>KAssim</code>. The dataset <br>should include the fields <code>numPhase</code>, <code>sdj</code>, <code>seuilTemp PhasePrec</code>, and <code>seuilTemp PhaseSuivante</code>. The<br><code>KAssim</code> field of the dataset will be updated by this function.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary of parameters. It should include the fields <code>txAssimBVP</code>, <code>txAssimMatu1</code>,<br>and <code>txAssimMatu2</code>.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated <code>data</code> dataset, with the <code>KAssim</code> field set to the calculated values.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">estimate_KAssim</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    This function calculates the conversion factor `KAssim`, which is used to convert assimilates into biomass.</span>

<span class="s2">    The value of `KAssim` depends on the phase of the crop.</span>

<span class="s2">    The conversion factor is calculated based on a lookup table that maps crop phases to values. The crop phase is</span>

<span class="s2">    determined by the `numPhase` field in the `data` argument, and the corresponding `KAssim` value is set in the</span>

<span class="s2">    `KAssim` field of the `data` argument.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): An integer index specifying the time step.</span>

<span class="s2">        data (xarray.Dataset): A dataset containing the variables used in the calculation of `KAssim`. The dataset</span>

<span class="s2">            should include the fields `numPhase`, `sdj`, `seuilTemp PhasePrec`, and `seuilTemp PhaseSuivante`. The</span>

<span class="s2">            `KAssim` field of the dataset will be updated by this function.</span>

<span class="s2">        paramVariete (dict): A dictionary of parameters. It should include the fields `txAssimBVP`, `txAssimMatu1`,</span>

<span class="s2">            and `txAssimMatu2`.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The updated `data` dataset, with the `KAssim` field set to the calculated values.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">phase_equivalences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>

<span class="w">        </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="c1">#! replacing sommeDegresJourPhasePrec with seuilTempPhasePrec</span><span class="w"></span>

<span class="w">        </span><span class="c1">#// 5: paramVariete[&quot;txAssimBVP&quot;] + (data[&#39;sdj&#39;][j,:,:] - data[&#39;sommeDegresJourPhasePrec&#39;][j,:,:]) * (paramVariete[&#39;txAssimMatu1&#39;] -  paramVariete[&#39;txAssimBVP&#39;]) / (data[&#39;seuilTempPhaseSuivante&#39;][j,:,:] - data[&#39;sommeDegresJourPhasePrec&#39;][j,:,:]),</span><span class="w"></span>

<span class="w">        </span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txAssimBVP&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s1">&#39;sdj&#39;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s1">&#39;seuilTempPhasePrec&#39;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s1">&#39;txAssimMatu1&#39;</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="n">paramVariete</span><span class="err">[</span><span class="s1">&#39;txAssimBVP&#39;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s1">&#39;seuilTempPhaseSuivante&#39;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s1">&#39;seuilTempPhasePrec&#39;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="c1">#// 6: paramVariete[&quot;txAssimMatu1&quot;] + (data[&quot;sdj&quot;][j,:,:] - data[&quot;sommeDegresJourPhasePrec&quot;][j,:,:]) * (paramVariete[&quot;txAssimMatu2&quot;] - paramVariete[&quot;txAssimMatu1&quot;]) / (data[&quot;seuilTempPhaseSuivante&quot;][j,:,:] - data[&quot;sommeDegresJourPhasePrec&quot;][j,:,:]),</span><span class="w"></span>

<span class="w">        </span><span class="mi">6</span><span class="o">:</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txAssimMatu1&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;sdj&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txAssimMatu2&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txAssimMatu1&quot;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;seuilTempPhaseSuivante&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="err">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">phase</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;KAssim&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">phase</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">phase_equivalences</span><span class="err">[</span><span class="k">phase</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;KAssim&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="estimate_conv">estimate_conv</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_conv</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function calculates the conversion of assimilates into biomass.</p>
<p>The conversion factor is determined by multiplying the KAssim value, which 
is dependent on the phase of the crop, with the conversion rate (txConversion) 
specified in the <code>paramVariete</code> argument.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The starting index of the calculation</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>dict</td>
<td>A dictionary containing information on the crop growth, including <br>the phase of the crop and the KAssim value.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary containing parameters relevant to the crop <br>growth, including the conversion rate.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dict</td>
<td>The input <code>data</code> dictionary with the calculated "conv" value added.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">estimate_conv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="k">data</span><span class="p">,</span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    This function calculates the conversion of assimilates into biomass.</span>

<span class="s2">    The conversion factor is determined by multiplying the KAssim value, which</span>

<span class="s2">    is dependent on the phase of the crop, with the conversion rate (txConversion)</span>

<span class="s2">    specified in the `paramVariete` argument.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): The starting index of the calculation</span>

<span class="s2">        data (dict): A dictionary containing information on the crop growth, including</span>

<span class="s2">                     the phase of the crop and the KAssim value.</span>

<span class="s2">        paramVariete (dict): A dictionary containing parameters relevant to the crop</span>

<span class="s2">                             growth, including the conversion rate.</span>

<span class="s2">    Returns:</span>

<span class="s2">        dict: The input `data` dictionary with the calculated &quot;</span><span class="n">conv</span><span class="s2">&quot; value added.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;conv&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;KAssim&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txConversion&quot;</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="estimate_critical_nitrogen_concentration">estimate_critical_nitrogen_concentration</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_critical_nitrogen_concentration</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">estimate_critical_nitrogen_concentration</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    # <span class="nv">estimate</span> <span class="nv">critical</span> <span class="nv">nitrogen</span> <span class="nv">concentration</span> <span class="nv">from</span> <span class="nv">plant</span> <span class="nv">dry</span> <span class="nv">matter</span> <span class="nv">using</span> <span class="nv">the</span> <span class="nv">Justes</span> <span class="nv">et</span> <span class="nv">al</span> <span class="ss">(</span><span class="mi">1994</span><span class="ss">)</span> <span class="nv">relationship</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">Ncrit</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="mi">5</span>.<span class="mi">35</span> <span class="o">*</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTotale</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="o">/</span><span class="mi">1000</span><span class="ss">)</span> <span class="o">**</span> <span class="ss">(</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">44</span><span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="estimate_kcp">estimate_kcp</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_kcp</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Estimate the kcp coefficient based on the maximum crop coefficient <code>kcMax</code> and plant cover <code>ltr</code>.</p>
<p>The computation of <code>kcp</code> is based on the EvolKcpKcIni procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The starting index for updating <code>kcp</code> in the <code>data</code> dataset.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>A dataset containing the data used in the computation of <code>kcp</code>. The dataset should contain the following variables:<br>- 'numPhase': A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the number of phases in the crop cycle.<br>- 'kcp': A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the coefficient of crop growth.<br>- 'ltr': A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the plant cover.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary containing the parameters for estimating <code>kcp</code>. The dictionary should contain the following key:<br>- 'kcMax': A float, representing the maximum crop coefficient.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated <code>data</code> dataset with the new <code>kcp</code> values.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">estimate_kcp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Estimate the kcp coefficient based on the maximum crop coefficient `kcMax` and plant cover `ltr`.</span>

<span class="s2">    The computation of `kcp` is based on the EvolKcpKcIni procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): The starting index for updating `kcp` in the `data` dataset.</span>

<span class="s2">        data (xarray.Dataset): A dataset containing the data used in the computation of `kcp`. The dataset should contain the following variables:</span>

<span class="s2">            - &#39;numPhase&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the number of phases in the crop cycle.</span>

<span class="s2">            - &#39;kcp&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the coefficient of crop growth.</span>

<span class="s2">            - &#39;ltr&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the plant cover.</span>

<span class="s2">        paramVariete (dict): A dictionary containing the parameters for estimating `kcp`. The dictionary should contain the following key:</span>

<span class="s2">            - &#39;kcMax&#39;: A float, representing the maximum crop coefficient.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The updated `data` dataset with the new `kcp` values.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;kcp&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kcMax&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;ltr&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;kcp&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="estimate_ltr">estimate_ltr</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_ltr</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Estimate the fraction of radiation transmitted to the soil <code>ltr</code> based on the leaf area index <code>lai</code>.</p>
<p><code>ltr</code> is used as a proxy for plant covering of the soil in the water balance calculation, where 1 represents no plant cover and 0 represents full plant cover. <code>ltr</code> is computed as an exponential decay function of <code>lai</code> with a decay coefficient <code>kdf</code>.</p>
<p>This function is adapted from the EvalLtr procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The starting index for updating <code>ltr</code> in the <code>data</code> dataset.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>A dataset containing the data used in the computation of <code>ltr</code>. The dataset should contain the following variables:<br>- 'lai': A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the leaf area index.<br>- 'ltr': A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the fraction of radiation transmitted to the soil.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary containing the parameters for estimating <code>ltr</code>. The dictionary should contain the following key:<br>- 'kdf': A float, representing the decay coefficient for <code>ltr</code>.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated <code>data</code> dataset with the new <code>ltr</code> values.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">estimate_ltr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Estimate the fraction of radiation transmitted to the soil `ltr` based on the leaf area index `lai`.</span>

<span class="s2">    `ltr` is used as a proxy for plant covering of the soil in the water balance calculation, where 1 represents no plant cover and 0 represents full plant cover. `ltr` is computed as an exponential decay function of `lai` with a decay coefficient `kdf`.</span>

<span class="s2">    This function is adapted from the EvalLtr procedure from the biomasse.pas and exmodules 1 &amp; 2.pas files of the original PASCAL code.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): The starting index for updating `ltr` in the `data` dataset.</span>

<span class="s2">        data (xarray.Dataset): A dataset containing the data used in the computation of `ltr`. The dataset should contain the following variables:</span>

<span class="s2">            - &#39;lai&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the leaf area index.</span>

<span class="s2">            - &#39;ltr&#39;: A 3-dimensional data variable with shape (num_timesteps, num_rows, num_columns), representing the fraction of radiation transmitted to the soil.</span>

<span class="s2">        paramVariete (dict): A dictionary containing the parameters for estimating `ltr`. The dictionary should contain the following key:</span>

<span class="s2">            - &#39;kdf&#39;: A float, representing the decay coefficient for `ltr`.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The updated `data` dataset with the new `ltr` values.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># group 80</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;ltr&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kdf&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;lai&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="estimate_reallocation">estimate_reallocation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_reallocation</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Estimate the daily biomass reallocation between stem and leaves.</p>
<p>This function computes the daily biomass reallocation between stem and leaves for the plant. The computation 
only occurs when the plant is in phase 5. The amount of biomass that can be reallocated is estimated as 
follows:</p>
<ol>
<li>
<p>The difference between the potential yield delta and the aboveground biomass delta, bound by 0, is 
calculated and referred to as manqueAssim. manqueAssim represents the daily variation in biomass that 
remains after the plant has built its aboveground biomass.</p>
</li>
<li>
<p>The reallocation is computed as the minimum of the product of manqueAssim and the reallocation rate and 
the difference between the leaf biomass and 30, also bound by 0. The value of 30 is an arbitrary 
threshold which ensures that reallocation is 0 if the leaf biomass is below 30. If the leaf biomass is 
above 30, reallocation is bounded by biomasseFeuille - 30.</p>
</li>
</ol>
<p>If the plant is not in phase 5, reallocation is set to 0.</p>
<p>This function is based on the EvalReallocationSarrahV3 procedure from the bilancarbonsarra.pas and 
exmodules 1 &amp; 2.pas files from the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>Current time step of the simulation.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The dataset containing all the simulation data.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary containing the parameters for the simulation.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated dataset with the reallocation values.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">estimate_reallocation</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Estimate the daily biomass reallocation between stem and leaves.</span>

<span class="sd">    This function computes the daily biomass reallocation between stem and leaves for the plant. The computation</span>

<span class="sd">    only occurs when the plant is in phase 5. The amount of biomass that can be reallocated is estimated as</span>

<span class="sd">    follows:</span>

<span class="sd">    1. The difference between the potential yield delta and the aboveground biomass delta, bound by 0, is</span>

<span class="sd">    calculated and referred to as manqueAssim. manqueAssim represents the daily variation in biomass that</span>

<span class="sd">    remains after the plant has built its aboveground biomass.</span>

<span class="sd">    2. The reallocation is computed as the minimum of the product of manqueAssim and the reallocation rate and</span>

<span class="sd">    the difference between the leaf biomass and 30, also bound by 0. The value of 30 is an arbitrary</span>

<span class="sd">    threshold which ensures that reallocation is 0 if the leaf biomass is below 30. If the leaf biomass is</span>

<span class="sd">    above 30, reallocation is bounded by biomasseFeuille - 30.</span>

<span class="sd">    If the plant is not in phase 5, reallocation is set to 0.</span>

<span class="sd">    This function is based on the EvalReallocationSarrahV3 procedure from the bilancarbonsarra.pas and</span>

<span class="sd">    exmodules 1 &amp; 2.pas files from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): Current time step of the simulation.</span>

<span class="sd">        data (xarray.Dataset): The dataset containing all the simulation data.</span>

<span class="sd">        paramVariete (dict): A dictionary containing the parameters for the simulation.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated dataset with the reallocation values.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;manqueAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="n">condition</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]))),</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reallocation&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="n">condition</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;manqueAssim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txRealloc&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">30</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="initialize_simulation">initialize_simulation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">initialize_simulation</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">grid_width</span><span class="p">,</span>
    <span class="n">grid_height</span><span class="p">,</span>
    <span class="n">duration</span><span class="p">,</span>
    <span class="n">paramVariete</span><span class="p">,</span>
    <span class="n">paramITK</span><span class="p">,</span>
    <span class="n">date_start</span>
<span class="p">)</span>
</code></pre></div>

<p>This function initializes variables related to crop growth in the data</p>
<p>xarray dataset. As the rain is the first variable to be initialized in the
data xarray dataset, its dimensions are used to initialize the other
variables.</p>
<p><img alt="no caption" src="../../../docs/images/sla.png" /></p>
<p>This code has been adapted from the original InitiationCulture procedure, from the <code>MilBilanCarbone.pas</code> code of the
SARRA model.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em> grid_width (<em>type</em>): <em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>grid_height</td>
<td><em>type</em></td>
<td><em>description</em> duration (<em>type</em>): <em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="nf">initialize_simulation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">,</span><span class="w"> </span><span class="n">date_start</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">initializes</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">related</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">crop</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">data</span><span class="w"></span>

<span class="w">    </span><span class="n">xarray</span><span class="w"> </span><span class="n">dataset</span><span class="p">.</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rain</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="n">xarray</span><span class="w"> </span><span class="n">dataset</span><span class="p">,</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">other</span><span class="w"></span>

<span class="w">    </span><span class="n">variables</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="p">[</span><span class="n">no</span><span class="w"> </span><span class="n">caption</span><span class="p">](..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">sla</span><span class="p">.</span><span class="n">png</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">adapted</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">InitiationCulture</span><span class="w"> </span><span class="n">procedure</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">MilBilanCarbone</span><span class="p">.</span><span class="n">pas</span><span class="err">`</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"></span>

<span class="w">    </span><span class="n">SARRA</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="nl">Args</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"> </span><span class="n">grid_width</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">        </span><span class="n">grid_height</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="w"> </span><span class="p">(</span><span class="n">_type_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">    </span><span class="nl">Returns</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="nl">_type_</span><span class="p">:</span><span class="w"> </span><span class="n">_description_</span><span class="w"></span>

<span class="w">    </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">    </span><span class="cp">### variables to be initialized with values from parameters</span>

<span class="w">    </span><span class="cp"># from paramVariete : maximum daily thermal time (°C.j) -&gt; #? unused ?</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;sommeDegresJourMaximale&quot;] = (data[&quot;rain&quot;].dims, np.full(</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">//     (duration, grid_width, grid_height),</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">//     (paramVariete[&quot;SDJLevee&quot;] + paramVariete[&quot;SDJBVP&quot;] + paramVariete[&quot;SDJRPR&quot;] + paramVariete[&quot;SDJMatu1&quot;] + paramVariete[&quot;SDJMatu2&quot;])</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// ))</span>

<span class="w">    </span><span class="cp">#// data[&quot;sommeDegresJourMaximale&quot;].attrs = </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="s">&quot;°C.j&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="s">&quot;Maximum thermal time&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># from paramITK : sowing date</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;sowing_date&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">paramITK</span><span class="p">[</span><span class="s">&quot;DateSemis&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">date_start</span><span class="p">).</span><span class="n">days</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="cp"># from paramITK : automatic irrigation indicator</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;irrigAuto&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s">&quot;irrigAuto&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;irrigAuto&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="s">&quot;binary&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="s">&quot;automatic irrigation indicator&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">####### variables qui viennent de initplotMc</span>

<span class="w">    </span><span class="cp"># Initial biomass of crop residues (mulch) (kg/ha)</span>

<span class="w">    </span><span class="cp"># Biomasse initiale des résidus de culture (mulch) (kg/ha)</span>

<span class="w">    </span><span class="cp">#   BiomMc := BiomIniMc;</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomMc&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s">&quot;biomIniMc&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;biomMc&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;kg/ha&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Initial biomass of crop residues (mulch)&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># ?</span>

<span class="w">    </span><span class="cp">#   StSurf := StockIniSurf;</span>

<span class="w">    </span><span class="cp"># data[&quot;stSurf&quot;] = np.full((grid_width, grid_height, duration), paramTypeSol[&quot;stockIniSurf&quot;])</span>

<span class="w">    </span><span class="cp"># ?</span>

<span class="w">    </span><span class="cp">#   Ltr := 1;</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;ltr&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="cp"># Initial biomass of stem residues as litter (kg/ha)</span>

<span class="w">    </span><span class="cp"># Biomasse initiale des résidus de tiges sous forme de litière (kg/ha)</span>

<span class="w">    </span><span class="cp">#   LitTiges := BiomIniMc;</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;LitTige&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s">&quot;biomIniMc&quot;</span><span class="p">]))</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;LitTige&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;kg/ha&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Initial biomass of stem residues as litter&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">####### fin variables qui viennent de initplotMc</span>

<span class="w">    </span><span class="cp">####### variables eau depuis InitPlotMc</span>

<span class="w">    </span><span class="cp"># Initializes variables related to crop residues boimass (mulch) in the data</span>

<span class="w">    </span><span class="cp"># xarray dataset. This code has been adapted from the original InitPlotMc</span>

<span class="w">    </span><span class="cp"># procedure, Bileau.pas code. Comments with tab indentation are from the</span>

<span class="w">    </span><span class="cp"># original code. As the rain is the first variable to be initialized in the</span>

<span class="w">    </span><span class="cp"># data xarray dataset, its dimensions are used to initialize the other</span>

<span class="w">    </span><span class="cp"># variables.</span>

<span class="w">    </span><span class="cp"># Soil maximum water storage capacity (mm)</span>

<span class="w">    </span><span class="cp"># Capacité maximale de la RU (mm)</span>

<span class="w">    </span><span class="cp">#   StRurMax := Ru * ProfRacIni / 1000;</span>

<span class="w">    </span><span class="cp">#! renaming stRurMax with root_tank_capacity</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;stRurMax&quot;] = data[&quot;ru&quot;] * paramITK[&quot;profRacIni&quot;] / 1000</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;root_tank_capacity&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;ru&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="p">[</span><span class="s">&quot;profRacIni&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)[</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;stRurMax&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;Soil maximum water storage capacity&quot;}</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;root_tank_capacity&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Soil maximum water storage capacity&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># Maximum water capacity of surface tank (mm)</span>

<span class="w">    </span><span class="cp"># Reserve utile de l&#39;horizon de surface (mm)</span>

<span class="w">    </span><span class="cp">#   RuSurf := EpaisseurSurf / 1000 * Ru;</span>

<span class="w">    </span><span class="cp">#! renaming ruSurf with surface_tank_capacity</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;ruSurf&quot;] = data[&quot;epaisseurSurf&quot;] / 1000 * data[&quot;ru&quot;]</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;surface_tank_capacity&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;epaisseurSurf&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;ru&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;ruSurf&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;Maximum water capacity of surface tank&quot;}</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;surface_tank_capacity&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Maximum water capacity of surface tank&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># ?</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">//    PfTranspi := EpaisseurSurf * HumPf;</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">//    StTot := StockIniSurf - PfTranspi/2 + StockIniProf;</span>

<span class="w">    </span><span class="cp">#   StTot := StockIniSurf  + StockIniProf;</span>

<span class="w">    </span><span class="cp"># data[&quot;stTot&quot;] = np.full((grid_width, grid_height, duration), (paramTypeSol[&quot;stockIniSurf&quot;] + paramTypeSol[&quot;stockIniProf&quot;]))</span>

<span class="w">    </span><span class="cp">#! modifié pour faire correspondre les résultats de simulation, à remettre en place pour un calcul correct dès que possible</span>

<span class="w">    </span><span class="cp"># data[&quot;stTot&quot;] = np.full((grid_width, grid_height, duration), (paramTypeSol[&quot;stockIniProf&quot;]))</span>

<span class="w">    </span><span class="cp">#! renaming stTot to total_tank_stock</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;stTot&quot;] = data[&quot;stockIniProf&quot;]</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">//data[&quot;total_tank_stock&quot;] = data[&quot;stockIniProf&quot;]</span>

<span class="w">    </span><span class="cp">#! coorecting total_tank_stock initialization as it did not have the time dimensions that are required as stock evolves through time</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;total_tank_stock&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;stockIniProf&quot;</span><span class="p">])[</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;stTot&quot;].attrs = {&quot;units&quot;: &quot;mm&quot;, &quot;long_name&quot;: &quot;?&quot;}</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;total_tank_stock&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;?&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># Soil maximal depth (mm)</span>

<span class="w">    </span><span class="cp"># Profondeur maximale de sol (mm)</span>

<span class="w">    </span><span class="cp">#   ProfRU := EpaisseurSurf + EpaisseurProf;</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;profRu&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;epaisseurProf&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;epaisseurSurf&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;profRu&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Soil maximal depth&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># Maximum water capacity to humectation front (mm)</span>

<span class="w">    </span><span class="cp"># Quantité d&#39;eau maximum jusqu&#39;au front d&#39;humectation (mm)</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">// modif 10/06/2015  resilience stock d&#39;eau</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">// Front d&#39;humectation egal a RuSurf trop de stress initial</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">//    Hum := max(StTot, StRurMax);</span>

<span class="w">    </span><span class="cp">#   Hum := max(RuSurf, StRurMax);</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">// Hum mis a profRuSurf</span>

<span class="w">    </span><span class="cp">#   Hum := max(StTot, Hum);</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;hum&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="cp">#! renaming ruSurf with surface_tank_capacity</span>

<span class="w">                </span><span class="cp">#</span><span class="c1">// data[&quot;ruSurf&quot;],</span>

<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;surface_tank_capacity&quot;</span><span class="p">].</span><span class="n">expand_dims</span><span class="p">({</span><span class="s">&quot;time&quot;</span><span class="o">:</span><span class="n">duration</span><span class="p">}),</span><span class="w"></span>

<span class="w">                </span><span class="cp">#! renaming stRurMax with root_tank_capacity</span>

<span class="w">                </span><span class="cp">#</span><span class="c1">// data[&quot;stRurMax&quot;],</span>

<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;root_tank_capacity&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">            </span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="cp">#! renaming stTot with total_tank_stock</span>

<span class="w">            </span><span class="cp">#</span><span class="c1">// data[&quot;stTot&quot;],</span>

<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;total_tank_stock&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;hum&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;mm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Maximum water capacity to humectation front&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># Previous value for Maximum water capacity to humectation front (mm)</span>

<span class="w">    </span><span class="cp">#  HumPrec := Hum;</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;humPrec&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;hum&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="cp"># ?</span>

<span class="w">    </span><span class="cp">#   StRurPrec := 0;</span>

<span class="w">    </span><span class="cp"># Previous value for stTot</span>

<span class="w">    </span><span class="cp">#   StRurMaxPrec := 0;</span>

<span class="w">    </span><span class="cp">#   </span><span class="c1">//modif 10/06/2015 resilience stock d&#39;eau</span>

<span class="w">    </span><span class="cp">#! renaming stTot with total_tank_stock</span>

<span class="w">    </span><span class="cp">#! renaminog stRuPrec with total_tank_stock_previous_value</span>

<span class="w">    </span><span class="cp">#</span><span class="c1">// data[&quot;stRuPrec&quot;] =  data[&quot;stTot&quot;]</span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;total_tank_stock_previous_value&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;total_tank_stock&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="cp">####### fin variables eau depuis InitPlotMc</span>

<span class="w">    </span><span class="cp"># depuis meteo.pas</span>

<span class="w">    </span><span class="n">kpar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;par&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kpar</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rg&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;par&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="s">&quot;MJ/m2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="s">&quot;par&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># crop density</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paramVariete</span><span class="p">[</span><span class="s">&quot;densOpti&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">compute_rapDensite</span><span class="p">(</span><span class="n">paramITK</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rapDensite&quot;</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="s">&quot;none&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="s">&quot;sowing density adjustement factor&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp"># initialize variables with values at 0</span>

<span class="w">    </span><span class="n">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable_dict</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;rain&quot;</span><span class="p">].</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">grid_width</span><span class="p">,</span><span class="w"> </span><span class="n">grid_height</span><span class="p">)))</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">].</span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;units&quot;</span><span class="o">:</span><span class="n">variables</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;long_name&quot;</span><span class="o">:</span><span class="n">variables</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_aboveground_biomass">update_aboveground_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_aboveground_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the aboveground biomass of the plant.</p>
<p>The aboveground biomass is either updated based on a linear function of the total biomass, if the plant is in phase 2, 3, or 4, or incremented with the total biomass delta if the plant is in any other phase.</p>
<p>This function is based on the EvolBiomAeroSarrahV3 procedure, of the
<strong><em>bilancarbonsarra</em></strong>, exmodules 1 &amp; 2.pas file from the original Pascal
code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The current iteration step in the simulation.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The simulation data, including the current phase of the plant and various biomass values.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>The parameters of the plant variety.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated simulation data, including the updated aboveground biomass and delta aboveground biomass.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_aboveground_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the aboveground biomass of the plant.</span>

<span class="sd">    The aboveground biomass is either updated based on a linear function of the total biomass, if the plant is in phase 2, 3, or 4, or incremented with the total biomass delta if the plant is in any other phase.</span>

<span class="sd">    This function is based on the EvolBiomAeroSarrahV3 procedure, of the</span>

<span class="sd">    ***bilancarbonsarra***, exmodules 1 &amp; 2.pas file from the original Pascal</span>

<span class="sd">    code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The current iteration step in the simulation.</span>

<span class="sd">        data (xarray.Dataset): The simulation data, including the current phase of the plant and various biomass values.</span>

<span class="sd">        paramVariete (dict): The parameters of the plant variety.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated simulation data, including the updated aboveground biomass and delta aboveground biomass.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="c1">#// data[&quot;deltaBiomasseAerienne&quot;][j:,:,:] = np.copy(data[&quot;biomasseAerienne&quot;][j,:,:])</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;aeroTotPente&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;aeroTotBase&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">#//data[&quot;deltaBiomasseAerienne&quot;][j:,:,:] = (data[&quot;biomasseAerienne&quot;][j,:,:] - data[&quot;deltaBiomasseAerienne&quot;][j,:,:])#[...,np.newaxis]</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_aboveground_biomass_step_2">update_aboveground_biomass_step_2</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_aboveground_biomass_step_2</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p><em>summary</em></p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_aboveground_biomass_step_2</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span><span class="s">_summary_</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_assim">update_assim</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_assim</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>This function updates assim. If trPot (potential transpiration from the</p>
<p>plant, mm) is greater than 0, then assim equals assimPot, multiplied by the
ratio of effective transpiration over potential transpiration.</p>
<p>If potential transpiration is null, then assim is null as well.</p>
<p>Is it adapted from the EvalAssimSarraV42 procedure, of the
bilancarbonsarra.pas file from the original Pascal code</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_assim</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">updates</span> <span class="nv">assim</span>. <span class="k">If</span> <span class="nv">trPot</span> <span class="ss">(</span><span class="nv">potential</span> <span class="nv">transpiration</span> <span class="nv">from</span> <span class="nv">the</span>

    <span class="nv">plant</span>, <span class="nv">mm</span><span class="ss">)</span> <span class="nv">is</span> <span class="nv">greater</span> <span class="nv">than</span> <span class="mi">0</span>, <span class="k">then</span> <span class="nv">assim</span> <span class="nv">equals</span> <span class="nv">assimPot</span>, <span class="nv">multiplied</span> <span class="nv">by</span> <span class="nv">the</span>

    <span class="nv">ratio</span> <span class="nv">of</span> <span class="nv">effective</span> <span class="nv">transpiration</span> <span class="nv">over</span> <span class="nv">potential</span> <span class="nv">transpiration</span>.

    <span class="k">If</span> <span class="nv">potential</span> <span class="nv">transpiration</span> <span class="nv">is</span> <span class="nv">null</span>, <span class="k">then</span> <span class="nv">assim</span> <span class="nv">is</span> <span class="nv">null</span> <span class="nv">as</span> <span class="nv">well</span>.

    <span class="nv">Is</span> <span class="nv">it</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalAssimSarraV42</span> <span class="nv">procedure</span>, <span class="nv">of</span> <span class="nv">the</span>

    <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span> <span class="nv">file</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">original</span> <span class="nv">Pascal</span> <span class="nv">code</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">assim</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">trPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">0</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">assimPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">tr</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">trPot</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

        <span class="mi">0</span>,

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_assimpot">update_assimPot</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_assimPot</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span><span class="p">,</span>
    <span class="n">paramITK</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the assimPot value based on the intensification level (NI).</p>
<p>If the intensification level <code>NI</code> is defined in <code>paramITK</code>, the conversion rate <code>txConversion</code> is computed using a formula based on <code>NIYo</code>, <code>NIp</code>, <code>LGauss</code>, and <code>AGauss</code>. If <code>NI</code> is not defined, <code>assimPot</code> is updated using <code>conv</code>, which is updated in the <code>estimate_conv</code> function using the variables <code>KAssim</code> and <code>txConversion</code>.</p>
<p>When NI parameter is used (from to 4), conversion rate txConversion 
is computed using the following formula :
NIYo + NIp * (1-exp(-NIp * NI)) - (exp(-0.5<em>((NI - LGauss)/AGauss)</em> (NI- LGauss)/AGauss))/(AGauss*2.506628274631)</p>
<p>This function is adapted from the <code>EvalAssimSarraV42</code> procedure in the <code>bilancarbonsarra.pas</code> file of the original Pascal code.</p>
<p>Note from
CB : correction of the conversion rate depending on the intensification
level</p>
<p>notes from CB reharding the EvalAssimSarraV42 procedure :</p>
<p>Modif du 04/03/2021 : Prise en compte en plus de la densit� de semis de
l'effet niveau d'intensification NI NI = 1 quand on est � l'optimum du
niveau d'intensification. Dans le cas de situation contr�l� c'est la
fertilit� qui est la clef principale en prenant en r�f�rence la qt� d'azote
(�quivalent phosphore...) optimum Il peut aller � 0 ou �tre sup�rieur � 1 si
situation sur optimum, ie un peu plus de rdt mais � cout trop �lev�... On
�value un nouveau tx de conversion en fn du Ni au travers d'une double
�quation : asympote x gaussienne invers�e Et d'un NI d�fini en fn du
sc�nario de simulation ou des donn�es observ�es. NIYo = D�calage en Y de
l'asymptote NIp  = pente de l'asymptote LGauss = Largeur de la Guaussienne
AGauss = Amplitude de la Guaussienne</p>
<p>Conversion qui est la valeur du taux de conversion en situation optimum n'a
plus besoin d'�tre utilis� sinon dans la calibration des param�tres de cette
�quation en absence de donn�es sur ces param�tres on ne met aucune valeur �
NI CF fichier ex IndIntensite_txConv_eq.xls}</p>
<p>Args:
- j (int): An index that represents the current iteration.
- data (dict): A dictionary containing data arrays with the following keys:
    - "assimPot" (np.ndarray): An array representing the potential assimilation rate.
    - "par" (np.ndarray): An array representing photosynthetically active radiation.
    - "lai" (np.ndarray): An array representing the leaf area index.
    - "conv" (np.ndarray): An array representing the conversion rate.
- paramVariete (dict): A dictionary containing parameters for the computation of the conversion rate, including:
    - "txConversion" (float): The conversion rate.
    - "NIYo" (float): The shift in the Y-axis of the asymptote.
    - "NIp" (float): The slope of the asymptote.
    - "LGauss" (float): The width of the Gaussian curve.
    - "AGauss" (float): The amplitude of the Gaussian curve.
    - "kdf" (float): The constant used in the computation of <code>assimPot</code>.
- paramITK (dict): A dictionary containing the intensification level <code>NI</code> (float).</p>
<p>Returns:
- data (dict): The input <code>data</code> dictionary with the updated "assimPot" array.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_assimPot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Update the assimPot value based on the intensification level (NI).</span>

<span class="s2">    If the intensification level `NI` is defined in `paramITK`, the conversion rate `txConversion` is computed using a formula based on `NIYo`, `NIp`, `LGauss`, and `AGauss`. If `NI` is not defined, `assimPot` is updated using `conv`, which is updated in the `estimate_conv` function using the variables `KAssim` and `txConversion`.</span>

<span class="s2">    When NI parameter is used (from to 4), conversion rate txConversion</span>

<span class="s2">    is computed using the following formula :</span>

<span class="s2">    NIYo + NIp * (1-exp(-NIp * NI)) - (exp(-0.5*((NI - LGauss)/AGauss)* (NI- LGauss)/AGauss))/(AGauss*2.506628274631)</span>

<span class="s2">    This function is adapted from the `EvalAssimSarraV42` procedure in the `bilancarbonsarra.pas` file of the original Pascal code.</span>

<span class="s2">    Note from</span>

<span class="s2">    CB : correction of the conversion rate depending on the intensification</span>

<span class="s2">    level</span>

<span class="s2">    notes from CB reharding the EvalAssimSarraV42 procedure :</span>

<span class="s2">    Modif du 04/03/2021 : Prise en compte en plus de la densit� de semis de</span>

<span class="s2">    l&#39;effet niveau d&#39;intensification NI NI = 1 quand on est � l&#39;optimum du</span>

<span class="s2">    niveau d&#39;intensification. Dans le cas de situation contr�l� c&#39;est la</span>

<span class="s2">    fertilit� qui est la clef principale en prenant en r�f�rence la qt� d&#39;azote</span>

<span class="s2">    (�quivalent phosphore...) optimum Il peut aller � 0 ou �tre sup�rieur � 1 si</span>

<span class="s2">    situation sur optimum, ie un peu plus de rdt mais � cout trop �lev�... On</span>

<span class="s2">    �value un nouveau tx de conversion en fn du Ni au travers d&#39;une double</span>

<span class="s2">    �quation : asympote x gaussienne invers�e Et d&#39;un NI d�fini en fn du</span>

<span class="s2">    sc�nario de simulation ou des donn�es observ�es. NIYo = D�calage en Y de</span>

<span class="s2">    l&#39;asymptote NIp  = pente de l&#39;asymptote LGauss = Largeur de la Guaussienne</span>

<span class="s2">    AGauss = Amplitude de la Guaussienne</span>

<span class="s2">    Conversion qui est la valeur du taux de conversion en situation optimum n&#39;a</span>

<span class="s2">    plus besoin d&#39;�tre utilis� sinon dans la calibration des param�tres de cette</span>

<span class="s2">    �quation en absence de donn�es sur ces param�tres on ne met aucune valeur �</span>

<span class="s2">    NI CF fichier ex IndIntensite_txConv_eq.xls}</span>

<span class="s2">    Args:</span>

<span class="s2">    - j (int): An index that represents the current iteration.</span>

<span class="s2">    - data (dict): A dictionary containing data arrays with the following keys:</span>

<span class="s2">        - &quot;</span><span class="n">assimPot</span><span class="s2">&quot; (np.ndarray): An array representing the potential assimilation rate.</span>

<span class="s2">        - &quot;</span><span class="n">par</span><span class="s2">&quot; (np.ndarray): An array representing photosynthetically active radiation.</span>

<span class="s2">        - &quot;</span><span class="n">lai</span><span class="s2">&quot; (np.ndarray): An array representing the leaf area index.</span>

<span class="s2">        - &quot;</span><span class="n">conv</span><span class="s2">&quot; (np.ndarray): An array representing the conversion rate.</span>

<span class="s2">    - paramVariete (dict): A dictionary containing parameters for the computation of the conversion rate, including:</span>

<span class="s2">        - &quot;</span><span class="n">txConversion</span><span class="s2">&quot; (float): The conversion rate.</span>

<span class="s2">        - &quot;</span><span class="n">NIYo</span><span class="s2">&quot; (float): The shift in the Y-axis of the asymptote.</span>

<span class="s2">        - &quot;</span><span class="n">NIp</span><span class="s2">&quot; (float): The slope of the asymptote.</span>

<span class="s2">        - &quot;</span><span class="n">LGauss</span><span class="s2">&quot; (float): The width of the Gaussian curve.</span>

<span class="s2">        - &quot;</span><span class="n">AGauss</span><span class="s2">&quot; (float): The amplitude of the Gaussian curve.</span>

<span class="s2">        - &quot;</span><span class="n">kdf</span><span class="s2">&quot; (float): The constant used in the computation of `assimPot`.</span>

<span class="s2">    - paramITK (dict): A dictionary containing the intensification level `NI` (float).</span>

<span class="s2">    Returns:</span>

<span class="s2">    - data (dict): The input `data` dictionary with the updated &quot;</span><span class="n">assimPot</span><span class="s2">&quot; array.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paramITK</span><span class="err">[</span><span class="s2">&quot;NI&quot;</span><span class="err">]</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#? the following (stupidly long) line was found commented, need to check why and if this is correct</span><span class="w"></span>

<span class="w">        </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txConversion&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;NIYo&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;NIp&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;NIp&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramITK</span><span class="err">[</span><span class="s2">&quot;NI&quot;</span><span class="err">]</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">paramITK</span><span class="err">[</span><span class="s2">&quot;NI&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;LGauss&quot;</span><span class="err">]</span><span class="p">)</span><span class="o">/</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;AGauss&quot;</span><span class="err">]</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">paramITK</span><span class="err">[</span><span class="s2">&quot;NI&quot;</span><span class="err">]</span><span class="o">-</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;LGauss&quot;</span><span class="err">]</span><span class="p">)</span><span class="o">/</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;AGauss&quot;</span><span class="err">]</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;AGauss&quot;</span><span class="err">]</span><span class="o">*</span><span class="mf">2.506628274631</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># NIYo + NIp * (1-exp(-NIp * NI)) - (exp(-0.5*((NI - LGauss)/AGauss)* (NI- LGauss)/AGauss))/(AGauss*2.506628274631)</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;assimPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;par&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kdf&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;lai&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">            </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;txConversion&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;assimPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;par&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;kdf&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;lai&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span><span class="w"></span>

<span class="w">            </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;conv&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_bm_and_cm">update_bM_and_cM</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_bM_and_cM</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function returns the updated values of bM and cM.</p>
<p>bM and cM are updated if the delta of aerial biomass is positive, 
meaning that the plant is gaining aerial biomass, and if the phase is
above 1 and below 4 or the phase is below the vegetative phase.</p>
<p>This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of
the bilancarbonsarra.pas files from the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_bM_and_cM</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">returns</span> <span class="nv">the</span> <span class="nv">updated</span> <span class="nv">values</span> <span class="nv">of</span> <span class="nv">bM</span> <span class="nv">and</span> <span class="nv">cM</span>.

    <span class="nv">bM</span> <span class="nv">and</span> <span class="nv">cM</span> <span class="nv">are</span> <span class="nv">updated</span> <span class="k">if</span> <span class="nv">the</span> <span class="nv">delta</span> <span class="nv">of</span> <span class="nv">aerial</span> <span class="nv">biomass</span> <span class="nv">is</span> <span class="nv">positive</span>,

    <span class="nv">meaning</span> <span class="nv">that</span> <span class="nv">the</span> <span class="nv">plant</span> <span class="nv">is</span> <span class="nv">gaining</span> <span class="nv">aerial</span> <span class="nv">biomass</span>, <span class="nv">and</span> <span class="k">if</span> <span class="nv">the</span> <span class="nv">phase</span> <span class="nv">is</span>

    <span class="nv">above</span> <span class="mi">1</span> <span class="nv">and</span> <span class="nv">below</span> <span class="mi">4</span> <span class="nv">or</span> <span class="nv">the</span> <span class="nv">phase</span> <span class="nv">is</span> <span class="nv">below</span> <span class="nv">the</span> <span class="nv">vegetative</span> <span class="nv">phase</span>.

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalFeuilleTigeSarrahV4</span> <span class="nv">procedure</span>, <span class="nv">of</span>

    <span class="nv">the</span> <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span> <span class="nv">files</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">original</span> <span class="nv">Pascal</span> <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">bM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>,

        <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">feuilAeroBase</span><span class="s2">&quot;</span>] <span class="o">-</span> <span class="mi">0</span>.<span class="mi">1</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">bM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">cM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>,

        <span class="ss">((</span><span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">feuilAeroPente</span><span class="s2">&quot;</span>] <span class="o">*</span> <span class="mi">1000</span><span class="ss">)</span><span class="o">/</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">bM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="mi">0</span>.<span class="mi">78</span><span class="ss">)</span> <span class="o">/</span> <span class="mi">0</span>.<span class="mi">75</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">cM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_leaf_biomass">update_leaf_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_leaf_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>For phase above 1 and if the delta of aerial biomass is negative,</p>
<p>meaning that the plant is losing aerial biomass, the leaf biomass is
updated as the difference between the leaf biomass and the reallocation
minus the delta of aerial biomass multiplied by the reallocation rate in
leaves. This value is bound in 0.00000001.</p>
<p>Otherwise, the leaf biomass is not updated.</p>
<p>This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of
the bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files from the original
Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_leaf_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="k">For</span> <span class="nv">phase</span> <span class="nv">above</span> <span class="mi">1</span> <span class="nv">and</span> <span class="k">if</span> <span class="nv">the</span> <span class="nv">delta</span> <span class="nv">of</span> <span class="nv">aerial</span> <span class="nv">biomass</span> <span class="nv">is</span> <span class="nv">negative</span>,

    <span class="nv">meaning</span> <span class="nv">that</span> <span class="nv">the</span> <span class="nv">plant</span> <span class="nv">is</span> <span class="nv">losing</span> <span class="nv">aerial</span> <span class="nv">biomass</span>, <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">biomass</span> <span class="nv">is</span>

    <span class="nv">updated</span> <span class="nv">as</span> <span class="nv">the</span> <span class="nv">difference</span> <span class="nv">between</span> <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">biomass</span> <span class="nv">and</span> <span class="nv">the</span> <span class="nv">reallocation</span>

    <span class="nv">minus</span> <span class="nv">the</span> <span class="nv">delta</span> <span class="nv">of</span> <span class="nv">aerial</span> <span class="nv">biomass</span> <span class="nv">multiplied</span> <span class="nv">by</span> <span class="nv">the</span> <span class="nv">reallocation</span> <span class="nv">rate</span> <span class="nv">in</span>

    <span class="nv">leaves</span>. <span class="nv">This</span> <span class="nv">value</span> <span class="nv">is</span> <span class="nv">bound</span> <span class="nv">in</span> <span class="mi">0</span>.<span class="mi">00000001</span>.

    <span class="nv">Otherwise</span>, <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">biomass</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">updated</span>.

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalFeuilleTigeSarrahV4</span> <span class="nv">procedure</span>, <span class="nv">of</span>

    <span class="nv">the</span> <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span> <span class="nv">and</span> <span class="nv">exmodules</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">2</span>.<span class="nv">pas</span> <span class="nv">files</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">original</span>

    <span class="nv">Pascal</span> <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;</span> <span class="mi">0</span><span class="ss">)</span>,

        <span class="nv">np</span>.<span class="nv">maximum</span><span class="ss">(</span>

            <span class="mi">0</span>.<span class="mi">00000001</span>,

            <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">reallocation</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span> <span class="o">*</span> <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">pcReallocFeuille</span><span class="s2">&quot;</span>]

        <span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_leaf_biomass_all_phases">update_leaf_biomass_all_phases</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_leaf_biomass_all_phases</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p><em>summary</em></p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_leaf_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span><span class="s">_summary_</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_aboveground_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">reallocation</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">pcReallocFeuille</span><span class="s2">&quot;</span>],

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_leaf_biomass_positive_delta_aboveground_biomass">update_leaf_biomass_positive_delta_aboveground_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_leaf_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_leaf_biomass_positive_delta_aboveground_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>,

        <span class="ss">(</span><span class="mi">0</span>.<span class="mi">1</span> <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">bM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">cM</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">**</span> <span class="ss">((</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="ss">))</span> \

            <span class="o">*</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_potential_yield">update_potential_yield</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_potential_yield</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the potential yield of the plant.</p>
<p>The potential yield is initialized as an affine function of the delta
between the end of the vegetative phase and the end of the flowering stage,
plus a linear function of the total biomass at the end of the flowering stage.
The potential yield is capped to twice the biomass of the stem to avoid unrealistic
values.</p>
<p>The update occurs if the plant is in phase 5 and its phase has changed</p>
<p>This function is adapted from the EvalRdtPotRespSarV42 procedure, of the
bilancarbonsarra.pas file from the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>An index representing the current time step.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>A dataset containing plant data.</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary containing parameters for the plant variety.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The input <code>data</code> with the potential yield updated.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_potential_yield</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Update the potential yield of the plant.</span>

<span class="s2">    The potential yield is initialized as an affine function of the delta</span>

<span class="s2">    between the end of the vegetative phase and the end of the flowering stage,</span>

<span class="s2">    plus a linear function of the total biomass at the end of the flowering stage.</span>

<span class="s2">    The potential yield is capped to twice the biomass of the stem to avoid unrealistic</span>

<span class="s2">    values.</span>

<span class="s2">    The update occurs if the plant is in phase 5 and its phase has changed</span>

<span class="s2">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of the</span>

<span class="s2">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): An index representing the current time step.</span>

<span class="s2">        data (xarray.Dataset): A dataset containing plant data.</span>

<span class="s2">        paramVariete (dict): A dictionary containing parameters for the plant variety.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The input `data` with the potential yield updated.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">delta_biomass_flowering_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;changePhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;KRdtPotA&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">delta_biomass_flowering_ip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;KRdtPotB&quot;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;KRdtBiom&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">#! phaseDevVeg pas utilisé ? attention c&#39;est un paramètre variétal et pas un jeu de donées</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;changePhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">paramVariete</span><span class="err">[</span><span class="s2">&quot;phaseDevVeg&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;biomasseTige&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_potential_yield_delta">update_potential_yield_delta</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_potential_yield_delta</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>This function updates the delta potential yield (dRdtPot) of the plant, which is the rate at which the</p>
<p>plant's yield is changing over time. The delta potential yield is calculated as the product of the potential
yield, the ratio of actual degree days to maturity, and the ratio of actual transpiration to potential transpiration. 
The calculation is only done if the plant is in phase 5 and the potential transpiration is above 0. 
If the potential transpiration is not above 0, the delta potential yield is set to 0.
For all other phases, the delta potential yield is unchanged. </p>
<p>This function is adapted from the EvalRdtPotRespSarV42 procedure, of the
bilancarbonsarra.pas file from the original Pascal code.</p>
<p>Args:
- j (int): an integer index, representing the current step of the simulation
- data (xarray dataset): the simulation data, including the current state of the plant
- paramVariete (dict): the variety-specific parameters used in the simulation</p>
<p>Returns:
- data (xarray dataset): the updated simulation data, including the updated delta potential yield</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_potential_yield_delta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates the delta potential yield (dRdtPot) of the plant, which is the rate at which the</span>

<span class="sd">    plant&#39;s yield is changing over time. The delta potential yield is calculated as the product of the potential</span>

<span class="sd">    yield, the ratio of actual degree days to maturity, and the ratio of actual transpiration to potential transpiration.</span>

<span class="sd">    The calculation is only done if the plant is in phase 5 and the potential transpiration is above 0.</span>

<span class="sd">    If the potential transpiration is not above 0, the delta potential yield is set to 0.</span>

<span class="sd">    For all other phases, the delta potential yield is unchanged.</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">    - j (int): an integer index, representing the current step of the simulation</span>

<span class="sd">    - data (xarray dataset): the simulation data, including the current state of the plant</span>

<span class="sd">    - paramVariete (dict): the variety-specific parameters used in the simulation</span>

<span class="sd">    Returns:</span>

<span class="sd">    - data (xarray dataset): the updated simulation data, including the updated delta potential yield</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ddj&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;SDJMatu1&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tr&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;trPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span><span class="w"></span>

<span class="w">                </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.15</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_root_biomass">update_root_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_root_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the root biomass (biomasseRacinaire) for a given time step.</p>
<p>The root biomass is computed as the difference between the total biomass 
and the aboveground biomass.</p>
<p>This function is based on the EvalBiomasseRacinaire procedure, of the
milbilancarbone, exmodules 1 &amp; 2, <strong><em>milbilancarbone</em></strong>.pas file from the
original Pascal code</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>Time step index.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>Input dataset containing relevant variables.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>Updated dataset with the root biomass variable.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_root_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the root biomass (biomasseRacinaire) for a given time step.</span>

<span class="sd">    The root biomass is computed as the difference between the total biomass</span>

<span class="sd">    and the aboveground biomass.</span>

<span class="sd">    This function is based on the EvalBiomasseRacinaire procedure, of the</span>

<span class="sd">    milbilancarbone, exmodules 1 &amp; 2, ***milbilancarbone***.pas file from the</span>

<span class="sd">    original Pascal code</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): Time step index.</span>

<span class="sd">        data (xarray.Dataset): Input dataset containing relevant variables.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: Updated dataset with the root biomass variable.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_stem_biomass">update_stem_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_stem_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p>For phase above 1 and if the delta of aerial biomass is negative,</p>
<p>meaning that the plant is losing aerial biomass, the stem biomass is
updated as the difference between the leaf biomass and the reallocation
minus the delta of aerial biomass multiplied by (1-reallocation rate in
leaves) (if it's not leaves, it's stems...). This value is bound in 0.00000001.</p>
<p>Otherwise, the stem biomass is not updated.</p>
<p>This function is adapted from the EvalFeuilleTigeSarrahV4 procedure, of
the bilancarbonsarra.pas and exmodules 1 &amp; 2.pas files from the original
Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_stem_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="k">For</span> <span class="nv">phase</span> <span class="nv">above</span> <span class="mi">1</span> <span class="nv">and</span> <span class="k">if</span> <span class="nv">the</span> <span class="nv">delta</span> <span class="nv">of</span> <span class="nv">aerial</span> <span class="nv">biomass</span> <span class="nv">is</span> <span class="nv">negative</span>,

    <span class="nv">meaning</span> <span class="nv">that</span> <span class="nv">the</span> <span class="nv">plant</span> <span class="nv">is</span> <span class="nv">losing</span> <span class="nv">aerial</span> <span class="nv">biomass</span>, <span class="nv">the</span> <span class="nv">stem</span> <span class="nv">biomass</span> <span class="nv">is</span>

    <span class="nv">updated</span> <span class="nv">as</span> <span class="nv">the</span> <span class="nv">difference</span> <span class="nv">between</span> <span class="nv">the</span> <span class="nv">leaf</span> <span class="nv">biomass</span> <span class="nv">and</span> <span class="nv">the</span> <span class="nv">reallocation</span>

    <span class="nv">minus</span> <span class="nv">the</span> <span class="nv">delta</span> <span class="nv">of</span> <span class="nv">aerial</span> <span class="nv">biomass</span> <span class="nv">multiplied</span> <span class="nv">by</span> <span class="ss">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">reallocation</span> <span class="nv">rate</span> <span class="nv">in</span>

    <span class="nv">leaves</span><span class="ss">)</span> <span class="ss">(</span><span class="k">if</span> <span class="nv">it</span><span class="s1">&#39;</span><span class="s">s not leaves, it</span><span class="s1">&#39;</span><span class="nv">s</span> <span class="nv">stems</span>...<span class="ss">)</span>. <span class="nv">This</span> <span class="nv">value</span> <span class="nv">is</span> <span class="nv">bound</span> <span class="nv">in</span> <span class="mi">0</span>.<span class="mi">00000001</span>.

    <span class="nv">Otherwise</span>, <span class="nv">the</span> <span class="nv">stem</span> <span class="nv">biomass</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">updated</span>.

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalFeuilleTigeSarrahV4</span> <span class="nv">procedure</span>, <span class="nv">of</span>

    <span class="nv">the</span> <span class="nv">bilancarbonsarra</span>.<span class="nv">pas</span> <span class="nv">and</span> <span class="nv">exmodules</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">2</span>.<span class="nv">pas</span> <span class="nv">files</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">original</span>

    <span class="nv">Pascal</span> <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    # <span class="nv">group</span> <span class="mi">122</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">numPhase</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&gt;</span> <span class="mi">1</span><span class="ss">)</span> <span class="o">&amp;</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">&lt;</span> <span class="mi">0</span><span class="ss">)</span>,

        <span class="nv">np</span>.<span class="nv">maximum</span><span class="ss">(</span>

            <span class="mi">0</span>.<span class="mi">00000001</span>,

            <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">reallocation</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">deltaBiomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span> <span class="o">*</span> <span class="ss">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">pcReallocFeuille</span><span class="s2">&quot;</span>]<span class="ss">)</span>,

            <span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_stem_biomass_all_phases">update_stem_biomass_all_phases</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_stem_biomass_all_phases</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p><em>summary</em></p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_stem_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span><span class="s">_summary_</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_aboveground_biomass_all_phases</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">reallocation</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">*</span> <span class="ss">(</span><span class="mi">1</span><span class="o">-</span> <span class="nv">paramVariete</span>[<span class="s2">&quot;</span><span class="s">pcReallocFeuille</span><span class="s2">&quot;</span>]<span class="ss">))</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_stem_biomass_positive_delta_aboveground_biomass">update_stem_biomass_positive_delta_aboveground_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_stem_biomass_positive_delta_aboveground_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span>
<span class="p">)</span>
</code></pre></div>

<p><em>summary</em></p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_stem_biomass_positive_delta_aboveground_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span><span class="s">_summary_</span>

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="nv">np</span>.<span class="nv">where</span><span class="ss">(</span>

        <span class="nv">condition_positive_delta_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span>, <span class="nv">paramVariete</span><span class="ss">)</span>,

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseAerienne</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">-</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">rdt</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

        <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:],

    <span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_total_biomass">update_total_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_total_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">paramVariete</span><span class="p">,</span>
    <span class="n">paramITK</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the Total Biomass of the Plant.</p>
<p>The total biomass is updated based on the plant's current phase and other parameters.
If the plant is in phase 2 and there's a change in phase, the total biomass is initialized using
crop density, grain yield per plant, and the dry weight of the grain.
If the plant is not in phase 2 or there's no change in phase, the total biomass is incremented with
the difference between the plant's assimilation and maintenance respiration.</p>
<p>When passing from phase 1 to phase 2, total biomass is initialized.
Initialization value is computed from crop density (plants/ha), txResGrain
(grain yield per plant), and poidsSecGrain. Otherwise, total biomass is
incremented with the difference between plant assimilation assim and
maintainance respiration respMaint.</p>
<p>This function is adapted from the EvolBiomTotSarrahV4 procedure, of the
bilancarbonsarra.pas file from the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The current time step.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The data for the plant, including variables like <br>"biomasseTotale", "assim", "respMaint", "numPhase", and "changePhase".</td>
<td>None</td>
</tr>
<tr>
<td>paramVariete</td>
<td>dict</td>
<td>A dictionary of parameters specific to the plant variety.</td>
<td>None</td>
</tr>
<tr>
<td>paramITK</td>
<td>dict</td>
<td>A dictionary of inter-tropical convergence zone parameters.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The updated data for the plant, including the updated "biomasseTotale"<br>and "deltaBiomasseTotale" variables.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_total_biomass</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">,</span><span class="w"> </span><span class="n">paramITK</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the Total Biomass of the Plant.</span>

<span class="sd">    The total biomass is updated based on the plant&#39;s current phase and other parameters.</span>

<span class="sd">    If the plant is in phase 2 and there&#39;s a change in phase, the total biomass is initialized using</span>

<span class="sd">    crop density, grain yield per plant, and the dry weight of the grain.</span>

<span class="sd">    If the plant is not in phase 2 or there&#39;s no change in phase, the total biomass is incremented with</span>

<span class="sd">    the difference between the plant&#39;s assimilation and maintenance respiration.</span>

<span class="sd">    When passing from phase 1 to phase 2, total biomass is initialized.</span>

<span class="sd">    Initialization value is computed from crop density (plants/ha), txResGrain</span>

<span class="sd">    (grain yield per plant), and poidsSecGrain. Otherwise, total biomass is</span>

<span class="sd">    incremented with the difference between plant assimilation assim and</span>

<span class="sd">    maintainance respiration respMaint.</span>

<span class="sd">    This function is adapted from the EvolBiomTotSarrahV4 procedure, of the</span>

<span class="sd">    bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (int): The current time step.</span>

<span class="sd">        data (xarray.Dataset): The data for the plant, including variables like</span>

<span class="sd">            &quot;biomasseTotale&quot;, &quot;assim&quot;, &quot;respMaint&quot;, &quot;numPhase&quot;, and &quot;changePhase&quot;.</span>

<span class="sd">        paramVariete (dict): A dictionary of parameters specific to the plant variety.</span>

<span class="sd">        paramITK (dict): A dictionary of inter-tropical convergence zone parameters.</span>

<span class="sd">    Returns:</span>

<span class="sd">        xarray.Dataset: The updated data for the plant, including the updated &quot;biomasseTotale&quot;</span>

<span class="sd">            and &quot;deltaBiomasseTotale&quot; variables.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">paramITK</span><span class="p">[</span><span class="s2">&quot;densite&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">paramVariete</span><span class="p">[</span><span class="s1">&#39;densOpti&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">paramITK</span><span class="p">[</span><span class="s1">&#39;densite&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;txResGrain&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="n">paramVariete</span><span class="p">[</span><span class="s2">&quot;poidsSecGrain&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]),</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># we may want to drop this variable and use the raw computation instead</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;assim&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;respMaint&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:])</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_total_biomass_at_flowering_stage">update_total_biomass_at_flowering_stage</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_total_biomass_at_flowering_stage</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>This function updates the total biomass of the plant at the end of the</p>
<p>flowering stage (biomTotStadeFloraison).</p>
<p>If the plant is in phase 5, and the phase has changed, then the total
biomass is copied to the biomTotStadeFloraison variable.</p>
<p>This function is adapted from the EvalRdtPotRespSarV42 procedure, of
the bilancarbonsarra.pas file from the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_total_biomass_at_flowering_stage</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function updates the total biomass of the plant at the end of the</span>

<span class="sd">    flowering stage (biomTotStadeFloraison).</span>

<span class="sd">    If the plant is in phase 5, and the phase has changed, then the total</span>

<span class="sd">    biomass is copied to the biomTotStadeFloraison variable.</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">        j (_type_): _description_</span>

<span class="sd">        data (_type_): _description_</span>

<span class="sd">    Returns:</span>

<span class="sd">        _type_: _description_</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_total_biomass_stade_ip">update_total_biomass_stade_ip</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_total_biomass_stade_ip</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the total biomass of the plant at the end of the vegetative phase (ip = "initiation paniculaire").</p>
<p>If the plant has reached phase 4 and has just changed phase, the current 
total biomass will be copied to the "biomTotStadeIp" variable, which represents 
the total biomass at the end of the vegetative phase (initiation paniculaire).</p>
<p>This function is adapted from the EvalRdtPotRespSarV42 procedure, of
the bilancarbonsarra.pas file from the original Pascal code.</p>
<p>Args:
j (int): Timestep index.
data (xarray.Dataset): Input dataset.</p>
<p>Returns:
xarray.Dataset: The updated dataset with the "biomTotStadeIp" variable updated.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_total_biomass_stade_ip</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">):</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Update the total biomass of the plant at the end of the vegetative phase (ip = &quot;initiation paniculaire&quot;).</span>

<span class="sd">    If the plant has reached phase 4 and has just changed phase, the current</span>

<span class="sd">    total biomass will be copied to the &quot;biomTotStadeIp&quot; variable, which represents</span>

<span class="sd">    the total biomass at the end of the vegetative phase (initiation paniculaire).</span>

<span class="sd">    This function is adapted from the EvalRdtPotRespSarV42 procedure, of</span>

<span class="sd">    the bilancarbonsarra.pas file from the original Pascal code.</span>

<span class="sd">    Args:</span>

<span class="sd">    j (int): Timestep index.</span>

<span class="sd">    data (xarray.Dataset): Input dataset.</span>

<span class="sd">    Returns:</span>

<span class="sd">    xarray.Dataset: The updated dataset with the &quot;biomTotStadeIp&quot; variable updated.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">:,:,:]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;numPhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;changePhase&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">,:,:],</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="update_vegetative_biomass">update_vegetative_biomass</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_vegetative_biomass</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p><em>summary</em></p>
<p>This function is adapted from the EvalBiomasseVegetati procedure from the copie milbilancarbon, exmodules 1 &amp; 2, <strong><em>milbilancarbone</em></strong> file
of the original Pascal code.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td><em>type</em></td>
<td><em>description</em></td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em></td>
<td><em>description</em></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">update_vegetative_biomass</span><span class="ss">(</span><span class="nv">j</span>, <span class="nv">data</span><span class="ss">)</span>:

    <span class="s2">&quot;&quot;&quot;</span><span class="s">_summary_</span>

    <span class="nv">This</span> <span class="nv">function</span> <span class="nv">is</span> <span class="nv">adapted</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">EvalBiomasseVegetati</span> <span class="nv">procedure</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">copie</span> <span class="nv">milbilancarbon</span>, <span class="nv">exmodules</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">2</span>, <span class="o">***</span><span class="nv">milbilancarbone</span><span class="o">***</span> <span class="nv">file</span>

    <span class="nv">of</span> <span class="nv">the</span> <span class="nv">original</span> <span class="nv">Pascal</span> <span class="nv">code</span>.

    <span class="nv">Args</span>:

        <span class="nv">j</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

        <span class="nv">data</span> <span class="ss">(</span><span class="nv">_type_</span><span class="ss">)</span>: <span class="nv">_description_</span>

    <span class="nv">Returns</span>:

        <span class="nv">_type_</span>: <span class="nv">_description_</span>

    <span class="s2">&quot;&quot;&quot;</span>

    <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseVegetative</span><span class="s2">&quot;</span>][<span class="nv">j</span>:,:,:] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseTige</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:] <span class="o">+</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">biomasseFeuille</span><span class="s2">&quot;</span>][<span class="nv">j</span>,:,:]<span class="ss">)</span>

    <span class="k">return</span> <span class="nv">data</span>
</code></pre></div>

</details>
<h3 id="update_yield_during_filling_phase">update_yield_during_filling_phase</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_yield_during_filling_phase</span><span class="p">(</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>This function updates the yield value during the filling phase.</p>
<p>During the filling phase (numPhase == 5), the yield is updated by
incrementing it with the sum of <code>deltaBiomasseAerienne</code> and <code>reallocation</code>,
bounded by 0 and <code>dRdtPot</code> (daily potential yield). The construction of yield
is done during phase 5 only, from the variation of aerial biomass and
reallocation, with a maximum of <code>dRdtPot</code>.</p>
<p>This function is adapted from the EvolDayRdtSarraV3 procedure from the
<strong><em>bilancarbonesarra</em></strong>, exmodules 1 &amp; 2.pas file of the original Pascal
code.</p>
<p>Notes :
On tend vers le potentiel en fn du rapport des degresJours/sumDegresJours
pour la phase de remplissage. Frein sup fn du flux de sève estimé par le
rapport Tr/TrPot.
dRdtPot = RdtPotDuJour</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>j</td>
<td>int</td>
<td>The time step at which the calculation starts.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>xarray.Dataset</td>
<td>The data that contains all variables.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>xarray.Dataset</td>
<td>The input data with updated yield values.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">update_yield_during_filling_phase</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    This function updates the yield value during the filling phase.</span>

<span class="s2">    During the filling phase (numPhase == 5), the yield is updated by</span>

<span class="s2">    incrementing it with the sum of `deltaBiomasseAerienne` and `reallocation`,</span>

<span class="s2">    bounded by 0 and `dRdtPot` (daily potential yield). The construction of yield</span>

<span class="s2">    is done during phase 5 only, from the variation of aerial biomass and</span>

<span class="s2">    reallocation, with a maximum of `dRdtPot`.</span>

<span class="s2">    This function is adapted from the EvolDayRdtSarraV3 procedure from the</span>

<span class="s2">    ***bilancarbonesarra***, exmodules 1 &amp; 2.pas file of the original Pascal</span>

<span class="s2">    code.</span>

<span class="s2">    Notes :</span>

<span class="s2">    On tend vers le potentiel en fn du rapport des degresJours/sumDegresJours</span>

<span class="s2">    pour la phase de remplissage. Frein sup fn du flux de sève estimé par le</span>

<span class="s2">    rapport Tr/TrPot.</span>

<span class="s2">    dRdtPot = RdtPotDuJour</span>

<span class="s2">    Args:</span>

<span class="s2">        j (int): The time step at which the calculation starts.</span>

<span class="s2">        data (xarray.Dataset): The data that contains all variables.</span>

<span class="s2">    Returns:</span>

<span class="s2">        xarray.Dataset: The input data with updated yield values.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdt&quot;</span><span class="err">][</span><span class="n">j</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;numPhase&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdt&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">minimum</span><span class="p">(</span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;dRdtPot&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w">  </span><span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">data</span><span class="err">[</span><span class="s1">&#39;reallocation&#39;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="k">data</span><span class="err">[</span><span class="s2">&quot;rdt&quot;</span><span class="err">][</span><span class="n">j</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="err">]</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="variable_dict">variable_dict</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">variable_dict</span><span class="p">(</span>

<span class="p">)</span>
</code></pre></div>

<p>Retrieve the dictionary of variables in the dataset with their respective units.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dict</td>
<td>A dictionary containing the variables and their units, where the keys are the variable names and the values are the respective units.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">variable_dict</span><span class="p">():</span><span class="w"></span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Retrieve the dictionary of variables in the dataset with their respective units.</span>

<span class="sd">    Returns:</span>

<span class="sd">        dict: A dictionary containing the variables and their units, where the keys are the variable names and the values are the respective units.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1"># climate</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;ddj&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;daily thermal time&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;°C.j&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;sdj&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sum of thermal time since beginning of emergence&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;°C.j&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># phenology</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;changePhase&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;indicator of phase transition day&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;binary&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;numPhase&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;number of phenological stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;arbitrary units&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;initPhase&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;indicator of performed phase transition&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;binary&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;phasePhotoper&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;photoperiodic phase indicator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;binary&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;seuilTempPhaseSuivante&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the next phenological phase&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;°C.j&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;sommeDegresJourPhasePrec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the previous phenological phase&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;°C.j&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;seuilTempPhasePrec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sum of thermal time needed to reach the previous phenological phase&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;°C.j&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># carbon balance</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;assim&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;plant biomass assimilation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;assimPot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;plant potential biomass assimilation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;bM&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;net growth rate of living biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/(m².d)&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;cM&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;net growth rate of dead biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/(m².d)&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;rdt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;grain yield&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;rdtPot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;potential grain yield&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;reallocation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;amount of assimilates reallocated to the yield (supply &lt; demand)&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;respMaint&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;amount of assimilates consumed by maintainance respiration&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;manqueAssim&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;deficit in assimilates (demand - supply)&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># biomass</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomTotStadeFloraison&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total biomass of the plant at the end of the flowering stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomTotStadeIp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total biomass at the panicle initiation stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;deltaBiomasseAerienne&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;increment of aerial biomass in one day&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;deltaBiomasseFeuilles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;increment of leaf biomass in one day&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseAerienne&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total aerial biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseVegetative&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total vegetative biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseTotale&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseTige&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total stem biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseRacinaire&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total root biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;biomasseFeuille&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total leaf biomass&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/ha&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;deltaBiomasseTotale&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;increment of total biomass in one day&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kg/(ha.d)&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># evapotranspiration</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;kce&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fraction of kc attributable to soil evaporation&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;kcp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fraction of kc attributable to plant transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;kcTot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total crop coefficient&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;tr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;actual crop transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;trPot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;potential crop transpiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;trSurf&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># water balance</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;consoRur&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;consumption of water stored in the root system&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;water_gathered_by_mulch&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;water captured by the mulch in one day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;eauDispo&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;available water, sum of rainfall and total irrigation for the day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;eauTranspi&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;water available for transpiration from the surface reservoir&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;correctedIrrigation&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;corrected irrigation amount&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;cstr&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;drought stress coefficient&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;arbitrary unit&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;dayVrac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;modulated daily root growth&quot;</span><span class="p">,</span><span class="s2">&quot;mm/day&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;delta_root_tank_capacity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;change in root system water reserve&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;dr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;drainage&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;etm&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;evapotranspiration from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;etp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;potential evapotranspiration from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;etr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;reference evapotranspiration&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;evap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;evaporation from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;evapPot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;potential evaporation from the soil moisture&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;FEMcW&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;water fraction in soil volume explored by the root system&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;fesw&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fraction of available surface water&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;irrigTotDay&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total irrigation for the day&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;vRac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;reference daily root growth&quot;</span><span class="p">,</span><span class="s2">&quot;mm/day&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;ftsw&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fraction of transpirable surface water&quot;</span><span class="p">,</span><span class="s2">&quot;decimal percentage&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;lr&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;daily water runoff&quot;</span><span class="p">,</span><span class="s2">&quot;mm/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;pFact&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;FAO reference for critical FTSW value for transpiration response&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># water tanks</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;irrigation_tank_stock&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;current stock of water in the irrigation tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stockIrr to irrigation_tank_stock</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;mulch_water_stock&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;water stored in crop residues (mulch)&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stockMc to mulch_water_stock</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;root_tank_stock&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;current stock of water in the root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stRu to root_tank_stock</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;total_tank_capacity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;total capacity of the root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stRuMax to total_tank_capacity</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stRur&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1"># [&quot;previous season&#39;s root system tank stock&quot;,&quot;mm&quot;],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;root_tank_capacity_previous_season&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;previous season&#39;s root system tank capacity&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stRurMaxPrec to root_tank_capacity_previous_season</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stRurPrec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;previous day&#39;s root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stRurSurf&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;surface root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;surface_tank_stock&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;current stock of water in the surface root system tank&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stRuSurf to surface_tank_stock</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stRuSurfPrec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;previous day&#39;s surface root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;delta_total_tank_stock&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;change in the total root system tank stock&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming stRuVar to delta_total_tank_stock</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;irrigation_tank_capacity&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;irrigation tank capacity&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">#! renaming ruIrr to irrigation_tank_capacity</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;ruRac&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Water column that can potentially be strored in soil volume explored by root system&quot;</span><span class="p">,</span><span class="s2">&quot;mm&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;conv&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;KAssim&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;dayBiomLeaf&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;daily growth of leaf biomass&quot;</span><span class="p">,</span><span class="s2">&quot;kg/ha/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;dRdtPot&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;daily potential demand from yield&quot;</span><span class="p">,</span><span class="s2">&quot;kg/ha/d&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;FeuilleUp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;kRespMaint&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;LitFeuille&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;nbJourCompte&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;nbjStress&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;NbUBT&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;sla&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;stockRac&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;sumPP&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;TigeUp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;UBTCulture&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;lai&quot;</span><span class="p">:[</span><span class="s2">&quot;leaf area index&quot;</span><span class="p">,</span><span class="s2">&quot;m2/m2&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">        </span><span class="c1"># experimental</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;Ncrit&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">variables</span><span class="w"></span>
</code></pre></div>

</details>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../../docs/tutorial/00_-_Running_a_simulation/" class="btn btn-neutral float-left" title="00 - Running a simulation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../bilan_hydro/" class="btn btn-neutral float-right" title="Bilan Hydro">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../../docs/tutorial/00_-_Running_a_simulation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../bilan_hydro/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
